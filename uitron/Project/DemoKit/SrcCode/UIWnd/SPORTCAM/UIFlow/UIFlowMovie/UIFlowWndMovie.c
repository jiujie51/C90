//This source code is generated by UI Designer Studio.

#include "UIFramework.h"
#include "UIFrameworkExt.h"
#include "NVTToolCommand.h"
#include "UIFlowWndMovieRes.c"
#include "UIFlow.h"
#include "Audio.h"
#include "FileSysTsk.h"
#include "UIAppPlay.h"
//#include "ImageApp_Movie.h"
#include "ImageApp_MovieMulti.h"
#include "ImageApp_Photo.h" //for NVTEVT_CALLBACK, NVTEVT_CB_ZOOM, NVTEVT_ALGMSG_PREVIEW_STABLE
#if (CALIBRATION_FUNC == ENABLE)
#include "EngineerMode.h"
#include "calibration_item.h"
#endif
#include "DxOutput.h"
#include    "stdio.h"
#include    "GPS.h"
#if (LOGFILE_FUNC==ENABLE)
#include "LogFile.h"
extern BOOL bSysLogfile;
#endif
#if USE_FILEDB
#include "FileDB.h"
#include "NameRule_FileDB.h"
#endif
#include "UIFlow.h"
#if !defined(_GSensor_None_)
#include "GSensor.h"
#endif
#include "display.h"

#if (LOG_DBGINFO_IN_GPS_SECTION == ENABLE)
#include "mp4log.h"
#endif  // #if (LOG_DBGINFO_IN_GPS_SECTION == ENABLE)
#include "alg_UIFlowWndMovie.h"
#include "alg_MovieExe.h"
#include "media_def.h"
#include "MovieInterface.h"
#include "UIAppPhoto.h"
#if( defined(_NVT_ETHREARCAM_RX_))
#include "EthCamAppSocket.h"
#include "EthCamAppNetwork.h"
#endif
#include "UIModePlayMenu.h"
#if( defined(_NVT_ETHREARCAM_TX_) && AV_LCA_FUNC == ENABLE)
#include "av_lca_lib.h"
#endif
#include "anfa_adas_lib.h"
#include "WavPlay.h"
#include "EthCamCmdParser.h"
#define __MODULE__          UIFlowWndMovie
//#define __DBGLVL__ 0        //OFF mode, show nothing
#define __DBGLVL__ 1        //ERROR mode, show err, wrn only
//#define __DBGLVL__ 2        //TRACE mode, show err, wrn, ind, msg and func and ind, msg and func can be filtering by __DBGFLT__ settings
#define __DBGFLT__ "*"      // *=All
#include "DebugModule.h"
//#NT#2016/09/29#KCHong -begin
//#NT#The GPS related variables should not depend on ADAS.
#if (GPS_FUNCTION == ENABLE)
extern FLOAT g_CurSpeed;
extern BOOL g_GPSLinked;
extern BOOL g_GPSStatus;
#endif
//#NT#2016/09/29#KCHong -end

//#NT#2016/09/20#Bob Huang -begin
//#NT#Support HDMI Display with 3DNR Out
#if (_3DNROUT_FUNC == ENABLE)
extern BOOL     gb3DNROut;
#endif
//#NT#2016/09/20#Bob Huang -end

//#MT#lyb -20200331 -begin
static BOOL bLCA_Alarm_L = FALSE;
static BOOL bLCA_Alarm_M = FALSE;			//zjf
static BOOL bLCA_Alarm_R = FALSE;
static UINT8 uiLCA_Alarm_level_Left = 0;
static UINT8 uiLCA_Alarm_level_Mid = 0;		//zjf
static UINT8 uiLCA_Alarm_level_Right = 0;

static BOOL bChangeModeAutoRec = FALSE;
//#MT#lyb -20200331 -end
UINT32 FocusUrgCount =0;
BOOL  bFocusUrg = FALSE;
//---------------------UIFlowWndMovieCtrl Control List---------------------------
CTRL_LIST_BEGIN(UIFlowWndMovie)
//CTRL_LIST_ITEM(UIFlowWndMovie_ADAS_Alert_Display)
CTRL_LIST_ITEM(UIFlowWndMovie_BackLightLvl_Panel)
CTRL_LIST_ITEM(UIFlowWndMovie_Panel_TopNormal)
CTRL_LIST_ITEM(UIFlowWndMovie_Panel_RecUrg)
CTRL_LIST_ITEM(UIFlowWndMovie_Status_REC)
CTRL_LIST_ITEM(UIFlowWndMovie_Panel_Datetime)
CTRL_LIST_ITEM(UIFlowWndMovie_Panel_Operate)
CTRL_LIST_ITEM(UIFlowWndMovie_Panel_EMRBar)
CTRL_LIST_ITEM(UIFlowWndMovie_Static_ENRTime)
CTRL_LIST_ITEM(UIFlowWndMovie_ConfirmPanel)
CTRL_LIST_ITEM(UIFlowWndMovie_Status_Alarm_L)
CTRL_LIST_ITEM(UIFlowWndMovie_Status_Alarm_R)
CTRL_LIST_ITEM(UIFlowWndMovie_Panel_Behind)
CTRL_LIST_ITEM(UIFlowWndMovie_LCDStatic)
CTRL_LIST_END

//----------------------UIFlowWndMovieCtrl Event---------------------------
INT32 UIFlowWndMovie_OnOpen(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnClose(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnUpdateInfo(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnKeyNext(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnKeySelect(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnKeyMenu(VControl *, UINT32, UINT32 *);
//INT32 UIFlowWndMovie_OnKeyEnter(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnKeyDown(VControl *, UINT32, UINT32 *);
//INT32 UIFlowWndMovie_OnKeyRight(VControl *, UINT32, UINT32 *);
//INT32 UIFlowWndMovie_OnKeyLeft(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnChildClose(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnKeyShutter2(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnKeyZoomin(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnKeyZoomout(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnKeyUp(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnKeyPlayBack(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnBattery(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnBatteryLow(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnKeyMode(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnMovieFinish(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnMovieOneSec(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnMovieFull(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnMovieWrError(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnStorageSlow(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray);
INT32 UIFlowWndMovie_OnLoopRecFull(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnEMRCompleted(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnPreviewStable(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnOZoomStepChange(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnDZoomStepChange(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnStorageInit(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnStorageChange(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnTimer(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnACPlug(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnACUnplug(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnCustom1(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnADASShowAlarm(VControl *, UINT32, UINT32 *);        //#NT#2016/03/25#New ADAS#KCHong
//#NT#2016/06/23#Niven Cho -begin
//#NT#Enter calibration by cgi event or command event
INT32 UIFlowWndMovie_OnKeyCalibration(VControl *, UINT32, UINT32 *);
//#NT#2016/06/23#Niven Cho -end
//#NT#2016/07/20#Brain Yen -begin
//#NT#Add for DDD alarm
INT32 UIFlowWndMovie_OnDDDShowAlarm(VControl *, UINT32, UINT32 *);
//#NT#2016/07/20#Brain Yen -end
INT32 UIFlowWndMovie_OnOverTime(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnBackgroundDone(VControl *, UINT32, UINT32 *);

INT32 UIFlowWndMovie_OnTouchSlideLeft(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnTouchSlideRight(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnTouchSlideUp(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnTouchSlideDown(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnTouchDoubleClick(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnTouchMove(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnTouchRelease(VControl *, UINT32, UINT32 *);

INT32 UIFlowWndMovie_OnLCA_Alarm(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_OnTouchPanelClick(VControl *, UINT32, UINT32 *);
#if (Movie_Redraw_Event == ENABLE)
INT32 UIFlowWndMovie_Panel_TSR_OnRedraw(VControl *, UINT32, UINT32 *);
#endif


EVENT_BEGIN(UIFlowWndMovie)
EVENT_ITEM(NVTEVT_OPEN_WINDOW, UIFlowWndMovie_OnOpen)
EVENT_ITEM(NVTEVT_CLOSE_WINDOW, UIFlowWndMovie_OnClose)
EVENT_ITEM(NVTEVT_UPDATE_INFO, UIFlowWndMovie_OnUpdateInfo)
#if defined(_KEY_METHOD_4KEY_)
EVENT_ITEM(NVTEVT_KEY_NEXT, UIFlowWndMovie_OnKeyDown)    // Down Key
EVENT_ITEM(NVTEVT_KEY_SELECT, UIFlowWndMovie_OnKeyNext)    // OK Key
EVENT_ITEM(NVTEVT_KEY_SHUTTER2, UIFlowWndMovie_OnKeySelect)   // REC key
#else
EVENT_ITEM(NVTEVT_KEY_NEXT, UIFlowWndMovie_OnKeyNext)       // Right Key
EVENT_ITEM(NVTEVT_KEY_SELECT, UIFlowWndMovie_OnKeySelect)   // Enter key
#endif
EVENT_ITEM(NVTEVT_KEY_MENU, UIFlowWndMovie_OnKeyMenu)
//EVENT_ITEM(NVTEVT_KEY_ENTER,UIFlowWndMovie_OnKeyEnter)
EVENT_ITEM(NVTEVT_KEY_DOWN, UIFlowWndMovie_OnKeyDown)
//EVENT_ITEM(NVTEVT_KEY_LEFT,UIFlowWndMovie_OnKeyLeft)
//EVENT_ITEM(NVTEVT_KEY_RIGHT,UIFlowWndMovie_OnKeyRight)
EVENT_ITEM(NVTEVT_CHILD_CLOSE, UIFlowWndMovie_OnChildClose)
EVENT_ITEM(NVTEVT_KEY_SHUTTER2, UIFlowWndMovie_OnKeyShutter2)
EVENT_ITEM(NVTEVT_KEY_ZOOMIN, UIFlowWndMovie_OnKeyZoomin)
EVENT_ITEM(NVTEVT_KEY_ZOOMOUT, UIFlowWndMovie_OnKeyZoomout)
EVENT_ITEM(NVTEVT_KEY_UP, UIFlowWndMovie_OnKeyUp)
EVENT_ITEM(NVTEVT_KEY_PLAYBACK, UIFlowWndMovie_OnKeyPlayBack)
EVENT_ITEM(NVTEVT_BATTERY, UIFlowWndMovie_OnBattery)
EVENT_ITEM(NVTEVT_BATTERY_LOW, UIFlowWndMovie_OnBatteryLow)
EVENT_ITEM(NVTEVT_KEY_MODE, UIFlowWndMovie_OnKeyMode)
EVENT_ITEM(NVTEVT_CB_MOVIE_REC_FINISH, UIFlowWndMovie_OnMovieFinish)
EVENT_ITEM(NVTEVT_CB_MOVIE_REC_ONE_SEC, UIFlowWndMovie_OnMovieOneSec)
EVENT_ITEM(NVTEVT_CB_MOVIE_OVERTIME, UIFlowWndMovie_OnOverTime) //file in BsMuxer not biggrer than 30mins, so callback BSMUXER_CBEVENT_OVERTIME to project, for re-rec
EVENT_ITEM(NVTEVT_CB_MOVIE_FULL, UIFlowWndMovie_OnMovieFull)
EVENT_ITEM(NVTEVT_CB_MOVIE_WR_ERROR, UIFlowWndMovie_OnMovieWrError)
EVENT_ITEM(NVTEVT_CB_MOVIE_SLOW, UIFlowWndMovie_OnStorageSlow)
EVENT_ITEM(NVTEVT_CB_MOVIE_LOOPREC_FULL, UIFlowWndMovie_OnLoopRecFull)
EVENT_ITEM(NVTEVT_CB_EMR_COMPLETED, UIFlowWndMovie_OnEMRCompleted)
//EVENT_ITEM(IPL_CBMSG_PREVIEWSTABLE,UIFlowWndMovie_OnPreviewStable)
EVENT_ITEM(NVTEVT_CALLBACK, UIFlowWndMovie_OnPreviewStable)
EVENT_ITEM(NVTEVT_CB_OZOOMSTEPCHG, UIFlowWndMovie_OnOZoomStepChange)
EVENT_ITEM(NVTEVT_CB_ZOOM, UIFlowWndMovie_OnDZoomStepChange)
EVENT_ITEM(NVTEVT_STORAGE_INIT, UIFlowWndMovie_OnStorageInit)
EVENT_ITEM(NVTEVT_STORAGE_CHANGE, UIFlowWndMovie_OnStorageChange)
EVENT_ITEM(NVTEVT_TIMER, UIFlowWndMovie_OnTimer)
EVENT_ITEM(NVTEVT_AC_Plug, UIFlowWndMovie_OnACPlug)
EVENT_ITEM(NVTEVT_AC_UnPlug, UIFlowWndMovie_OnACUnplug)
EVENT_ITEM(NVTEVT_KEY_CUSTOM1, UIFlowWndMovie_OnCustom1)
EVENT_ITEM(NVTEVT_CB_ADAS_SHOWALARM, UIFlowWndMovie_OnADASShowAlarm)      //#NT#2016/03/25#New ADAS#KCHong
//#NT#2016/06/23#Niven Cho -begin
//#NT#Enter calibration by cgi event or command event
EVENT_ITEM(NVTEVT_KEY_CALIBRATION, UIFlowWndMovie_OnKeyCalibration)
//#NT#2016/06/23#Niven Cho -end
//#NT#2016/07/20#Brain Yen -begin
//#NT#Add for DDD alarm
EVENT_ITEM(NVTEVT_CB_DDD_SHOWALARM, UIFlowWndMovie_OnDDDShowAlarm)
//#NT#2016/07/20#Brain Yen -end
EVENT_ITEM(NVTEVT_BACKGROUND_DONE, UIFlowWndMovie_OnBackgroundDone)
EVENT_ITEM(NVTEVT_USER_SLIDE_LEFT, UIFlowWndMovie_OnTouchSlideLeft)
EVENT_ITEM(NVTEVT_USER_SLIDE_RIGHT, UIFlowWndMovie_OnTouchSlideRight)
EVENT_ITEM(NVTEVT_USER_SLIDE_UP, UIFlowWndMovie_OnTouchSlideUp)
EVENT_ITEM(NVTEVT_USER_SLIDE_DOWN, UIFlowWndMovie_OnTouchSlideDown)
//EVENT_ITEM(NVTEVT_USER_DOUBLECLICK, UIFlowWndMovie_OnTouchDoubleClick)
//EVENT_ITEM(NVTEVT_USER_MOVE , UIFlowWndMovie_OnTouchMove) // NVTEVT_USER_MOVE
EVENT_ITEM(NVTEVT_USER_RELEASE, UIFlowWndMovie_OnTouchRelease)
EVENT_ITEM(NVTEVT_CLICK, UIFlowWndMovie_OnTouchPanelClick)
//#MT#lyb -20200331 -begin
EVENT_ITEM(NVTEVT_USER_LCA_RESULT, UIFlowWndMovie_OnLCA_Alarm)
#if (Movie_Redraw_Event == ENABLE)
EVENT_ITEM(NVTEVT_REDRAW,UIFlowWndMovie_Panel_TSR_OnRedraw)
#endif
//#MT#lyb -20200331 -end
EVENT_END

// Movie mode key mask
#define MOVIE_KEY_PRESS_MASK        (FLGKEY_SHUTTER2|FLGKEY_RIGHT|FLGKEY_LEFT|FLGKEY_CUSTOM1|FLGKEY_UP|FLGKEY_DOWN)
#define MOVIE_KEY_RELEASE_MASK      (FLGKEY_SHUTTER2|FLGKEY_RIGHT|FLGKEY_LEFT|FLGKEY_CUSTOM1|FLGKEY_UP|FLGKEY_DOWN)
//-----------------------------------------------------------------------------------------
static BOOL    g_uiRecordIngMotionDet = TRUE;
#if (_ADAS_FUNC_ == ENABLE)
UINT32 g_uiAdasAlertSecCnt = 0;
#endif  // #if (_ADAS_FUNC_ == ENABLE)
static UINT32  gUIMotionDetTimerID = NULL_TIMER;
static UINT32  g_uiDateTimerID = NULL_TIMER;
static UINT32  g_UIStopRecTimerID = NULL_TIMER;

//#MT#lyb -20200331 -begin
static UINT32  g_UILCAAlarmTimerID = NULL_TIMER;
#define TIMER_LCA_SEC               200
//#MT#lyb -20200331 -end

static UINT32  g_uiMaskKeyPress      = MOVIE_KEY_PRESS_MASK;
static UINT32  g_uiMaskKeyRelease    = MOVIE_KEY_RELEASE_MASK;
//static UINT32 g_uiMaskKeyContinue   = MOVIE_KEY_CONTINUE_MASK;
static volatile BOOL g_bRedLEDOn = FALSE;
static volatile BOOL g_ACPlug = FALSE;
static volatile BOOL g_PreviewStable = FALSE;
static volatile BOOL g_PreviewStable_Record = FALSE;
BOOL g_bSpeLockFun = FALSE;
_ALIGNED(4)  GPSDATA gpsdata = {0};

static UINT32 g_uiRecStopTimerCnt     = 0;
//static INT32 g_iBriAdjBarShowTime = -1;
#define LCD_BRI_LVL_DISP_TIME  10

BOOL isEnterParkingMode =FALSE;
BOOL  FocusOperate = FALSE;
UINT32 FocusOperateCount = 0;
UINT8 EthDisconRebootcnt = 0;

extern  BOOL  PlayMenu_Close;
static BOOL isStopREC = FALSE;
extern BOOL  Restart_Rec;
extern void MovieExe_EthCamSetISECrop(UINT32 rec_id);
extern void FlowMovie_IconHideBackLightLvl_Panel(void);
extern void FlowMovie_IconHideBehindProgressBar(void);
extern void FlowMovie_UpdateIcons(BOOL bShow);
extern void System_UpdateTx(void);
extern BOOL bGetTxFirmware;
//void UIFlowWndMovie_SetBriAdjBarShowTime(INT32 value)
//{
//   g_iBriAdjBarShowTime = value;
//}
/*
void UIFlowWndMovie_DecBriAdjBarShowTime(void)
{
   if(g_iBriAdjBarShowTime >= 0)
   {
      g_iBriAdjBarShowTime --;
	  if(g_iBriAdjBarShowTime == -1)
	  {
	    FlowMovie_DrawBrightnessBar(FALSE);
		UI_CancelTouchEventMask(NVTEVT_USER_SLIDE_LEFT);
		UI_CancelTouchEventMask(NVTEVT_USER_SLIDE_RIGHT);
		UI_CancelTouchEventMask(NVTEVT_USER_SLIDE_UP);
		UI_CancelTouchEventMask(NVTEVT_USER_SLIDE_DOWN);
	  }
   }
}
*/
INT32 CurStepPosBehind = 50;
BOOL bFoucusBehindPanel = FALSE;
UINT32 FoucusBhindPanelCount = 0;
static void DrawBehindBar(void)
{
	bFoucusBehindPanel  = TRUE;
	FoucusBhindPanelCount = 0;
	UxCtrl_SetShow(&UIFlowWndMovie_Panel_BehindCtrl, TRUE);
	UxCtrl_SetShow(&UIFlowWndMovie_BTN_BehindUPCtrl, TRUE);
//	UxCtrl_SetShow(&UIFlowWndMovie_BehindProgressBarCtrl, TRUE);
	UxCtrl_SetShow(&UIFlowWndMovie_BTN_BehindDownCtrl, TRUE);
}
static void HideBehindBar(void)
{
	bFoucusBehindPanel = FALSE;
	FoucusBhindPanelCount = 0;
	UxCtrl_SetShow(&UIFlowWndMovie_Panel_BehindCtrl, FALSE);
	UxCtrl_SetShow(&UIFlowWndMovie_BTN_BehindUPCtrl, FALSE);
	UxCtrl_SetShow(&UIFlowWndMovie_BehindProgressBarCtrl, FALSE);
	UxCtrl_SetShow(&UIFlowWndMovie_BTN_BehindDownCtrl, FALSE);

}

void CloseTimer(void)
{
	if (gUIMotionDetTimerID != NULL_TIMER) {
		GxTimer_StopTimer(&gUIMotionDetTimerID);
	}

	if (g_uiDateTimerID != NULL_TIMER) {
		GxTimer_StopTimer(&g_uiDateTimerID);
	}

	if (g_UIStopRecTimerID != NULL_TIMER) {
		GxTimer_StopTimer(&g_UIStopRecTimerID);
	}

	if (g_UILCAAlarmTimerID != NULL_TIMER) {
		GxTimer_StopTimer(&g_UILCAAlarmTimerID);
	}

}



BOOL  g_bRecordLock = FALSE;
 UINT32	g_EmergencyRecSetp = 0;
 UINT32   g_EmergencyRecTime = 0;
 UINT32   g_EmergencyRecSetpTotail = 0;
void UIFlowWndMovie_SetRecLockStatus(BOOL bSet)
{
    g_bRecordLock = bSet;
}
BOOL UIFlowWndMovie_GetRecLockStatus(void)
{
    return g_bRecordLock;
}

#if (USE_FILEDB==DISABLE)
static void UIFlowWndMovie_DeleteEmptyFolder(void)
{
	SDCFDIRINFO dirinfo;
	char   path[DCF_FULL_FILE_PATH_LEN];
	UINT32 uiMaxFolderID, uiPrevMaxFolderID;
	UINT32 uiStrlen;
	BOOL ret;


	uiMaxFolderID = DCF_GetDBInfo(DCF_INFO_MAX_DIR_ID);
// check if folder has file
	ret = DCF_GetDirInfo(uiMaxFolderID, &dirinfo);
	if (ret) {
		while (dirinfo.uiNumOfDcfObj == 0) {
			DCF_GetDirPath(uiMaxFolderID, path);
			uiStrlen = strlen(path);
			path[uiStrlen - 1] = '\0';
			if (FileSys_DeleteDir(path) != FST_STA_OK) {
				debug_msg("FileSys_DeleteDir failed\r\n");
			}

			DCF_Refresh();

			uiPrevMaxFolderID = uiMaxFolderID;
			// search another Max Empty folder ID
			uiMaxFolderID = DCF_GetDBInfo(DCF_INFO_MAX_DIR_ID);

			// break if getting max folder id is always same
			if (uiPrevMaxFolderID == uiMaxFolderID) {
				break;
			}
			// check if folder has file
			ret = DCF_GetDirInfo(uiMaxFolderID, &dirinfo);

			if (ret == FALSE) {
				break;
			}
		}
	}
}
#endif

static INT32 UIFlowWndMovie_OnExeRecord(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{	
	UINT32 uiKeyAct;
	UINT32 uiState;
	BOOL   CheckStorageErr = FALSE;
	static BOOL uiRecReStarting = FALSE;

	// flush key event first
	Ux_FlushEventByRange(NVTEVT_KEY_EVT_START, NVTEVT_KEY_EVT_END);

	// if HDMI is inserted, DRAM size is not enough for movie recording
	#if 0
	if (UI_GetData(FL_MOVIE_SIZE) == MOVIE_SIZE_FRONT_2880x2160P50 ||
		UI_GetData(FL_MOVIE_SIZE) == MOVIE_SIZE_FRONT_3840x2160P30 ||
		UI_GetData(FL_MOVIE_SIZE) == MOVIE_SIZE_FRONT_2880x2160P24) {
		if (KeyScan_GetPlugDev() == PLUG_HDMI) {
			return NVTEVT_CONSUME;
		}
	}
    #endif

	if (System_GetState(SYS_STATE_POWERON) == SYSTEM_POWERON_SAFE) {
		if (System_GetState(SYS_STATE_CARD)  == CARD_REMOVED) {
			Ux_OpenWindow(&UIFlowWndWrnMsgCtrl, 2, UIFlowWndWrnMsg_StatusTXT_Msg_STRID_PLEASE_INSERT_SD, FLOWWRNMSG_TIMER_2SEC);
			return NVTEVT_CONSUME;
		}
	} else if (System_GetState(SYS_STATE_POWERON) == SYSTEM_POWERON_NORMAL) {
		if (GxStrg_GetDeviceCtrl(0, CARD_READONLY)) { // card lock
			Ux_OpenWindow(&UIFlowWndWrnMsgCtrl, 2, UIFlowWndWrnMsg_StatusTXT_Msg_STRID_CARD_LOCKED, FLOWWRNMSG_TIMER_2SEC);
			return NVTEVT_CONSUME;
		}

		if (!GxStrg_GetDeviceCtrl(0, CARD_INSERT)) { // card insert
			Ux_OpenWindow(&UIFlowWndWrnMsgCtrl, 2, UIFlowWndWrnMsg_StatusTXT_Msg_STRID_PLEASE_INSERT_SD, FLOWWRNMSG_TIMER_2SEC);
			return NVTEVT_CONSUME;
		}
	}

	if (paramNum >= 3) {
		uiState = paramArray[2];
		DBGD(uiState);
	} else {
		uiState = 0;
	}

	uiKeyAct = paramNum ? paramArray[0] : 0;

	switch (uiKeyAct) {
	case NVTEVT_KEY_PRESS:
		//#NT#2016/03/07#KCHong -begin
		//#NT#Low power timelapse function
#if (TIMELAPSE_LPR_FUNCTION == ENABLE)
		if ((MovieTLLPR_Process(TIMELAPSE_FROM_UI) & TL_FLOW_MASK) == TL_FLOW_LPR) {   // TimelapseLPR module will handle recording process
// For TimelapseLPR OSD display test
			UxCtrl_SetDirty(&UIFlowWndMovieCtrl, TRUE);
			break;
		}
#endif
debug_msg(" --exe rec %d %d \r\n",gMovData.State, System_GetState(SYS_STATE_POWERON));
//#NT#2016/03/07#KCHong -end
		switch (gMovData.State) {
		case MOV_ST_VIEW:
//#NT#2016/09/20#Bob Huang -begin
//#NT#Support HDMI Display with 3DNR Out
#if (_3DNROUT_FUNC == ENABLE)
			if (MovRec_GetStatus() == MOVREC_STATUS_OPENED_NOT_RECORD || gb3DNROut)
#else
			if (1)//MovRec_GetStatus() == MOVREC_STATUS_OPENED_NOT_RECORD)
#endif
//#NT#2016/09/20#Bob Huang -end
			{
				gMovData.State = MOV_ST_REC;
#if 1
				if (System_GetState(SYS_STATE_POWERON) == SYSTEM_POWERON_SAFE) {
//#NT#2015/08/05#KS Hung -begin
//#NT#Even if the DCIM folder is not exist, FileSys_ScanDir stiil return FST_STA_OK.
//#NT#When the card is full and it sets cyclic record, it still can't record.
//#NT#MediaRec library will automatically delete the files of Car DV folder.
//#NT#if the files can't be deleted, it will have LOOPREC_FULL event in the callback.
					if (SysGetFlag(FL_MOVIE_CYCLIC_REC) == MOVIE_CYCLICREC_OFF) {
						CheckStorageErr = FlowMovie_IsStorageErr(TRUE);
					} else {
						CheckStorageErr = FlowMovie_IsStorageErr(FALSE);
					}
//#NT#2015/08/05#KS Hung -end
					if (CheckStorageErr == TRUE) {
						gMovData.State = MOV_ST_WARNING_MENU;
						gMovData.SysTimeCount = 0;
						return NVTEVT_CONSUME;
					}
				}
#endif
				if (GetBatteryLevel() == BATTERY_EXHAUSTED) {
					debug_err(("UIFlowWndMovie_OnExeRecord: Battery is too low!\r\n"));
					return NVTEVT_CONSUME;
				}

				if (FlowMovie_GetSelfTimerID() != NULL_TIMER) {
					FlowMovie_StopRecSelfTimer();
					return NVTEVT_CONSUME;
				}

				if (SysGetFlag(FL_MOVIE_MOTION_DET) == MOVIE_MOTIONDET_ON) {
					g_uiRecordIngMotionDet = TRUE;
				} else {
					g_uiRecordIngMotionDet = FALSE;
				}

				FlowMovie_StartRec();

				 if(uiState==UIFlowWndMovie_GSensor_Rec)
				{
					UINT32 i, mask, movie_rec_mask;
 					movie_rec_mask = Movie_GetMovieRecMask();
					mask = 1;
					for (i = 0; i < SENSOR_CAPS_COUNT; i++) {
						if (movie_rec_mask & mask) {
							ImageApp_MovieMulti_SetCrash(_CFG_REC_ID_1 + i, TRUE);
							g_bRecordLock = TRUE;
							CHKPNT;
							FlowMovie_UpdateIcons(TRUE);
						}
						mask <<= 1;
					}
					#if (defined(_NVT_ETHREARCAM_RX_))
						for(i = 0;i<ETH_REARCAM_CAPS_COUNT;i++)
						{
							CHKPNT;
							ImageApp_MovieMulti_SetCrash(_CFG_ETHCAM_ID_1 + i,TRUE);
						}	
					#endif
				}

				// start USB detect timer again
				if (g_ACPlug == TRUE) {
#if (USB_MODE == ENABLE)
					SxTimer_SetFuncActive(SX_TIMER_DET_USB_ID, TRUE);
#endif
				}
			}
			break;

		case MOV_ST_REC:
		case MOV_ST_REC|MOV_ST_ZOOM:
			
			
#if (_ADAS_FUNC_ == ENABLE)
UxCtrl_SetShow(&UIFlowWndMovie_ADAS_Alert_DisplayCtrl, FALSE);
			g_uiAdasAlertSecCnt = 0;
#endif  // #if (_ADAS_FUNC_ == ENABLE)

			// Isiah, implement YUV merge mode of recording func.
			//if (FlowMovie_GetRecCurrTime() >= 1)
			{
				// Mask key during movie stop flow.
				Ux_FlushEventByRange(NVTEVT_KEY_EVT_START, NVTEVT_KEY_EVT_END);
				//Input_SetKeyMask(KEY_PRESS, FLGKEY_KEY_MASK_NULL);

#if (STOP_REC_BK == ENABLE)
				//gMovData.State = MOV_ST_WARNING_MENU;
				if (uiState == UIFlowWndMovie_Restart_Rec){
					CHKPNT;
				  //  Ux_OpenWindow(&UIFlowWndWaitMomentCtrl, 1, UIFlowWndWaitMoment_StatusTXT_Msg_STRID_RESTART_REC);
				}else{
				    //Ux_OpenWindow(&UIFlowWndWaitMomentCtrl, 1, UIFlowWndWaitMoment_StatusTXT_Msg_STRID_STOPREC_WAIT);
				    if (g_UIStopRecTimerID == NULL_TIMER) {
						CHKPNT;
				        g_UIStopRecTimerID = GxTimer_StartTimer(100, NVTEVT_01SEC_TIMER, CONTINUE);
				    }
					CHKPNT;
				    //after 1 sec then go to WaitMoment Wnd
				    g_uiRecStopTimerCnt=10;
				}
				//#NT#2018/09/14#KCHong -begin
				//#NT# clear key mask when stop record flow is running
				Input_SetKeyMask(KEY_PRESS, FLGKEY_KEY_MASK_NULL);
				Ux_FlushEventByRange(NVTEVT_KEY_SHUTTER2, NVTEVT_KEY_SHUTTER2);
				//#NT#2018/09/14#KCHong -end
				BKG_PostEvent(NVTEVT_BKW_STOPREC_PROCESS);

				//Delay_DelayMs(500);
				//FlowMovie_StopRec();
#else
				CHKPNT;
				FlowMovie_StopRec();
				// update ui window icon
				FlowMovie_UpdateIcons(TRUE);
#endif

				if (uiState == UIFlowWndMovie_Restart_Rec && uiRecReStarting == FALSE) {
					// Enable key if user pressed shutter2 key to stop recording.
					Input_SetKeyMask(KEY_PRESS, g_uiMaskKeyPress);

#if (STOP_REC_BK == ENABLE)
#if defined(_KEY_METHOD_4KEY_)
                    //for WaitMoment wnd use
                    CHKPNT;
					Ux_PostEvent(NVTEVT_KEY_SHUTTER2, 3, NVTEVT_KEY_PRESS, 0, UIFlowWndMovie_Restart_Rec);
#else
                    //for WaitMoment wnd use
					Ux_PostEvent(NVTEVT_KEY_SELECT, 3, NVTEVT_KEY_PRESS, 0, UIFlowWndMovie_Restart_Rec);
#endif
#else
#if defined(_KEY_METHOD_4KEY_)
CHKPNT;
					Ux_PostEvent(NVTEVT_KEY_SHUTTER2, 1, NVTEVT_KEY_PRESS);
#else
					Ux_PostEvent(NVTEVT_KEY_SELECT, 1, NVTEVT_KEY_PRESS);
#endif
#endif
				} else {
					if (SysGetFlag(FL_MOVIE_MOTION_DET) == MOVIE_MOTIONDET_ON) {
						if (g_uiRecordIngMotionDet == TRUE) {
							g_uiRecordIngMotionDet = FALSE;
//#NT#2016/11/01#Adam Su -begin
//#NT#fix mantis issue 0106933
							UI_SetData(FL_MOVIE_MOTION_DET, MOVIE_MOTIONDET_OFF);
//#NT#2016/11/01#Adam Su -end
							//#NT#2018/06/28#Brain Yen -begin
							//#NT#gira: CARDV_680-75
							//FlowMovie_IconHideMotionDet(&UIFlowWndMovie_Status_MotionDetCtrl);
							//#NT#2018/06/28#Brain Yen -end
						}
					}
				}
			}
			break;
		}
		break;
	}
#if defined(_KEY_METHOD_4KEY_)
CHKPNT;
	Ux_DefaultEvent(pCtrl, NVTEVT_KEY_SHUTTER2, paramNum, paramArray);
#else
	Ux_DefaultEvent(pCtrl, NVTEVT_KEY_SELECT, paramNum, paramArray);
#endif
	return NVTEVT_CONSUME;
}

static INT32 UIFlowWndMovie_OnExeZoomIn(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
#if(PHOTO_MODE==ENABLE)
	UINT32  uiKeyAct;

	uiKeyAct = paramNum ? paramArray[0] : 0;

	debug_ind(("[UIFlowWndMovie_OnExeZoomIn][%d]\n\r", uiKeyAct));

	switch (uiKeyAct) {
	case NVTEVT_KEY_PRESS:
	case NVTEVT_KEY_CONTINUE:
		if (0) { //((Photo_GetDZoomIdx()-10) > UI_DZOOM_IDX_MAX)
			Ux_SendEvent(&CustomPhotoObjCtrl, NVTEVT_EXE_ZOOM, 2, UI_ZOOM_CTRL_STOP, UI_GetData(FL_Dzoom));
			gMovData.State &= ~MOV_ST_ZOOM;
			return NVTEVT_PASS;
		}
		switch (gMovData.State) {
		case MOV_ST_VIEW:
		case MOV_ST_REC:
		case MOV_ST_VIEW | MOV_ST_ZOOM:
		case MOV_ST_REC | MOV_ST_ZOOM:
			/* set Digital Zoom interface */
			UI_SetData(FL_ZoomIFIndex, ZOOM_IF_DIGITAL);

			gMovData.State |= MOV_ST_ZOOM;
			Ux_SendEvent(&CustomPhotoObjCtrl, NVTEVT_EXE_ZOOM, 2, UI_ZOOM_CTRL_IN, UI_GetData(FL_Dzoom));
			break;
		}
		break;

	case NVTEVT_KEY_RELEASE:
		switch (gMovData.State) {
		case MOV_ST_VIEW | MOV_ST_ZOOM:
		case MOV_ST_REC | MOV_ST_ZOOM:
			Ux_SendEvent(&CustomPhotoObjCtrl, NVTEVT_EXE_ZOOM, 2, UI_ZOOM_CTRL_STOP, UI_GetData(FL_Dzoom));
			gMovData.State &= ~MOV_ST_ZOOM;
			break;
		}
		break;
	}
#endif
	return NVTEVT_PASS;
}

static INT32 UIFlowWndMovie_OnExeZoomOut(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
#if(PHOTO_MODE==ENABLE)

	UINT32  uiKeyAct;

	uiKeyAct = paramNum ? paramArray[0] : 0;

	debug_ind(("[UIFlowWndMovie_OnExeZoomOut][%d]\n\r", uiKeyAct));

	switch (uiKeyAct) {
	case NVTEVT_KEY_PRESS:
	case NVTEVT_KEY_CONTINUE:
		switch (gMovData.State) {
		case MOV_ST_VIEW:
		case MOV_ST_REC:
		case MOV_ST_VIEW | MOV_ST_ZOOM:
		case MOV_ST_REC | MOV_ST_ZOOM:
			/* set Digital Zoom interface */
			UI_SetData(FL_ZoomIFIndex, ZOOM_IF_DIGITAL);

			gMovData.State |= MOV_ST_ZOOM;
			Ux_SendEvent(&CustomPhotoObjCtrl, NVTEVT_EXE_ZOOM, 2, UI_ZOOM_CTRL_OUT, UI_GetData(FL_Dzoom));
			break;
		}
		break;

	case NVTEVT_KEY_RELEASE:
		switch (gMovData.State) {
		case MOV_ST_VIEW | MOV_ST_ZOOM:
		case MOV_ST_REC | MOV_ST_ZOOM:
			Ux_SendEvent(&CustomPhotoObjCtrl, NVTEVT_EXE_ZOOM, 2, UI_ZOOM_CTRL_STOP, UI_GetData(FL_Dzoom));
			gMovData.State &= ~MOV_ST_ZOOM;
			break;
		}
		break;
	}
#endif
	return NVTEVT_PASS;
}

static void UIFlowWndMovie_Initparam(void)
{
#if(PHOTO_MODE==ENABLE)
	// The same effect as Photo mode
	Ux_SendEvent(&CustomPhotoObjCtrl,   NVTEVT_EXE_WB,                  1,  SysGetFlag(FL_WB));

	// The other settings
	Ux_SendEvent(&CustomPhotoObjCtrl,   NVTEVT_EXE_COLOR,               1,  MOVIE_COLOR_NORMAL);
#endif
	/* Video resolution setting must be set after other IQ settings */
	Ux_SendEvent(&CustomMovieObjCtrl,   NVTEVT_EXE_MOVIESIZE,           1,  SysGetFlag(FL_MOVIE_SIZE));

	/* Cyclic recording/record with mute or sound/DateImptint/Motion Detect */
	Ux_SendEvent(&CustomMovieObjCtrl,   NVTEVT_EXE_CYCLIC_REC,          1,  SysGetFlag(FL_MOVIE_CYCLIC_REC));
	Ux_SendEvent(&CustomMovieObjCtrl,   NVTEVT_EXE_MOTION_DET,          1,  SysGetFlag(FL_MOVIE_MOTION_DET));
	Ux_SendEvent(&CustomMovieObjCtrl,   NVTEVT_EXE_MOVIE_DATE_IMPRINT,  1,  SysGetFlag(FL_MOVIE_DATEIMPRINT));
	Ux_SendEvent(&CustomMovieObjCtrl,   NVTEVT_EXE_MOVIE_AUDIO,         1,  SysGetFlag(FL_MOVIE_AUDIO));
#if(PHOTO_MODE==ENABLE)
	Ux_SendEvent(&CustomPhotoObjCtrl,   NVTEVT_EXE_EV,                  1,  SysGetFlag(FL_EV));
#endif
	Ux_SendEvent(&CustomMovieObjCtrl,   NVTEVT_EXE_MOVIE_MCTF,          1,  SysGetFlag(FL_MovieMCTFIndex));
	//Ux_SendEvent(&CustomMovieObjCtrl,   NVTEVT_EXE_MOVIE_WDR,           1,  SysGetFlag(FL_MOVIE_WDR));
	Ux_SendEvent(&CustomMovieObjCtrl,   NVTEVT_EXE_MOVIE_HDR,           1,  SysGetFlag(FL_MOVIE_HDR));
	Ux_SendEvent(&CustomMovieObjCtrl,   NVTEVT_EXE_MOVIE_DEFOG,           1,  SysGetFlag(FL_MOVIE_DEFOG));
	Ux_SendEvent(&CustomMovieObjCtrl,   NVTEVT_EXE_GSENSOR,             1,  SysGetFlag(FL_GSENSOR));
#if (ETHCAM_TX_DISPLAY_FLIP == DISABLE)
	Ux_SendEvent(&CustomMovieObjCtrl,   NVTEVT_EXE_MOVIE_SENSOR_ROTATE, 1,  SysGetFlag(FL_MOVIE_SENSOR_ROTATE));
#endif
	Ux_SendEvent(&CustomMovieObjCtrl,   NVTEVT_EXE_MOVIE_IR_CUT,        1,  SysGetFlag(FL_MOVIE_IR_CUT));
	Ux_SendEvent(&CustomMovieObjCtrl,   NVTEVT_EXE_MOVIE_PROTECT_AUTO,  1,  SysGetFlag(FL_MOVIE_URGENT_PROTECT_AUTO));
	Ux_SendEvent(&CustomMovieObjCtrl,   NVTEVT_EXE_MOVIE_PROTECT_MANUAL, 1,  SysGetFlag(FL_MOVIE_URGENT_PROTECT_MANUAL));
	Ux_SendEvent(&CustomMovieObjCtrl,   NVTEVT_EXE_MOVIE_LDWS,          1,  SysGetFlag(FL_MOVIE_LDWS));
	Ux_SendEvent(&CustomMovieObjCtrl,   NVTEVT_EXE_MOVIE_FCW,           1,  SysGetFlag(FL_MOVIE_FCW));
	Ux_SendEvent(&UISetupObjCtrl,       NVTEVT_EXE_FREQ,                1,  SysGetFlag(FL_FREQUENCY));
#if (MOVIE_RSC == ENABLE)
	Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_MOVIE_RSC, 1, MOVIE_RSC_ON);
#endif
#if MOVIE_DIS
	Ux_SendEvent(&CustomMovieObjCtrl,   NVTEVT_EXE_MOVIEDIS,            1,  MOVIE_DIS_ON);
#endif
#if SHDR_FUNC
	//Ux_SendEvent(&CustomMovieObjCtrl,   NVTEVT_EXE_SHDR,                1,  MOVIE_HDR_ON);
#endif
	Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_MOVIE_CODEC, 1, SysGetFlag(FL_MOVIE_CODEC));
}

static BOOL g_bDelayUpdateIcon = FALSE;
extern void SetEthPowerOn(void);
//static 
	BOOL autoRec =FALSE;

BOOL bSDFormat = FALSE;
static BOOL  UIFlowMovie_CheckSDStatus(void)
{
	static BOOL isFirstOpen=TRUE;
	if ((System_GetState(SYS_STATE_CARD) == CARD_INSERTED)&&(UIStorageCheck(STORAGE_CHECK_ERROR, NULL) == FALSE) )//&& isFirstOpen )
	{
			FST_FILE  filehdl,filehdl2;
			char FileName_Buf[32];
			CHAR sTF_FORMAT_MARK[] = TF_FORMAT_MARK_NAME;
			//filehdl = FileSys_OpenFile(&sTF_FORMAT_MARK,FST_OPEN_READ);
			//UINT32 filelen,gpsbufferlen;
			struct tm   CurDateTime = {0};
			//char GPSADD_Buf[1024];
			
			isFirstOpen = FALSE;
			CurDateTime = HwClock_GetTime(TIME_ID_CURRENT);
			debug_msg(" == %04d%02d%02d%02d%02d \r\n",CurDateTime.tm_year, CurDateTime.tm_mon, CurDateTime.tm_mday, CurDateTime.tm_hour, CurDateTime.tm_min);
			sprintf(FileName_Buf, "A:\\MISC\\CTS_%04d%02d%02d%02d%02d.txt",CurDateTime.tm_year, CurDateTime.tm_mon, CurDateTime.tm_mday, CurDateTime.tm_hour, CurDateTime.tm_min);
			debug_msg("CTS s=%s \r\n",FileName_Buf);

			FileSys_MakeDir("A:\\MISC\\");
			filehdl2 = FileSys_OpenFile(FileName_Buf,FST_CREATE_ALWAYS|FST_OPEN_WRITE);

		 	if(filehdl2)
			{
				FileSys_CloseFile(filehdl2);					
				debug_msg("[card]Create Directory  file to %s\r\n",FileName_Buf);
#if (LOGFILE_FUNC==ENABLE)
	{
		if (bSysLogfile)
		{
			CHKPNT;
			LogFile_Suspend();
			LogFile_Close();
		}
	}
#endif
	    		DX_HANDLE pStrgDevOld = GxStrg_GetDevice(0);
	    		GxStrg_CloseDevice(0);
    			GxStrg_OpenDevice(0, pStrgDevOld);
				FileSys_WaitFinish();

				filehdl2 = NULL;
       			filehdl2 = FileSys_OpenFile(FileName_Buf,FST_OPEN_READ);

				FileSys_SetAttrib("A:\\MISC\\",FST_ATTRIB_HIDDEN,TRUE); 
				
				 if(filehdl2)
				 {
				 	
					FileSys_CloseFile(filehdl2);
				 	FileSys_DeleteFile(FileName_Buf);
					filehdl = FileSys_OpenFile(sTF_FORMAT_MARK,FST_OPEN_READ);

					if ( filehdl == NULL)
					{
						debug_msg("[card]No such  file in A:\\MISC\\MIO_C90.txt \r\n");
						CloseTimer();
						Ux_OpenWindow(&UIFlowWndWaitMomentCtrl, 1,UIFlowWndWaitMoment_StatusTXT_Msg_STRID_FORMACT_SD);
						bSDFormat = TRUE;	
					}else{	
						bSDFormat = FALSE;
						FileSys_CloseFile(filehdl);
					}	
				 }else{
					// card status changed
				 }
		}else{
			// card status changed
			CHKPNT;
			Ux_OpenWindow(&UIFlowWndWrnMsgCtrl, 1, UIFlowWndWrnMsg_StatusTXT_Msg_STRID_CARDERROR);
			isStopREC = TRUE;
			bSDFormat = TRUE;
		}
	}
	return  bSDFormat;
}
 BOOL  SDStatus = FALSE;
 extern void CheckFileRecovery(void);
// static  BOOL  FristMovieOpen = FALSE;
 static void HideMoviePanle(void)
 {
		UxCtrl_SetShow(&UIFlowWndMovie_Static_RecTxtCtrl, FALSE);
		UxCtrl_SetShow(&UIFlowWndMovie_Panel_OperateCtrl, FALSE);
		UxCtrl_SetShow(&UIFlowWndMovie_BackLightLvl_BarCtrl, FALSE);

		UxCtrl_SetShow(&UIFlowWndMovie_Panel_BehindCtrl, FALSE);
		UxCtrl_SetShow(&UIFlowWndMovie_BTN_BehindUPCtrl, FALSE);
		UxCtrl_SetShow(&UIFlowWndMovie_BTN_BehindDownCtrl, FALSE);

 }

static BOOL  bDetEthcamUpdate = FALSE;
UINT32 bDetEthcamUpdateCount = 0;
#if(Ethcam_PIPTestFunc == ENABLE)
	BOOL Ethcam_PipTest = FALSE;
	UINT8 Ethcam_PipTestCnt = 0;
#endif
extern void self_init_lcd(void);
extern BOOL g_EnterParkingMode_CloseBL;
extern void SetBLStatus(BOOL status );
INT32 UIFlowWndMovie_OnOpen(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
debug_msg("--------------UIFlowWndMovie_OnOpen CJ --------------%d \r\n" ,UI_GetData( FL_MOVIE_SIZE ));
	static BOOL lcd_init_once = FALSE;
	g_uiRecStopTimerCnt=0;
	//#NT#2016/03/07#KCHong -begin
	//#NT#Low power timelapse function, do not show OSD if boot from alarm
#if (TIMELAPSE_LPR_FUNCTION == ENABLE)
	if (MovieTLLPR_CheckHWRTStatus() == TL_HWRT_BOOT_ALARM) {
		UxCtrl_SetAllChildShow(pCtrl, FALSE);
		return NVTEVT_CONSUME;
	}
#endif
//#NT#2016/03/07#KCHong -end

	//#NT#2015/07/17#KS Hung -begin
	//#NT#For ADAS
	// cancle 0702 cj 
	//UxCtrl_SetShow(&UIFlowWndMovie_ADAS_Alert_DisplayCtrl, FALSE);
	//UxCtrl_SetShow(&UIFlowWndMovie_Panel_Normal_DisplayCtrl, TRUE);
	//#NT#2015/07/17#KS Hung -end
	HideMoviePanle();
	Ux_FlushEventByRange(NVTEVT_KEY_EVT_START, NVTEVT_KEY_EVT_END);
	/* Init window key mask variables & set key and key released mask */
	g_uiMaskKeyPress = MOVIE_KEY_PRESS_MASK;
	g_uiMaskKeyRelease = MOVIE_KEY_RELEASE_MASK;
	Input_SetKeyMask(KEY_PRESS, g_uiMaskKeyPress);
	Input_SetKeyMask(KEY_RELEASE, g_uiMaskKeyPress);
	Input_SetKeyMask(KEY_CONTINUE, g_uiMaskKeyPress);

#if (GSENSOR_FUNCTION == ENABLE)
	if (UI_GetData(FL_MOVIE_SIZE) == MOVIE_SIZE_FRONT_640x480P240
		&& UI_GetData(FL_GSENSOR) != GSENSOR_OFF) {
		UI_SetData(FL_GSENSOR, GSENSOR_OFF);
		DBG_ERR("G-Sensor is not support on fps=240, because i2c is too busy.\r\n");
	}
//MUST open before UIFlowWndMovie_Initparam, because Initparam call GSensor_SetSensitivity.
	GSensor_open();
#endif

	//System_OnStrg_TxFirmware();//check again
	if(lcd_init_once == FALSE)
	{
		SetBLStatus(FALSE);
	}
	UIFlowWndMovie_Initparam();
	if(lcd_init_once == FALSE)
	{
		lcd_init_once = TRUE;
		Delay_DelayMs(50);
		self_init_lcd();
		Delay_DelayMs(200);
		if(g_EnterParkingMode_CloseBL == FALSE)
		{
			DBGD(SysGetFlag(FL_LCD_BRIGHTNESS));
			GxVideo_SetDeviceCtrl(DOUT1, DISPLAY_DEVCTRL_BRIGHTLVL,SysGetFlag(FL_LCD_BRIGHTNESS) );//iCur_BL_Value_Bar
			SetBLStatus(TRUE);
		}
	}
	debug_msg( "--cj SYS_STATE_POWERON:%d %d \r\n",System_GetState(SYS_STATE_POWERON), UIStorageCheck(STORAGE_CHECK_ERROR, NULL));
	if (System_GetState(SYS_STATE_POWERON) == SYSTEM_POWERON_SAFE) {				
		#if(ONVIF_PROFILE_S!=ENABLE) //No File System	
		if (UIStorageCheck(STORAGE_CHECK_ERROR, NULL) == TRUE) {
			CHKPNT;
			Ux_OpenWindow(&UIFlowWndWrnMsgCtrl, 2, UIFlowWndWrnMsg_StatusTXT_Msg_STRID_PLEASE_INSERT_SD, FLOWWRNMSG_TIMER_3SEC);
		}
		#endif
	}
	//self_init_lcd(); //0309
	if (System_GetState(SYS_STATE_POWERON) == SYSTEM_POWERON_SAFE) {
		if (System_GetState(SYS_STATE_CARD)  == CARD_REMOVED) {
			CHKPNT;
			Ux_OpenWindow(&UIFlowWndWrnMsgCtrl, 2, UIFlowWndWrnMsg_StatusTXT_Msg_STRID_PLEASE_INSERT_SD, FLOWWRNMSG_TIMER_2SEC);
			return NVTEVT_CONSUME;
		}
	} else if (System_GetState(SYS_STATE_POWERON) == SYSTEM_POWERON_NORMAL) {
		if (GxStrg_GetDeviceCtrl(0, CARD_READONLY)) { // card lock
			CHKPNT;
			Ux_OpenWindow(&UIFlowWndWrnMsgCtrl, 2, UIFlowWndWrnMsg_StatusTXT_Msg_STRID_CARD_LOCKED, FLOWWRNMSG_TIMER_2SEC);
			return NVTEVT_CONSUME;
		}

		if (!GxStrg_GetDeviceCtrl(0, CARD_INSERT)) { // card insert
			CHKPNT;
			Ux_OpenWindow(&UIFlowWndWrnMsgCtrl, 2, UIFlowWndWrnMsg_StatusTXT_Msg_STRID_PLEASE_INSERT_SD, FLOWWRNMSG_TIMER_2SEC);
			return NVTEVT_CONSUME;
		}
	}
	if (System_GetState(SYS_STATE_POWERON) == SYSTEM_POWERON_SAFE) {
		#if USE_FILEDB
		if (UI_GetData(FL_IsUseFileDB)) {
			//Ux_SendEvent(&UISetupObjCtrl, NVTEVT_FILEID_RESET, 0);
		}
		#endif
	}
		
	// Enable Motion Detect function in starting up movie mode
	if (SysGetFlag(FL_MOVIE_MOTION_DET) == MOVIE_MOTIONDET_ON) {
		g_uiRecordIngMotionDet = TRUE;
	} else {
		g_uiRecordIngMotionDet = FALSE;
	}

	// delete empty folder
#if (USE_FILEDB==DISABLE)
	UIFlowWndMovie_DeleteEmptyFolder();
#endif


#if ((POWERON_FAST_WIFI != ENABLE) && (POWERON_FAST_RECORD == ENABLE))
	if (System_GetState(SYS_STATE_POWERON) == SYSTEM_POWERON_NORMAL) {
// fast record
		UINT32 paramArray[1] = {NVTEVT_KEY_PRESS};
		UIFlowWndMovie_OnExeRecord(pCtrl, 1, paramArray);
	}

	if (System_GetState(SYS_STATE_POWERON) == SYSTEM_POWERON_SAFE) {
		FlowMovie_UpdateIcons(TRUE);
	} else {
		FlowMovie_UpdateIcons(FALSE);
		UI_SetDisplayFlip(FALSE);
		g_bDelayUpdateIcon = TRUE;
	}
#else
	FlowMovie_UpdateIcons(TRUE);
#endif
FlowMovie_IconHideBackLightLvl_Panel();
#if(IS_ALPHA_TYPEFMT(DISPLAY_OSD_FMT))
	/* open VDO2 background */
	UI_Show(UI_SHOW_BACKGND, TRUE);
#endif
#if(LOGFILE_FUNC == DISABLE)
	if( UIFlowMovie_CheckSDStatus()){
		CHKPNT;
		//SDStatus = FALSE;
		return NVTEVT_CONSUME;
	}
#endif
#if(Ethcam_PIPTestFunc == ENABLE)

	FST_FILE ethcam_filehdl;
	static char ethcam_filename[64] ="A:\\C90_ChangePIP.txt" ;//"FW671_AA";// "A:\\EthcamTxFW.bin";
	
	ethcam_filehdl = FileSys_OpenFile(ethcam_filename,FST_OPEN_READ);
	
	 if(ethcam_filehdl)
	 {
		Ethcam_PipTest = TRUE;
		FileSys_CloseFile(ethcam_filehdl);
	 }
#endif


	// update g_uiRecordIngMotionDet flag
	if (gUIMotionDetTimerID == NULL_TIMER) {
		gUIMotionDetTimerID = GxTimer_StartTimer(TIMER_HALF_SEC, NVTEVT_05SEC_TIMER, CONTINUE);
		debug_msg("movie NVTEVT_05SEC_TIMER open\r\n");
	}
	if (g_uiDateTimerID == NULL_TIMER) {
		g_uiDateTimerID = GxTimer_StartTimer(TIMER_ONE_SEC, NVTEVT_1SEC_TIMER, CONTINUE);
		debug_msg("movie NVTEVT_1SEC_TIMER open\r\n");
	}
	if (g_UILCAAlarmTimerID == NULL_TIMER) {
		g_UILCAAlarmTimerID = GxTimer_StartTimer(TIMER_LCA_SEC, NVTEVT_LCA_ALARM_TIMER, CONTINUE);
		debug_msg("movie NVTEVT_LCA_ALARM_TIMER open\r\n");
	}

	bChangeModeAutoRec = FALSE;
	autoRec = FALSE;//FALSE;

	Ux_DefaultEvent(pCtrl, NVTEVT_OPEN_WINDOW, paramNum, paramArray);

	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_OnClose(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
//	SlideDownCount = 0;

	UIFlowWndMovie_ALG_Clear_OSD();
	switch (gMovData.State) {
	case MOV_ST_REC:
	case MOV_ST_REC|MOV_ST_ZOOM:
		if (FlowMovie_GetRecCurrTime() <= 1) {
			Delay_DelayMs(1000);
		}
		FlowMovie_StopRec();
		Ux_SendEvent(&UIFlowWndMovieCtrl, NVTEVT_CB_MOVIE_FINISH, 0);
		break;
	}

	g_bRedLEDOn = FALSE;
	//KeyScan_TurnOffLED(KEYSCAN_LED_RED);

	if (gUIMotionDetTimerID != NULL_TIMER) {
		GxTimer_StopTimer(&gUIMotionDetTimerID);
	}

	if (g_uiDateTimerID != NULL_TIMER) {
		GxTimer_StopTimer(&g_uiDateTimerID);
	}

	if (g_UIStopRecTimerID != NULL_TIMER) {
		GxTimer_StopTimer(&g_UIStopRecTimerID);
	}

	if (g_UILCAAlarmTimerID != NULL_TIMER) {
		GxTimer_StopTimer(&g_UILCAAlarmTimerID);
	}

	if(UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl))
	{
		FlowMovie_DrawBrightnessBar(FALSE);
		//UIFlowWndMovie_SetBriAdjBarShowTime(-1);
		//UI_CancelTouchEventMask(NVTEVT_USER_SLIDE_LEFT);
		//UI_CancelTouchEventMask(NVTEVT_USER_SLIDE_RIGHT);
	}
	
#if 0// (GSENSOR_FUNCTION == ENABLE)
	GSensor_close();
#endif

    bChangeModeAutoRec = TRUE;

	Input_SetKeyMask(KEY_PRESS, g_uiMaskKeyPress);
	Input_SetKeyMask(KEY_RELEASE, g_uiMaskKeyPress);
	Input_SetKeyMask(KEY_CONTINUE, g_uiMaskKeyPress);
	Ux_DefaultEvent(pCtrl, NVTEVT_CLOSE_WINDOW, paramNum, paramArray);
	return NVTEVT_CONSUME;
}

static void UIFlowWndMovie_OnALGEnd(void)
{
	//UxCtrl_SetShow(&UIFlowWndMovie_ALG_DrawCtrl, TRUE);
	/* Redraw all window OSD */
	UxCtrl_SetDirty(&UIFlowWndMovieCtrl, TRUE);
}
INT32 UIFlowWndMovie_OnUpdateInfo(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	if (paramNum == 0) {
		return NVTEVT_CONSUME;
	}
	switch (paramArray[0]) {
	case UIAPPPHOTO_CB_ALGEND:
		//UIFlowWndMovie_OnALGEnd();
		//UIFlowWndMovie_TSR_OSD_Draw(pCtrl,paramNum,paramArray);
		break;
	default:
		DBG_ERR("Unknown CB %d\r\n", paramArray[0]);
	}

	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_OnKeyNext(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	// next key
	UINT32  uiKeyAct;
	UINT32  uiSoundMask;

	uiKeyAct = paramArray[0];

	switch (uiKeyAct) {
	case NVTEVT_KEY_PRESS:
		switch (gMovData.State) {
		case MOV_ST_VIEW:
		case MOV_ST_VIEW|MOV_ST_ZOOM:
			// stope timer when entering menu
			if (gUIMotionDetTimerID != NULL_TIMER) {
				GxTimer_StopTimer(&gUIMotionDetTimerID);
			}

			if (g_uiDateTimerID != NULL_TIMER) {
				GxTimer_StopTimer(&g_uiDateTimerID);
			}

			if (g_UIStopRecTimerID != NULL_TIMER) {
				GxTimer_StopTimer(&g_UIStopRecTimerID);
			}

			// Enable shutter2 sound (Select key as OK key in menu)
			uiSoundMask = Input_GetKeySoundMask(KEY_PRESS);
			uiSoundMask |= FLGKEY_ENTER;
			Input_SetKeySoundMask(KEY_PRESS, uiSoundMask);
			Input_SetKeyMask(KEY_RELEASE, FLGKEY_KEY_MASK_NULL);

			// Open common mix (Item + Option) menu
			Ux_OpenWindow((VControl *)(&MenuCommonItemCtrl), 0);
			gMovData.State = MOV_ST_MENU;
			break;
		case MOV_ST_REC:
		case MOV_ST_REC|MOV_ST_ZOOM:
			if (SysGetFlag(FL_MOVIE_URGENT_PROTECT_MANUAL) == MOVIE_URGENT_PROTECT_MANUAL_ON) {
#if (MOVIE_MULTI_RECORD_FUNC)
				if (GetMovieRecType_2p(UI_GetData(FL_MOVIE_SIZE)) == MOVIE_REC_TYPE_FRONT) {
#if(defined(_NVT_ETHREARCAM_RX_))
					ImageApp_MovieMulti_SetCrash(_CFG_REC_ID_1, TRUE);
					UINT32 i;
					for (i = 0; i < ETH_REARCAM_CAPS_COUNT; i++) {
						if(socketCliEthData1_IsRecv(ETHCAM_PATH_ID_1 +i)){
							ImageApp_MovieMulti_SetCrash(_CFG_ETHCAM_ID_1+i, TRUE);
						}
					}
#else
					ImageApp_MovieMulti_TrigEMR(_CFG_REC_ID_1);
#endif
				} else {
					UINT32 i, mask, movie_rec_mask;

 					movie_rec_mask = Movie_GetMovieRecMask();
					mask = 1;
					for (i = 0; i < SENSOR_CAPS_COUNT; i++) {
						if (movie_rec_mask & mask) {
							ImageApp_MovieMulti_SetCrash(_CFG_REC_ID_1 + i, TRUE);
						}
						mask <<= 1;
					}
				}
#else
				ImageApp_Movie_SetParam(_CFG_REC_ID_1, MOVIE_PARAM_FILE_TRIGEMR, 1);
#endif
				Ux_DefaultEvent(pCtrl, NVTEVT_KEY_NEXT, paramNum, paramArray);
				return NVTEVT_CONSUME;
			}
			break;
		}
		break;
	}

	Ux_DefaultEvent(pCtrl, NVTEVT_KEY_NEXT, paramNum, paramArray);
	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_OnKeySelect(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	UINT32  uiKeyAct;
//CHKPNT;
	// Similar to Shutter2 key
	uiKeyAct = paramArray[0];
	switch (uiKeyAct) {
	case NVTEVT_KEY_PRESS: {
			/*
			if (gMovData.State==MOV_ST_VIEW)
			{
			    gMovData.State=MOV_ST_REC;

			}
			else if (gMovData.State==MOV_ST_REC)
			{
			    gMovData.State=MOV_ST_VIEW;
			    // update ui window icon
			    FlowMovie_UpdateIcons(TRUE);
			}
			*/
			UIFlowWndMovie_OnExeRecord(pCtrl, paramNum, paramArray);CHKPNT;
		}
		break;
	}
	return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnKeyMenu(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	UINT32  uiKeyAct;
	UINT32  uiSoundMask;

	uiKeyAct = paramArray[0];

	switch (uiKeyAct) {
	case NVTEVT_KEY_PRESS:

//#MT#lyb -20200409 -begin

    #if 0
		switch (gMovData.State) {
		case MOV_ST_VIEW:
		case MOV_ST_VIEW|MOV_ST_ZOOM:
			// stope timer when entering menu
			if (gUIMotionDetTimerID != NULL_TIMER) {
				GxTimer_StopTimer(&gUIMotionDetTimerID);
			}

			if (g_uiDateTimerID != NULL_TIMER) {
				GxTimer_StopTimer(&g_uiDateTimerID);
			}

			if (g_UIStopRecTimerID != NULL_TIMER) {
				GxTimer_StopTimer(&g_UIStopRecTimerID);
			}

            if (g_UILCAAlarmTimerID != NULL_TIMER) {
                GxTimer_StopTimer(&g_UILCAAlarmTimerID);
            }
            
			if(UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl))
			{
				FlowMovie_DrawBrightnessBar(FALSE);
				UIFlowWndMovie_SetBriAdjBarShowTime(-1);
				UI_CancelTouchEventMask(NVTEVT_USER_SLIDE_LEFT);
				UI_CancelTouchEventMask(NVTEVT_USER_SLIDE_RIGHT);
				UI_CancelTouchEventMask(NVTEVT_USER_SLIDE_UP);
				UI_CancelTouchEventMask(NVTEVT_USER_SLIDE_DOWN);
			}
			// enable shutter2 sound (shutter2 as OK key in menu)
			uiSoundMask = Input_GetKeySoundMask(KEY_PRESS);
			uiSoundMask |= FLGKEY_ENTER;
			Input_SetKeySoundMask(KEY_PRESS, uiSoundMask);

			Input_SetKeyMask(KEY_RELEASE, FLGKEY_KEY_MASK_NULL);
			// Open common mix (Item + Option) menu
			Ux_OpenWindow((VControl *)(&MenuCommonItemCtrl), 0);
			gMovData.State = MOV_ST_MENU;
			break;
		}
    #else
	#if 1
		if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_BehindCtrl))
			{
				HideBehindBar();
			}
			if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_OperateCtrl) )
			{
				UxCtrl_SetShow(&UIFlowWndMovie_Panel_OperateCtrl, FALSE);
				FocusOperateCount = 0;
				FocusOperate = FALSE;
			}
			
			if  (UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl) )
			{
				FlowMovie_IconHideBackLightLvl_Panel();
				
					FocusOperateCount = 0;
					FocusOperate = FALSE;
			}
				
	#endif
		// stope timer when entering menu
		if (gUIMotionDetTimerID != NULL_TIMER) {
			GxTimer_StopTimer(&gUIMotionDetTimerID);
		}

		if (g_uiDateTimerID != NULL_TIMER) {
			GxTimer_StopTimer(&g_uiDateTimerID);
		}

		if (g_UIStopRecTimerID != NULL_TIMER) {
			GxTimer_StopTimer(&g_UIStopRecTimerID);
		}

        if (g_UILCAAlarmTimerID != NULL_TIMER) {
            GxTimer_StopTimer(&g_UILCAAlarmTimerID);
        }
        
		if(UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl))
		{
			FlowMovie_DrawBrightnessBar(FALSE);
			//UIFlowWndMovie_SetBriAdjBarShowTime(-1);
			//UI_CancelTouchEventMask(NVTEVT_USER_SLIDE_LEFT);
			//UI_CancelTouchEventMask(NVTEVT_USER_SLIDE_RIGHT);
			//UI_CancelTouchEventMask(NVTEVT_USER_SLIDE_UP);
			//UI_CancelTouchEventMask(NVTEVT_USER_SLIDE_DOWN);
		}
		// enable shutter2 sound (shutter2 as OK key in menu)
		uiSoundMask = Input_GetKeySoundMask(KEY_PRESS);
		uiSoundMask |= FLGKEY_ENTER;
		Input_SetKeySoundMask(KEY_PRESS, uiSoundMask);

		Input_SetKeyMask(KEY_RELEASE, FLGKEY_KEY_MASK_NULL);
		// Open common mix (Item + Option) menu
		Ux_OpenWindow((VControl *)(&MenuCommonItemCtrl), 0);
		//gMovData.State = MOV_ST_MENU;
		break;


    #endif

//#MT#lyb -20200409 -end


        
		break;
	}
	Ux_DefaultEvent(pCtrl, NVTEVT_KEY_MENU, paramNum, paramArray);
	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_OnKeyDown(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	UINT32  uiKeyAct;

	uiKeyAct = paramArray[0];

	switch (uiKeyAct) {
	case NVTEVT_KEY_PRESS:
			switch (gMovData.State) {
			case MOV_ST_REC:
			case MOV_ST_REC|MOV_ST_ZOOM:
				if (SysGetFlag(FL_MOVIE_PIM) == MOVIE_PIM_ON) {
					//FlowMovie_DrawPIM(TRUE);
					Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_MOVIE_REC_RAWENC, 0);
				}
				break;
			}
			break;
	}
	Ux_DefaultEvent(pCtrl, NVTEVT_KEY_DOWN, paramNum, paramArray);
	return NVTEVT_CONSUME;
}

#if 0
INT32 UIFlowWndMovie_OnKeyLeft(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	UINT32  uiKeyAct;
	UINT32  uiEV;

	uiKeyAct = paramNum ? paramArray[0] : 0;

	switch (uiKeyAct) {
	case NVTEVT_KEY_PRESS:
		switch (gMovData.State) {
		case MOV_ST_VIEW:
		case MOV_ST_VIEW|MOV_ST_ZOOM:
			uiEV = SysGetFlag(FL_EV);
			if (uiEV == EV_N20) {
				SysSetFlag(FL_EV, EV_P20);
			} else {
				SysSetFlag(FL_EV, ++uiEV);
			}
			Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_MOVIE_EV, 1, SysGetFlag(FL_EV));
			FlowMovie_IconDrawEV(&UIFlowWndMovie_StatusICN_EVCtrl);
			break;
		case MOV_ST_REC:
			if (SysGetFlag(FL_MOVIE_CYCLIC_REC) != MOVIE_CYCLICREC_OFF && FlowMovie_GetRecCurrTime() >= 1) {
#if (0)//(PRJ == APC3)
				g_bSpeLockFun = TRUE;
				FlowMovie_StopRec();
				Ux_SendEvent(pCtrl, NVTEVT_CB_MOVIE_FINISH, 1, UIFlowWndMovie_Restart_Rec);
#endif
			}
			break;
		}
		break;
	}

	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_OnKeyRight(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	UINT32  uiKeyAct;

	uiKeyAct = paramArray[0];

	switch (uiKeyAct) {
	case NVTEVT_KEY_PRESS:
		switch (gMovData.State) {
		case MOV_ST_REC:
		case MOV_ST_REC|MOV_ST_ZOOM: {
				FlowMovie_DrawPIM(TRUE);
				Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_MOVIE_REC_RAWENC, 0);
			}
			break;
		}
		break;
	// Enter menu
	default:
		Ux_PostEvent(NVTEVT_KEY_MENU, 1, NVTEVT_KEY_PRESS);
		break;
	}

	return NVTEVT_CONSUME;
}
#endif
INT32 UIFlowWndMovie_OnChildClose(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	UINT32  uiSoundMask;
	debug_msg("NVTRET_WAITMOMENT :%d isStopREC:%d gMovData.State:%d\r\n", paramArray[0],isStopREC,gMovData.State);
    CHKPNT;
	if ( Restart_Rec)
	{
	 	CHKPNT;
		Restart_Rec = FALSE;
		Ux_PostEvent(NVTEVT_KEY_SHUTTER2, 3, NVTEVT_KEY_PRESS, 0, UIFlowWndMovie_Restart_Rec);
	}
	switch (gMovData.State) {
	case MOV_ST_WARNING_MENU:
		if (paramNum > 0) {
			if (paramArray[0] == NVTRET_ENTER_MENU) {
				/* Create Menu window */
				gMovData.State = MOV_ST_MENU;
				Ux_OpenWindow(&MenuCommonItemCtrl, 0);
				return NVTEVT_CONSUME;
			}
		}
		gMovData.State = MOV_ST_VIEW;
		break;

	case MOV_ST_MENU:
		
		// disable shutter2 sound
		uiSoundMask = Input_GetKeySoundMask(KEY_PRESS);
		uiSoundMask &= ~FLGKEY_ENTER;
		Input_SetKeySoundMask(KEY_PRESS, uiSoundMask);

		g_uiMaskKeyPress = MOVIE_KEY_PRESS_MASK;
		g_uiMaskKeyRelease = MOVIE_KEY_RELEASE_MASK;
		Input_SetKeyMask(KEY_PRESS, g_uiMaskKeyPress);
		Input_SetKeyMask(KEY_RELEASE, g_uiMaskKeyRelease);
		FlowMovie_UpdateIcons(TRUE);
		CHKPNT;
		// start timer again when exiting menu
		if (gUIMotionDetTimerID == NULL_TIMER) {
			gUIMotionDetTimerID = GxTimer_StartTimer(TIMER_HALF_SEC, NVTEVT_05SEC_TIMER, CONTINUE);
		}

		if (g_uiDateTimerID == NULL_TIMER) {
			g_uiDateTimerID = GxTimer_StartTimer(TIMER_ONE_SEC, NVTEVT_1SEC_TIMER, CONTINUE);
		}

		if (g_UILCAAlarmTimerID == NULL_TIMER) {
			g_UILCAAlarmTimerID = GxTimer_StartTimer(TIMER_LCA_SEC, NVTEVT_LCA_ALARM_TIMER, CONTINUE);
		}

		// Enable Motion Detect function in starting up movie mode
		if (SysGetFlag(FL_MOVIE_MOTION_DET) == MOVIE_MOTIONDET_ON) {
			g_uiRecordIngMotionDet = TRUE;
		} else {
			g_uiRecordIngMotionDet = FALSE;
		}

		gMovData.State = MOV_ST_VIEW;
		break;
	
	case MOV_ST_VIEW:
        
    if (isStopREC )// && paramArray[0] == NVTRET_WAITMOMENT ) 
	{
		CHKPNT;
		isStopREC = FALSE;
		if (gUIMotionDetTimerID != NULL_TIMER) {
			GxTimer_StopTimer(&gUIMotionDetTimerID);
		}

		if (g_uiDateTimerID != NULL_TIMER) {
			GxTimer_StopTimer(&g_uiDateTimerID);
		}

		if (g_UIStopRecTimerID != NULL_TIMER) {
			GxTimer_StopTimer(&g_UIStopRecTimerID);
		}

		if (g_UILCAAlarmTimerID != NULL_TIMER) {
			GxTimer_StopTimer(&g_UILCAAlarmTimerID);
		}
		//if(bSDFormat == FALSE)
			CHKPNT;
			Ux_SendEvent(0, NVTEVT_SYSTEM_MODE, 1, PRIMARY_MODE_PLAYMENU);
		//else
		//	return NVTEVT_CONSUME;
	}
		if (paramNum > 0) {
			CHKPNT;
			if ((paramNum == 2) && (paramArray[0] == NVTRET_WAITMOMENT)) {
				if (paramArray[1] == NVTRET_RESTART_REC) {
					CHKPNT;
#if defined(_KEY_METHOD_4KEY_)
CHKPNT;
					Ux_PostEvent(NVTEVT_KEY_SHUTTER2, 1, NVTEVT_KEY_PRESS);
#else
					Ux_PostEvent(NVTEVT_KEY_SELECT, 1, NVTEVT_KEY_PRESS);
#endif
            	} else {
            	CHKPNT;
					FlowMovie_UpdateIcons(TRUE);
				}
			}
		}else{
		CHKPNT;
			FlowMovie_UpdateIcons(TRUE);
		}
		break;
		default:
		//	 CHKPNT;
       		 if(PlayMenu_Close){
			 	CHKPNT;
           		 PlayMenu_Close = 0;
            		Ux_PostEvent(NVTEVT_KEY_MODE, 1, NVTEVT_KEY_PRESS);
          
        	}
			   break;
	}
	DBGD(gMovData.State);
	//#NT#2018/08/10#KCHong -begin
	//#NT#Fixed Jira NA51000-1230
	if (gMovData.State == MOV_ST_VIEW || gMovData.State == MOV_ST_REC) {
		CHKPNT;
		FlowMovie_UpdateIcons(TRUE);
		if (ImageApp_MovieMulti_IsStreamRunning(_CFG_REC_ID_1)
			#if (SENSOR_CAPS_COUNT >= 2)
			|| ImageApp_MovieMulti_IsStreamRunning(_CFG_REC_ID_2)
			#endif
			) {
			gMovData.State = MOV_ST_REC;
			CHKPNT;
		} else {
			gMovData.State = MOV_ST_VIEW;
			CHKPNT;
		}
	}
	//#NT#2018/08/10#KCHong -end

#if(IS_ALPHA_TYPEFMT(DISPLAY_OSD_FMT))
	/* open VDO2 background */
	UI_Show(UI_SHOW_BACKGND, TRUE);
#endif
	if (isStopREC  && paramArray[0] == NVTRET_WAITMOMENT ) 
	{
		CHKPNT;
		isStopREC = FALSE;
		Ux_SendEvent(0, NVTEVT_SYSTEM_MODE, 1, PRIMARY_MODE_PLAYMENU);
	}
	if ( paramArray[0] == NVTRET_WAITMOMENT && isStopREC == FALSE)
	{
		if(paramArray[1] == NVTEVT_RELEASE){
			if(UxCtrl_IsShow(&UIFlowWndMovie_Panel_OperateCtrl)){
				//UxCtrl_SetShow(&UIFlowWndMovie_Panel_OperateCtrl, FALSE);
				FocusOperate =FALSE;
			}else{
				FocusOperate =TRUE;
			}
			goto WaitMomemt_Release;
		}
		
		CHKPNT;
		// disable shutter2 sound
		uiSoundMask = Input_GetKeySoundMask(KEY_PRESS);
		uiSoundMask &= ~FLGKEY_ENTER;
		Input_SetKeySoundMask(KEY_PRESS, uiSoundMask);

		g_uiMaskKeyPress = MOVIE_KEY_PRESS_MASK;
		g_uiMaskKeyRelease = MOVIE_KEY_RELEASE_MASK;
		Input_SetKeyMask(KEY_PRESS, g_uiMaskKeyPress);
		Input_SetKeyMask(KEY_RELEASE, g_uiMaskKeyRelease);
		Input_SetKeyMask(KEY_CONTINUE, g_uiMaskKeyPress);
		FlowMovie_UpdateIcons(TRUE);

		// start timer again when exiting menu
		if (gUIMotionDetTimerID == NULL_TIMER) {
			gUIMotionDetTimerID = GxTimer_StartTimer(TIMER_HALF_SEC, NVTEVT_05SEC_TIMER, CONTINUE);
		}

		if (g_uiDateTimerID == NULL_TIMER) {
			g_uiDateTimerID = GxTimer_StartTimer(TIMER_ONE_SEC, NVTEVT_1SEC_TIMER, CONTINUE);
		}

		if (g_UILCAAlarmTimerID == NULL_TIMER) {
			g_UILCAAlarmTimerID = GxTimer_StartTimer(TIMER_LCA_SEC, NVTEVT_LCA_ALARM_TIMER, CONTINUE);
		}

		// Enable Motion Detect function in starting up movie mode
		if (SysGetFlag(FL_MOVIE_MOTION_DET) == MOVIE_MOTIONDET_ON) {
			g_uiRecordIngMotionDet = TRUE;
		} else {
			g_uiRecordIngMotionDet = FALSE;
		}

		gMovData.State = MOV_ST_VIEW;
		
	}

WaitMomemt_Release:
		CHKPNT;

	if (gUIMotionDetTimerID == NULL_TIMER) {
		gUIMotionDetTimerID = GxTimer_StartTimer(TIMER_HALF_SEC, NVTEVT_05SEC_TIMER, CONTINUE);
	}

	if (g_uiDateTimerID == NULL_TIMER) {
		g_uiDateTimerID = GxTimer_StartTimer(TIMER_ONE_SEC, NVTEVT_1SEC_TIMER, CONTINUE);
	}


	if (g_UILCAAlarmTimerID == NULL_TIMER) {
		g_UILCAAlarmTimerID = GxTimer_StartTimer(TIMER_LCA_SEC, NVTEVT_LCA_ALARM_TIMER, CONTINUE);
	}
	FlowMovie_IconHideBackLightLvl_Panel();
	FlowMovie_IconHideBehindProgressBar();
	Ux_DefaultEvent(pCtrl, NVTEVT_CHILD_CLOSE, paramNum, paramArray);
	return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnKeyShutter2(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{CHKPNT;
	return UIFlowWndMovie_OnExeRecord(pCtrl, paramNum, paramArray);
}
INT32 UIFlowWndMovie_OnKeyZoomin(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	return UIFlowWndMovie_OnExeZoomIn(pCtrl, paramNum, paramArray);
}
INT32 UIFlowWndMovie_OnKeyZoomout(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	return UIFlowWndMovie_OnExeZoomOut(pCtrl, paramNum, paramArray);
}
INT32 UIFlowWndMovie_OnKeyUp(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	if (System_GetState(SYS_STATE_CURRMODE) != PRIMARY_MODE_MOVIE) {
		return NVTEVT_CONSUME;
	}

	switch (gMovData.State) {
		case MOV_ST_REC:
		case MOV_ST_REC|MOV_ST_ZOOM: 
			{  
				if (ImageApp_MovieMulti_IsStreamRunning(_CFG_REC_ID_1) ||
					ImageApp_MovieMulti_IsStreamRunning(_CFG_REC_ID_2) ) {
					if(FlowMovie_GetCurrRecTotalTime() > 3)
					{
						GxSound_WaitStop();
						UISound_Play(DEMOSOUND_SOUND_SHUTTER_TONE);
						Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_MOVIE_REC_RAWENC, 0);
					}
				} 
			}
			break;
			
		case MOV_ST_VIEW:
		case MOV_ST_VIEW|MOV_ST_ZOOM:
			{
				if (SysGetFlag(FL_MOVIE_AUDIO) == MOVIE_AUDIO_ON)
				{
					SysSetFlag(FL_MOVIE_AUDIO,MOVIE_AUDIO_OFF);
					GxSound_WaitStop();
					UISound_Play(DEMOSOUND_SOUND_AUDIO_OFF_TONE);
				}
				else
				{
					SysSetFlag(FL_MOVIE_AUDIO,MOVIE_AUDIO_ON);
					GxSound_WaitStop();
					UISound_Play(DEMOSOUND_SOUND_AUDIO_ON_TONE);
				}
			}
			break;
			
		default:
			break;
	}

	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_OnKeyPlayBack(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{

	// Don't stop movie recording
	switch (gMovData.State) {
	case MOV_ST_VIEW:
	case MOV_ST_VIEW|MOV_ST_ZOOM:
		// mask key while changing primary mode
		Ux_FlushEventByRange(NVTEVT_KEY_EVT_START, NVTEVT_KEY_EVT_END);

		Input_SetKeyMask(KEY_PRESS, FLGKEY_KEY_MASK_NULL);
		Input_SetKeyMask(KEY_RELEASE, FLGKEY_KEY_MASK_NULL);
		Input_SetKeyMask(KEY_CONTINUE, FLGKEY_KEY_MASK_NULL);
		// changing primary mode
		Ux_SendEvent(&UISetupObjCtrl, NVTEVT_FORCETO_PLAYBACK_MODE, 0);
		break;
	}

	return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnBattery(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    //#MT#lyb -20200317 -begin
    #if 0
	static volatile BOOL bBatteryOn = FALSE;

	UxState_SetData(&UIFlowWndMovie_Status_batteryCtrl, STATE_CURITEM, GetBatteryLevel());
	if (KeyScan_IsACIn()) {
		bBatteryOn = !bBatteryOn;
		UxCtrl_SetShow(&UIFlowWndMovie_Status_batteryCtrl, bBatteryOn);
	} else {
		UxCtrl_SetShow(&UIFlowWndMovie_Status_batteryCtrl, TRUE);
	}
    #endif
    //#MT#lyb -20200317 -end

	return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnBatteryLow(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	Ux_OpenWindow(&UIFlowWndWrnMsgCtrl, 2, UIFlowWndWrnMsg_StatusTXT_Msg_STRID_BATTERY_LOW, FLOWWRNMSG_TIMER_2SEC);
	return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnKeyMode(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	// Don't stop movie recording
	switch (gMovData.State) {
	case MOV_ST_VIEW:
	case MOV_ST_VIEW|MOV_ST_ZOOM:
		// mask key while changing primary mode
		Ux_FlushEventByRange(NVTEVT_KEY_EVT_START, NVTEVT_KEY_EVT_END);
		Input_SetKeyMask(KEY_PRESS, FLGKEY_KEY_MASK_NULL);
		Input_SetKeyMask(KEY_RELEASE, FLGKEY_KEY_MASK_NULL);
		Input_SetKeyMask(KEY_CONTINUE, FLGKEY_KEY_MASK_NULL);
		// changing primary mode
		CHKPNT;
//		Ux_SendEvent(&UISetupObjCtrl, NVTEVT_EXE_CHANGEDSCMODE, 1, DSCMODE_CHGTO_NEXT);
		Ux_SendEvent(&UISetupObjCtrl, NVTEVT_FORCETO_PLAYBACK_MODE, 0);
		break;

	}
	return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnMovieFinish(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	UINT32  uiFolderId = 0, uiFileId = 0;
	BOOL    CheckStorageErr;
	//UINT32  gUIAviRecMaxTime;
	CHKPNT;
	DBGD(gMovData.State);
	switch (gMovData.State) {
	case MOV_ST_REC:
	case MOV_ST_REC|MOV_ST_ZOOM:

		//#NT#2016/09/20#Bob Huang -begin
		//#NT#Support HDMI Display with 3DNR Out
		//call stop rec first before starting to rec, keep rec mode
#if (_3DNROUT_FUNC == ENABLE)
		if (!gb3DNROut)
#endif
//#NT#2016/09/20#Bob Huang -end
		{
			//gMovData.State = MOV_ST_VIEW;
		}

		//#NT#2012/10/23#Philex Lin - begin
		// enable auto power off/USB detect timer
		KeyScan_EnableMisc(TRUE);
		//#NT#2012/10/23#Philex Lin - end
		//FlowMovie_IconDrawMaxRecTime(&UIFlowWndMovie_Static_maxtimeCtrl);
		UxState_SetData(&UIFlowWndMovie_Status_RECCtrl, STATE_CURITEM, UIFlowWndMovie_Status_REC_ICON_REC_TRANSPAENT);

		//if (FlowMovie_ChkDrawStoreFullFolderFull() == FALSE)
		if (SysGetFlag(FL_MOVIE_CYCLIC_REC) == MOVIE_CYCLICREC_OFF) {
			CheckStorageErr = FlowMovie_IsStorageErr(TRUE);CHKPNT;
		} else {
			CheckStorageErr = FlowMovie_IsStorageErr(FALSE);CHKPNT;
		}
		if (CheckStorageErr == FALSE) {
			DCF_GetNextID(&uiFolderId, &uiFileId);
			SysSetFlag(FL_DCF_DIR_ID, uiFolderId);
			SysSetFlag(FL_DCF_FILE_ID, uiFileId);

			//#NT#2016/03/07#KCHong -begin
			//#NT#Low power timelapse function
#if (TIMELAPSE_LPR_FUNCTION == ENABLE)
			if (UI_GetData(FL_MOVIE_TIMELAPSE_REC) < TL_LPR_TIME_MIN_PERIOD)
#endif
//#NT#2016/03/07#KCHong -end
			FlowMovie_UpdateIcons(TRUE);
			Input_SetKeyMask(KEY_PRESS, MOVIE_KEY_PRESS_MASK);
		}
		break;

	//The flow here may be only for APC3 stop record than lock file function.
	//To be careful that gMovData have changed in UIFlowMovie_Stop.
	case MOV_ST_VIEW:
		// Enable key if user pressed shutter2 key to stop recording.
		Input_SetKeyMask(KEY_PRESS, MOVIE_KEY_PRESS_MASK);
		break;
	}

	return NVTEVT_CONSUME;
}
static void Fun_UpdateRecIcon(void)
{
	switch (gMovData.State) {
	case MOV_ST_REC:
	case MOV_ST_REC|MOV_ST_ZOOM:

			if (UxState_GetData(&UIFlowWndMovie_Status_RECCtrl, STATE_CURITEM) == UIFlowWndMovie_Status_REC_ICON_REC_TRANSPAENT) {
				UxState_SetData(&UIFlowWndMovie_Status_RECCtrl, STATE_CURITEM, UIFlowWndMovie_Status_REC_ICON_REC_ELLIPSE);
			} else {
				UxState_SetData(&UIFlowWndMovie_Status_RECCtrl, STATE_CURITEM, UIFlowWndMovie_Status_REC_ICON_REC_TRANSPAENT);
			}

	//    
		 if( ( EthCamNet_GetEthLinkStatus(0) == ETHCAM_LINK_UP && (EthDisconRebootcnt <= 3)))
		 	//socketCliEthData1_IsRecv(ETHCAM_PATH_ID_1 ) )  && bflag_EthLinkFinish )
		 { 
		 	//CHKPNT;
			UxState_SetData(&UIFlowWndMovie_StatusTextCtrl, STATE_CURITEM, UIFlowWndMovie_StatusText_STRID_DUAL_1920P30);
			UxState_SetData(& UIFlowWndMovie_Status_Movie_BCtrl, STATE_CURITEM, UIFlowWndMovie_Status_Movie_B_ICON_TOP_BACK);
		 }
		 /* move to movie_ontimer func halftime 
		 else if(EthCamNet_GetEthLinkStatus(0) == ETHCAM_LINK_DOWN || (EthDisconRebootcnt > 3))
		 //bflag_EthLinkFinish == FALSE || (!socketCliEthData1_IsRecv(ETHCAM_PATH_ID_1 ) ) )
		 {
			//CHKPNT;
			UxState_SetData(&UIFlowWndMovie_StatusTextCtrl, STATE_CURITEM, UIFlowWndMovie_StatusText_STRID_1920P30);
			UxState_SetData(& UIFlowWndMovie_Status_Movie_BCtrl, STATE_CURITEM, UIFlowWndMovie_Status_Movie_B_ICON_TOP_BACK_OFF);
		 }*/
	 
			//FlowMovie_IconHideMaxRecTime(&UIFlowWndMovie_Static_maxtimeCtrl);
			//cancle this function cj 0702
			//FlowMovie_IconDrawRecTime(&UIFlowWndMovie_Static_RecTxtCtrl);
	
		}
}

INT32 UIFlowWndMovie_OnMovieOneSec(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
//debug_msg("cj %d %d\r\n",paramNum,paramArray[0]);
	switch (gMovData.State) {
	case MOV_ST_REC:
	case MOV_ST_REC|MOV_ST_ZOOM:
		  
	if (paramNum) {
		FlowMovie_SetRecCurrTime(paramArray[0]);
		FlowMovie_SetCurrRecTotalTime(TRUE);
		}
		//FlowMovie_IconDrawRecTime(&UIFlowWndMovie_Static_RecTxtCtrl);
        /*
		if (UxCtrl_IsShow(&UIFlowWndMovie_StaticIcon_PIMCCtrl)) {
			FlowMovie_DrawPIM(FALSE);
		}
        */
		break;
	}
	FlowMovie_OnTimer1SecIndex();
	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_OnMovieFull(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	return UIFlowWndMovie_OnLoopRecFull(pCtrl, paramNum, paramArray);
}

INT32 UIFlowWndMovie_OnMovieWrError(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	if ((gMovData.State == MOV_ST_REC) || (gMovData.State == (MOV_ST_REC | MOV_ST_ZOOM))) {
		FlowMovie_StopRec();
		if (System_GetState(SYS_STATE_CARD)  == CARD_LOCKED) {
			gMovData.State = MOV_ST_WARNING_MENU;
			Ux_OpenWindow(&UIFlowWndWrnMsgCtrl, 2, UIFlowWndWrnMsg_StatusTXT_Msg_STRID_CARD_LOCKED, FLOWWRNMSG_TIMER_3SEC);
			return NVTEVT_CONSUME;
		} else {
			gMovData.State = MOV_ST_WARNING_MENU;
			Ux_OpenWindow(&UIFlowWndWrnMsgCtrl, 2, FLOWWRNMSG_ISSUE_CARD_ERR, FLOWWRNMSG_TIMER_3SEC);CHKPNT;
			return NVTEVT_CONSUME;
		}
	} else {
		Input_SetKeyMask(KEY_PRESS, MOVIE_KEY_PRESS_MASK);
	}
	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_OnStorageSlow(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	// trigger re-start encoding
/*	
#if 0
	return UIFlowWndMovie_OnExeRecord(pCtrl, 3, NVTEVT_KEY_PRESS, 0, UIFlowWndMovie_Restart_Rec);
#else
//#NT#2015/11/24#KS Hung -begin
//#NT#SMediaRec and FileSys have new method for slow card
//Movie_SetSDSlow(TRUE);
#if _TODO
	MovRec_EnableOverlap(FALSE);
#endif
//#NT#2015/11/24#KS Hung -end
#if defined(_KEY_METHOD_4KEY_)
CHKPNT;
	Ux_PostEvent(NVTEVT_KEY_SHUTTER2, 3, NVTEVT_KEY_PRESS, 0, UIFlowWndMovie_Restart_Rec);
#else
	Ux_PostEvent(NVTEVT_KEY_SELECT, 3, NVTEVT_KEY_PRESS, 0, UIFlowWndMovie_Restart_Rec);
#endif
	return NVTEVT_CONSUME;
#endif*/
	CHKPNT;
    FlowMovie_StopRec();
    //KeyScan_EnableMisc(TRUE);
    //g_PreviewStable_Record = TRUE;
	//UIFlowWndMovie_SetRecLockStatus(FALSE);
    FlowMovie_SetRecCurrTime(0);
	gMovData.State = MOV_ST_REC;
	FlowMovie_StartRec();
	CloseTimer();
	Ux_OpenWindow(&UIFlowWndWaitMomentCtrl,1,UIFlowWndWaitMoment_StatusTXT_Msg_STRID_SLOW_CARD);
    //CHKPNT;
    return NVTEVT_CONSUME;
    
}

INT32 UIFlowWndMovie_OnLoopRecFull(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	FlowMovie_StopRec();
	KeyScan_EnableMisc(TRUE);
	//gMovData.State = MOV_ST_VIEW;
	gMovData.State = MOV_ST_WARNING_MENU;
	Ux_OpenWindow(&UIFlowWndWrnMsgCtrl, 2, UIFlowWndWrnMsg_StatusTXT_Msg_STRID_CARD_FULL, FLOWWRNMSG_TIMER_2SEC);
	//FlowMovie_IconDrawMaxRecTime(&UIFlowWndMovie_Static_maxtimeCtrl);
	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_OnEMRCompleted(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
#if (__DBGLVL__ >= 6)
	UINT32  uiPathId = 0;

	if (paramNum)
	{
		uiPathId = paramArray[0];
	}

	DBG_IND("EMR(%d) completed!\r\n", uiPathId);
#endif
	
	if((paramNum == 2)&&(paramArray[1] == MOVIE_USER_CB_EVENT_EMR_FILE_COMPLETED))
	{
		UIFlowWndMovie_SetRecLockStatus(FALSE);
		DBG_IND("EMR(%d) completed!\r\n", uiPathId);
		//UIFlowWndMovie_SetCurrentSecVideoStatus(FALSE);
	}
	else if((paramNum == 2)&&(paramArray[1] == MOVIE_USER_CB_EVENT_CARSH_FILE_COMPLETED))
	{
				UIFlowWndMovie_SetRecLockStatus(FALSE);

		DBG_IND("Crash (%d) completed!\r\n", uiPathId);
	}

	return NVTEVT_CONSUME;
}

#if 0
INT32 UIFlowWndMovie_OnPreviewStable(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	ide_enable_video(IDE_VIDEOID_1);
	switch (gMovData.State) {
	case MOV_ST_VIEW:
		FlowMovie_UpdateIcons(TRUE);
		break;
	}
	return NVTEVT_CONSUME;
}
#endif

INT32 UIFlowWndMovie_OnStorageInit(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
#if (CALIBRATION_FUNC == ENABLE)
		// check if enter engineer mode
		if (EngineerMode_CheckEng())
		{
			//cal_system_init();
			//#NT#2016/06/23#Niven Cho -begin
			//#NT#Enter calibration by cgi event or command event
			Ux_PostEvent(NVTEVT_KEY_CALIBRATION, 0);
			//#NT#2016/06/23#Niven Cho -end
		}
#endif
//#NT#2016/03/02#Niven Cho -begin
//#NT#Fix FAST_BOOT + LINUX + without card, boot failed.
#if defined(_CPU2_LINUX_)
	if (UIStorageCheck(STORAGE_CHECK_ERROR, NULL) == TRUE) {
		Ux_OpenWindow(&UIFlowWndWrnMsgCtrl, 2, UIFlowWndWrnMsg_StatusTXT_Msg_STRID_PLEASE_INSERT_SD, FLOWWRNMSG_TIMER_3SEC);
	}
#endif
//#NT#2016/03/02#Niven Cho -end
	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_OnOZoomStepChange(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_OnDZoomStepChange(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	//FlowMovie_IconDrawDZoom(&UIFlowWndMovie_Zoom_StaticCtrl);
	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_OnPreviewStable(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	UINT32 uiEvent;
	if (paramNum > 0) {
		uiEvent = paramArray[0];
		if (uiEvent != NVTEVT_ALGMSG_PREVIEW_STABLE) {
			return NVTEVT_CONSUME;
		}
	} else {
		return NVTEVT_CONSUME;
	}
	switch (gMovData.State) {
	case MOV_ST_VIEW:
		//#NT#2016/03/07#KCHong -begin
		//#NT#Low power timelapse function
#if (TIMELAPSE_LPR_FUNCTION == ENABLE)
		if (UI_GetData(FL_MOVIE_TIMELAPSE_REC) < TL_LPR_TIME_MIN_PERIOD)
#endif
//#NT#2016/03/07#KCHong -end
			FlowMovie_UpdateIcons(TRUE);
		break;
	}

	g_PreviewStable = TRUE;
	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_OnStorageChange(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	FlowMovie_UpdateIcons(TRUE);

	Input_SetKeyMask(KEY_PRESS, g_uiMaskKeyPress);
	Input_SetKeyMask(KEY_PRESS, g_uiMaskKeyRelease);

#if (SDHOTPLUG_FUNCTION == ENABLE)
	Ux_PostEvent(NVTEVT_SYSTEM_MODE, 1, System_GetState(SYS_STATE_CURRMODE));
#endif

	return NVTEVT_CONSUME;
}

#if (GPS_FUNCTION == ENABLE)
inline static void  UIFlowWndMovie_UpdateSpeedData(void)
{
	RMCINFO RMCInfo;

	GPSRec_GetRMCDate(&RMCInfo);
#if (LOG_DBGINFO_IN_GPS_SECTION == ENABLE)
	mp4log_AddLog(0, (char *)&RMCInfo, sizeof(RMCINFO));
#else   // #if (LOG_DBGINFO_IN_GPS_SECTION == ENABLE)
	memcpy(&(gpsdata.rmcinfo), &RMCInfo, sizeof(RMCINFO));
#endif  // #if (LOG_DBGINFO_IN_GPS_SECTION == ENABLE)

#if 0
	debug_msg("lati:%1f, NS:%c, longi:%1f,EW:%c\r\n", gpsdata.rmcinfo.Latitude, gpsdata.rmcinfo.NSInd, gpsdata.rmcinfo.Longitude, gpsdata.rmcinfo.EWInd);
#endif
}
#endif

static void UIFlowWndMovie_OnMotionDetect(void)
{
	static UINT32  uiMotionDetGo = 0;
	static UINT32  uiMotionDetStop = 0;

	//#NT#2016/11/01#Adam Su -begin
	//#NT#fix mantis issue 0106933
	static BOOL    bMotionDetRec = FALSE; // TRUE: trigger record by MD
	//#NT#2016/11/01#Adam Su -end

	//#NT#2016/10/18#Jeah Yen -begin
	//#NT#move code to support sensor map
	static UINT32  uiMotionDetRet = 0;
	Ux_SendEvent(0, NVTEVT_EXE_MOTION_DET_RUN, 1, (UINT32)&uiMotionDetRet);
	if (uiMotionDetRet == TRUE)
		//#NT#2016/10/18#Jeah Yen -end
	{
		uiMotionDetGo++;
		if (uiMotionDetGo >= 2) {
			uiMotionDetStop = 0;
			// Recording of modtion detection in pure CarDV path
			if (!((gMovData.State == MOV_ST_REC) || (gMovData.State == (MOV_ST_REC | MOV_ST_ZOOM)))) {
				// reset uiMotionDetGo
				uiMotionDetGo = 0;
				//#NT#2016/11/01#Adam Su -begin
				//#NT#fix mantis issue 0106933
				bMotionDetRec = TRUE;
				//#NT#2016/11/01#Adam Su -end
				// press key to record video
#if defined(_KEY_METHOD_4KEY_)
CHKPNT;
				Ux_PostEvent(NVTEVT_KEY_SHUTTER2, 1, NVTEVT_KEY_PRESS);
#else
				Ux_PostEvent(NVTEVT_KEY_SELECT, 1, NVTEVT_KEY_PRESS);
#endif
			}
		}
	} else {
//#NT#2016/11/01#Adam Su -begin
//#NT#fix mantis issue 0106933
		if (bMotionDetRec == TRUE) {
			uiMotionDetStop++;
			if (uiMotionDetStop >= 2) { // 1 sec
				uiMotionDetGo = 0;
			}
			if (uiMotionDetStop >= 20) { // 10 Sec
				uiMotionDetStop = 0;
				if (FlowMovie_GetRecCurrTime() >= 1) {
// CardDV path
					if (gMovData.State == MOV_ST_REC || gMovData.State == (MOV_ST_REC | MOV_ST_ZOOM)) {
						FlowMovie_StopRec();
						// update ui window icon
						FlowMovie_UpdateIcons(TRUE);
						bMotionDetRec = FALSE;
					}
				}
			}
		}
//#NT#2016/11/01#Adam Su -end
	}
}

static BOOL bFocusBackLightAdj = FALSE;
static INT32 iTouchBLAdjHoldPointInit = 0;
static INT32 iTouchBLAdjHoldPointCur = 0;
static INT32 iTouchBLAdjHoldPointPrev = 0;
static UINT32 uiIgnoreTimerID = NULL_TIMER;

#if (AV_LCA_FUNC == ENABLE)
#include "EthCamAppSocket.h"
#include "EthCamAppCmd.h"
#endif

//static BOOL AutoREC =FALSE;

//#MT#lyb -20200415 -begin
#if (ETHCAM_TX_UPDATE_TEST == ENABLE)

#if (defined(_NVT_ETHREARCAM_RX_))
#include "FileSysTsk.h"
#include "EthCamAppCmd.h"
#include "UIModeUpdFw.h"
#include "UIFlow.h"
#include "EthCamAppSocket.h"
#include "EthCamSocket.h"

static BOOL Ethcam_tx_fwupdate(void)
{
	UINT32 uiFwAddr, uiFwSize;
	FST_FILE hFile;
	static char uiUpdateFWName[64] ="A:\\FW671_AA.bin" ;//"FW671_AA";// "A:\\EthcamTxFW.bin";
	INT32 fst_er;
	UINT32 EthCamCmdRET=0;

    BOOL bRet = FALSE;
	Ux_CloseWindow(&UIFlowWndWaitMomentCtrl, 0);
CHKPNT;
	CloseTimer();
	Ux_OpenWindow(&UIFlowWndWaitMomentCtrl, 1, UIFlowWndWaitMoment_StatusTXT_Msg_STRID_ETHCAM_UDFW_SENDFW);

    
	EthCam_SendXMLCmd(ETHCAM_PATH_ID_1, ETHCAM_PORT_DATA1 ,ETHCAM_CMD_TX_STREAM_STOP, 0);
#if (ETH_REARCAM_CLONE_FOR_DISPLAY == ENABLE)
	EthCam_SendXMLCmd(ETHCAM_PATH_ID_1, ETHCAM_PORT_DATA2 ,ETHCAM_CMD_TX_STREAM_STOP, 0);
#endif
	Delay_DelayMs(500);  

	System_ChangeSubMode(SYS_SUBMODE_UPDFW);
	Ux_SendEvent(0, NVTEVT_SYSTEM_MODE, 1, PRIMARY_MODE_UPDFW);
	
	uiFwSize = (UINT32)FileSys_GetFileLen(uiUpdateFWName);
	uiFwAddr = OS_GetMempoolAddr(POOL_ID_APP);

	hFile = FileSys_OpenFile(uiUpdateFWName, FST_OPEN_READ);
	if (hFile != 0) {
		fst_er = FileSys_ReadFile(hFile, (UINT8 *)uiFwAddr, &uiFwSize, 0, NULL);
		FileSys_CloseFile(hFile);
		if (fst_er != FST_STA_OK) {
			DBG_ERR("FW bin read fail\r\n");
			//return TRUE;
			bRet = FALSE;
            return bRet;
		}
	}
	DBG_DUMP("Total FwSize=%d\r\n",uiFwSize);
	

	EthCamSocketCli_SetCmdSendSizeCB(ETHCAM_PATH_ID_1, (UINT32)&socketCliEthCmd_SendSizeCB);
	EthCam_SendXMLCmd(ETHCAM_PATH_ID_1, ETHCAM_PORT_DEFAULT ,ETHCAM_CMD_TX_FWUPDATE_FWSEND, uiFwSize);
	EthCamCmdRET=EthCam_SendXMLData(ETHCAM_PATH_ID_1, (UINT8 *)uiFwAddr, uiFwSize);
	EthCamSocketCli_SetCmdSendSizeCB(ETHCAM_PATH_ID_1, 0);
	/*

	if(EthCamCmdRET==ETHCAM_RET_OK){
        bRet = TRUE;
		DBG_DUMP("Send FW update  Start\r\n");
		EthCam_SendXMLCmd(ETHCAM_PATH_ID_1, ETHCAM_PORT_DEFAULT ,ETHCAM_CMD_TX_FWUPDATE_START, 0);
	}else{
        bRet = FALSE;
		DBG_ERR("FW send error, %d\r\n",EthCamCmdRET);
	}

	Ux_CloseWindow(&UIFlowWndWaitMomentCtrl, 0);//0616
	*/
	//Ux_OpenWindow(&UIFlowWndWaitMomentCtrl, 1, UIFlowWndWaitMoment_StatusTXT_Msg_STRID_ETHCAM_UDFW_START);
//	FileSys_DeleteFile("A:\\EthcamTxFW.bin");//MT CJ 2020/420  mv to EthCamAppNetwork.c
	return bRet;
}

//static 
BOOL Ethcam_tx_DetFwAutoUpdate(void)
{
    FST_FILE filehdl;
    BOOL bRet = FALSE;

    FileSys_WaitFinish();
    filehdl = FileSys_OpenFile("A:\\FW671_AA.bin",FST_OPEN_READ);
    if(filehdl == NULL)
    {
        TESTLOG("txupdate  fail, no update file");
        debug_msg("mmmmm not del update FW\r\n");
    }
    else
    {
    	if ( gMovData.State == MOV_ST_REC )
        {
			FlowMovie_StopRec();
		}
       // TESTLOG("txupdate");
        FileSys_CloseFile(filehdl);
	    CHKPNT;
		CloseTimer();
		Ux_OpenWindow(&UIFlowWndWaitMomentCtrl, 1, UIFlowWndWaitMoment_StatusTXT_Msg_STRID_ETHCAM_UDFW_SENDFW);
		Delay_DelayMs(200);
        bRet = Ethcam_tx_fwupdate();
    }
    return bRet;
}
#endif
#endif
//#MT#lyb -20200415 -end
extern void System_UpdateTx(void);
extern BOOL bGetTxFirmware;
extern MOVIE_RECODE_FILE_OPTION gMovie_Rec_Option;
#define DISPLAY_TIME 10
BOOL Gsen_Carsta = FALSE;
UINT8 Ethcam_disconnect_cnt = 0;
BOOL EthDisconRebooting = FALSE;
BOOL testreboot = FALSE;
UINT8 testrebootcnt = 0;
#define LCA_GSENSOR_THREHOLD 10
#define LCA_GSENSOR_MAXTHREHOLD 65535/2
BOOL LCA_GSENSOR_Move = FALSE;
static UINT8 WndMovie_Delay_SaveMenuCnt = 0;
extern BOOL File_Repair_Finish;
INT32 UIFlowWndMovie_OnTimer(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	static BOOL EthDisconRebootFailed = FALSE;
	static UINT16 EthDisconWaitRebootOkcnt = 0;
	//#NT#2016/03/07#KCHong -begin
	//#NT#Low power timelapse function
#if (TIMELAPSE_LPR_FUNCTION == ENABLE)
	UINT32 TLRet = 0;
	static UINT32 Cnt = 0;
#endif
//#NT#2016/03/07#KCHong -end
      
#if (GPS_FUNCTION == ENABLE)
	static UINT32 GPSHeartBeatPrev = 0, GPSHeartBeatNow = 0;
#endif
	UINT32  uiEvent;
	uiEvent = paramNum ? paramArray[0] : 0;
	switch (uiEvent) {
		case NVTEVT_IGNORE_SLIDE_TOUCH_TIMER:
			bFocusBackLightAdj = FALSE;
            GxTimer_StopTimer(&uiIgnoreTimerID);
			break;
    	case NVTEVT_01SEC_TIMER:
		//	debug_msg(" --cj g_uiRecStopTimerCnt:%d ",g_uiRecStopTimerCnt);
        	if(g_uiRecStopTimerCnt){
        	    g_uiRecStopTimerCnt--;
        	    if(g_uiRecStopTimerCnt==0){
        	        if (g_UIStopRecTimerID != NULL_TIMER) {
                		GxTimer_StopTimer(&g_UIStopRecTimerID);
        	        }
					CHKPNT;
        	    //    Ux_OpenWindow(&UIFlowWndWaitMomentCtrl, 1, UIFlowWndWaitMoment_StatusTXT_Msg_STRID_STOPREC_WAIT);
        	        break;
        	    }
        	}
    	    break;
	case NVTEVT_05SEC_TIMER:
    
//#NT#2016/03/07#KCHong -begin
//#NT#Low power timelapse function
#if (TIMELAPSE_LPR_FUNCTION == ENABLE)
		TLRet = MovieTLLPR_Process(TIMELAPSE_FROM_TIMER);
		if ((TLRet & TL_FLOW_MASK) == TL_FLOW_LPR) {
			if ((TLRet & TL_STATE_MASK) == TL_STATE_RECORD) {
// flash REC icon one time to indicate capturing
				if (UxState_GetData(&UIFlowWndMovie_Status_RECCtrl, STATE_CURITEM) == UIFlowWndMovie_Status_REC_ICON_REC_TRANSPAENT) {
					Cnt ++;
				}

				if (Cnt == 2) {
					Cnt = 0;
					UxState_SetData(&UIFlowWndMovie_Status_RECCtrl, STATE_CURITEM, UIFlowWndMovie_Status_REC_ICON_REC_ELLIPSE);
				}
				//FlowMovie_IconHideMaxRecTime(&UIFlowWndMovie_Static_maxtimeCtrl);
				//FlowMovie_IconDrawRecTime(&UIFlowWndMovie_Static_timeCtrl);
			} else {
				UxState_SetData(&UIFlowWndMovie_Status_RECCtrl, STATE_CURITEM, UIFlowWndMovie_Status_REC_ICON_REC_TRANSPAENT);
				//FlowMovie_IconDrawMaxRecTime(&UIFlowWndMovie_Static_maxtimeCtrl);
			}
		}
#endif
//#NT#2016/03/07#KCHong -end

#if 0// (AUTO_WIFI==ENABLE)
		{
			static BOOL autoWifi = FALSE;

			if (!autoWifi && (UI_GetData(FL_WIFI) == WIFI_ON)) {
				//#NT#2016/03/23#Isiah Chang -begin
				//#NT#add new Wi-Fi UI flow.
#if(WIFI_UI_FLOW_VER == WIFI_UI_VER_1_0)
			//	Ux_OpenWindow(&UIMenuWndWiFiWaitCtrl, 0);
#endif
//#NT#2016/03/23#Isiah Chang -end
				BKG_PostEvent(NVTEVT_BKW_WIFI_ON);
				autoWifi = TRUE;
			}
		}
#endif
	if (System_GetState(SYS_STATE_CARD)  == CARD_INSERTED){
	//	debug_msg("--cj gMovData.State:%d %d \r\n",gMovData.State,System_GetGsensorPwrOn());
		if((gMovData.State == MOV_ST_VIEW || gMovData.State == (MOV_ST_VIEW|MOV_ST_ZOOM) )&& !autoRec) {

			if(System_GetGsensorPwrOn() ) {
				if(!FlowMovie_IsStorageErr(FALSE) ) {
					Ux_PostEvent(NVTEVT_KEY_SHUTTER2, 1, NVTEVT_KEY_PRESS);
	                System_SetParkPwroffTimeCount(60);
					isEnterParkingMode =TRUE;
	            } else{
	                System_SetParkPwroffTimeCount(5);
	            }
	        } else{
	        #if (defined(_NVT_ETHREARCAM_RX_))  
				if (isStopREC)
				{
	 				; //do nothing
				}else if(EthCamNet_GetEthLinkStatus(ETHCAM_PATH_ID_1 )==ETHCAM_LINK_UP) {    
					   
					DBGD(EthDisconRebootcnt);
					if((bflag_EthLinkFinish == TRUE && socketCliEthData1_IsRecv(ETHCAM_PATH_ID_1))){
						CHKPNT;
						Ux_PostEvent(NVTEVT_KEY_SHUTTER2 , 1, NVTEVT_KEY_PRESS);
						//EthCam_SendXMLCmd(0, ETHCAM_PORT_DEFAULT ,ETHCAM_CMD_DUMP_TX_BS_INFO, 0);
						
						Ethcam_disconnect_cnt = 0;
						autoRec = TRUE;
						EthDisconRebooting = FALSE;
						EthDisconRebootcnt = 0;
					} else {
						CHKPNT;
						if(File_Repair_Finish){
							File_Repair_Finish = FALSE;
							EthDisconRebooting = TRUE;
							EthDisconRebootcnt ++;
							Ux_PostEvent(NVTEVT_SYSTEM_MODE, 1, System_GetState(SYS_STATE_CURRMODE)); // try to reboot
						}else{
							Ethcam_disconnect_cnt++;
							if((Ethcam_disconnect_cnt > 5000/TIMER_HALF_SEC) ){
								Ethcam_disconnect_cnt = 0;
								//Ux_PostEvent(NVTEVT_KEY_SHUTTER2 , 1, NVTEVT_KEY_PRESS);
								// 0:power on ethcam connect failed 
								// 3:link down while recording and reboot three times failed
								if((EthDisconRebootcnt == 0 || EthDisconRebootcnt == 3)){CHKPNT;
								
									EthDisconRebootcnt ++;
									UxState_SetData(&UIFlowWndMovie_StatusTextCtrl, STATE_CURITEM, UIFlowWndMovie_StatusText_STRID_1920P30);
									UxState_SetData(& UIFlowWndMovie_Status_Movie_BCtrl, STATE_CURITEM, UIFlowWndMovie_Status_Movie_B_ICON_TOP_BACK_OFF);
									CloseTimer();
									Ux_OpenWindow(&UIFlowWndWaitMomentCtrl, 1, UIFlowWndWaitMoment_StatusTXT_Msg_STRID_ETHCAM_DETFAIL);

								}else{CHKPNT;
									EthDisconRebooting = TRUE;
									EthDisconRebootcnt ++;
									Ux_PostEvent(NVTEVT_SYSTEM_MODE, 1, System_GetState(SYS_STATE_CURRMODE)); // try to reboot
								}
							}								
						}
					}
				} else{
					CHKPNT;
					Ux_PostEvent(NVTEVT_KEY_SHUTTER2 , 1, NVTEVT_KEY_PRESS);      
					autoRec = TRUE;
					//
					//Ux_OpenWindow(&UIFlowWndWaitMomentCtrl, 1, UIFlowWndWaitMoment_StatusTXT_Msg_STRID_ETHCAM_DETFAIL);
				}
			#endif
	        }
		}else{ // MOV_ST_REC
			if(EthCamNet_GetEthLinkStatus(ETHCAM_PATH_ID_1 ) == ETHCAM_LINK_UP) 
			{      
				//CHKPNT;
				// lose data while recording
				if((bflag_EthLinkFinish == FALSE || socketCliEthData1_IsRecv(ETHCAM_PATH_ID_1 ) == FALSE) && bGetTxFirmware == FALSE){
					CHKPNT;
					Ethcam_disconnect_cnt++;
					if((Ethcam_disconnect_cnt > 2000/TIMER_HALF_SEC) ){ //wait for data again 
						Ethcam_disconnect_cnt = 0;
						if(EthDisconRebootcnt < 3 && System_IsModeChgClose() == FALSE && EthDisconRebooting == FALSE){
							CHKPNT;
							EthDisconRebootcnt++;
							EthDisconRebooting = TRUE;
							Ux_PostEvent(NVTEVT_SYSTEM_MODE, 1, System_GetState(SYS_STATE_CURRMODE)); // try to reboot
						}
					}
				}else{ //link up && data recv
					Ethcam_disconnect_cnt = 0;
				}
			}else{ //link down
				Ethcam_disconnect_cnt++;
				if((Ethcam_disconnect_cnt > 1000/TIMER_HALF_SEC) ){ //wait for reconnect again 
					Ethcam_disconnect_cnt = 0;
					UxState_SetData(&UIFlowWndMovie_StatusTextCtrl, STATE_CURITEM, UIFlowWndMovie_StatusText_STRID_1920P30);
					UxState_SetData(& UIFlowWndMovie_Status_Movie_BCtrl, STATE_CURITEM, UIFlowWndMovie_Status_Movie_B_ICON_TOP_BACK_OFF);
				}
			}
		}
	}else{
		//Ux_OpenWindow(&UIFlowWndWrnMsgCtrl, 2, UIFlowWndWrnMsg_StatusTXT_Msg_STRID_PLEASE_INSERT_SD, FLOWWRNMSG_TIMER_2SEC);

	}
	if (isEnterParkingMode )
	{
		Ux_PostEvent(NVTEVT_KEY_CUSTOM1, 1, NVTEVT_KEY_PRESS);
	}
		//get GPS/GSensor Data
		//#NT#2013/3/20#Philex Lin-begin
#if (GPS_FUNCTION == ENABLE)
#if (LOG_DBGINFO_IN_GPS_SECTION == DISABLE)
		UIFlowWndMovie_UpdateSpeedData();
#endif  // #if (LOG_DBGINFO_IN_GPS_SECTION == DISABLE)
		g_GPSStatus = GPSRec_GetSpeed(&g_CurSpeed);
#endif  // #if (GPS_FUNCTION == ENABLE)
//#NT#2013/3/20#Philex Lin-end

		// Do Motion detect process
		if (g_uiRecordIngMotionDet == TRUE) {
			UIFlowWndMovie_OnMotionDetect();
		}
#if( defined(_NVT_ETHREARCAM_TX_) && AV_LCA_FUNC == ENABLE)

		AVLCA_VEHICLE_INFO VehicleInfo={0};
		AV_GetLCAVehicleInfo(&VehicleInfo);
		if(VehicleInfo.iVehicleNum){
			UINT8 i;
			for(i=0;i<VehicleInfo.iVehicleNum;i++){
				DBG_DUMP("VehicleNum[%d]=[%d][%d,%d,%d,%d]\r\n",VehicleInfo.iVehicleNum,i,VehicleInfo.iVehicleRect[i].x,VehicleInfo.iVehicleRect[i].y,VehicleInfo.iVehicleRect[i].w,VehicleInfo.iVehicleRect[i].h) ;
			}
		}
		AVLCA_WARNING_RESULT WarnRslt={0};
		AV_GetLCAWarnRslt(&WarnRslt);
		if(WarnRslt.LWarnStatus || WarnRslt.RWarnStatus){
			DBG_DUMP("LWarnSta=%d, RWarnSta%d\r\n",WarnRslt.LWarnStatus,WarnRslt.RWarnStatus) ;
		}
#endif
		break;

	case NVTEVT_1SEC_TIMER:

		//debug_msg("%x\r\n",123);
		//debug_msg("%X\r\n",123);
		//debug_msg("%0X\r\n",123);
		//debug_msg("%05X\r\n",123);
		//debug_msg("%-5d\r\n",123);
		//debug_msg("%-5d\r\n",123);
#if(Ethcam_PIPTestFunc == ENABLE)
		if(Ethcam_PipTest){
			if(Ethcam_PipTestCnt < 3){
				Ethcam_PipTestCnt++;
			}else{
				Ethcam_PipTestCnt = 0;
				//changepip
				if(EthCamNet_GetEthLinkStatus(0) == ETHCAM_LINK_UP) {
					if(SysGetFlag(FL_DUAL_CAM) == DUALCAM_FRONT  ) {
						CHKPNT;
						SysSetFlag(FL_DUAL_CAM,DUALCAM_BEHIND);
					}else {
						SysSetFlag(FL_DUAL_CAM,DUALCAM_FRONT);
					}
				}else{
					//CloseTimer();
					//Ux_OpenWindow(&UIFlowWndWaitMomentCtrl, 1, UIFlowWndWaitMoment_StatusTXT_Msg_STRID_ETHCAM_DETFAIL);
				}
			}
		}
#endif

		if(WndMovie_Delay_SaveMenuCnt > 5)
		{
			WndMovie_Delay_SaveMenuCnt = 0;
			Save_MenuInfo();
		}else if(WndMovie_Delay_SaveMenuCnt != 0){
			WndMovie_Delay_SaveMenuCnt ++;
		}

		if ( bFocusUrg)
		{
			FocusUrgCount ++;
			if ( FocusUrgCount == DISPLAY_TIME )
			{
				UxCtrl_SetShow(&UIFlowWndMovie_ConfirmPanelCtrl, FALSE);
			}
			bFocusUrg = FALSE;
			FocusUrgCount =0;
		}else{
			FocusUrgCount =0;
		}
		
		if (bFoucusBehindPanel)
		{
			FoucusBhindPanelCount ++;
			if (FoucusBhindPanelCount == DISPLAY_TIME)
			{
					HideBehindBar();
					FlowMovie_IconDrawDateTime();
			}
		}else{
			FoucusBhindPanelCount =0;
		}
		Fun_UpdateRecIcon();
		if( bFoucusBehindPanel)
		{
			UxCtrl_SetShow(&UIFlowWndMovie_Panel_BehindCtrl, TRUE); 
		}else{
			UxCtrl_SetShow(&UIFlowWndMovie_Panel_BehindCtrl, FALSE); 
		}
		
		if(bGetTxFirmware)//do ethcam fwupdate here
		{
		   static UINT32 uiSysTimeFwUpd = 0;
		   uiSysTimeFwUpd ++;
		   if(uiSysTimeFwUpd == 3)
		   {
		   	  CHKPNT;
			  CloseTimer();
			  //bGetTxFirmware = FALSE;
			  Ux_OpenWindow(&UIFlowWndWaitMomentCtrl, 1, UIFlowWndWaitMoment_StatusTXT_Msg_STRID_ETHCAM_UDFW_SENDFW);
			 // Ethcam_tx_fwupdate();

		   }
		}
		
		if ( FocusOperate )
		{		
			FocusOperateCount++;
			if (FocusOperateCount == DISPLAY_TIME)
			{
			//CHKPNT;
				if ( UxCtrl_IsShow(&UIFlowWndMovie_Panel_OperateCtrl) )
				{

					if (UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_BarCtrl) )
					{
						;//do nothing
					//	FocusOperateCount = 0;
					//	CHKPNT;
					}else{
						//CHKPNT;
						UxCtrl_SetShow(&UIFlowWndMovie_Panel_OperateCtrl, FALSE);
						FocusOperateCount = 0;
						FocusOperate = FALSE;
					}
				}
				if (UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_BarCtrl) )
				{
					UxCtrl_SetShow(&UIFlowWndMovie_BackLightLvl_BarCtrl, FALSE);
					UxCtrl_SetShow(&UIFlowWndMovie_LCDStaticCtrl, FALSE);
					UxCtrl_SetShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl, FALSE);
					//UI_SetTouchEventMask(NVTEVT_USER_SLIDE_UP);
					//UI_SetTouchEventMask(NVTEVT_USER_SLIDE_DOWN);
					//UI_SetTouchEventMask(NVTEVT_USER_SLIDE_LEFT);
					//UI_SetTouchEventMask(NVTEVT_USER_SLIDE_RIGHT);
					FocusOperateCount = 0;
					FocusOperate = FALSE;
				}
			}
		}else{
			FocusOperateCount = 0;
		}
		
		//#NT#2015/10/02#KCHong -begin
		//#NT#For GPS & ADAS
#if (GPS_FUNCTION == ENABLE)
		GPSHeartBeatNow = GetGPSHeartBeat();
		g_GPSLinked = (GPSHeartBeatNow != GPSHeartBeatPrev) ? TRUE : FALSE;
		GPSHeartBeatPrev = GPSHeartBeatNow;
#endif
//#NT#2015/10/02#KCHong -end

#if (_ADAS_FUNC_ == ENABLE)
		if (UxCtrl_IsShow(&UIFlowWndMovie_ADAS_Alert_DisplayCtrl)) {
			g_uiAdasAlertSecCnt++;
			if (g_uiAdasAlertSecCnt == 2) {
				//UxCtrl_SetShow(&UIFlowWndMovie_Panel_Normal_DisplayCtrl, TRUE);
				UxCtrl_SetShow(&UIFlowWndMovie_ADAS_Alert_DisplayCtrl, FALSE);
				g_uiAdasAlertSecCnt = 0;
			} else {
				return NVTEVT_CONSUME;
			}
		}
#endif  // #if (_ADAS_FUNC_ == ENABLE)

		if (g_bDelayUpdateIcon) {
		//	FlowMovie_UpdateIcons(TRUE);
			g_bDelayUpdateIcon = FALSE;
		}

		//FlowMovie_OnTimer1SecIndex();
		//			FlowMovie_UpdateIcons(TRUE);

		// Isiah, implement YUV merge mode of recording func.
#if _TODO
		if (MovRec_IsRecording()) {
			Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_MOVIE_REC_STEP, 0);
		}   
#endif

#if (MOVIE_AUTOREC_ACPLUG == ENABLE)
		if (System_GetState(SYS_STATE_POWERON) == SYSTEM_POWERON_SAFE) {
			//if (!MovRec_IsRecording()) {
				if (g_PreviewStable_Record == FALSE) {
					if ((g_ACPlug == TRUE) && (g_PreviewStable == TRUE)) {
//if (g_PreviewStable == TRUE)
						g_PreviewStable_Record = TRUE;
#if defined(_KEY_METHOD_4KEY_)
CHKPNT;
						Ux_PostEvent(NVTEVT_KEY_SHUTTER2, 1, NVTEVT_KEY_PRESS);
#else
						Ux_PostEvent(NVTEVT_KEY_SELECT, 1, NVTEVT_KEY_PRESS);
#endif
					}
				}
			//}
		}
#endif
		break;

    case NVTEVT_LCA_ALARM_TIMER:
    {
        static INT8 iLCA_DisCntL = -1, iLCA_DisCntM = -1, iLCA_DisCntR = -1;
        static INT8 iLCA_VoiceCnt = -1;
		static INT16 iLCA_CarStopCnt = -1;
		static INT8 iLCA_CarStopsta = FALSE;	
		static INT32 prev_GX = 0;
		static INT32 prev_GY = 0;
		static INT32 prev_GZ = 0;
		INT32 iGX = 0, iGY = 0, iGZ = 0;
		static BOOL first_cmp = FALSE;
		static INT8 G_CarStopcnt = 0;	
		static UINT16 Gsen_trg_Cnt = 0;

		//menu set LCA alarm off
        if(UI_GetData(FL_ALARM_LCA) == ALARM_LCA_OFF)
            break;


		//Gsensor judge car is moving or not
		if(GSensor_IsOpened())
			GSensor_GetAxisValue(&iGX,&iGY,&iGZ);
			//Gsen_trg_Cnt++;				
			//DBGD(G_CarStop);
			//initial value
			if(first_cmp == FALSE)		
			{
				first_cmp = TRUE;
				prev_GX = iGX;
				prev_GY = iGY;
				prev_GZ = iGZ;
			}
			//debug_msg("mmmm GS preDATA(%d, %d, %d)\r\n", prev_GX,prev_GY,prev_GZ);	
			//debug_msg("mmmm GS nowDATA(%d, %d, %d)\r\n", iGX,iGY,iGZ); 

			
			// abs deviation is bigger than threhold
			if( abs(iGX - prev_GX) > LCA_GSENSOR_THREHOLD	||	
				abs(iGY - prev_GY) > LCA_GSENSOR_THREHOLD	||
				abs(iGZ - prev_GZ) > LCA_GSENSOR_THREHOLD)
			{
				#if 1
				//if data is between 65535-threhold and 0+threhold
				if(((iGX+prev_GX)> (65535- LCA_GSENSOR_THREHOLD-1)) && ((iGX+prev_GX)<(65535+LCA_GSENSOR_THREHOLD+1))){
					//and deviation is bigger than threhold
					if((65535)>(LCA_GSENSOR_THREHOLD+abs(iGX-prev_GX))){CHKPNT;
						LCA_GSENSOR_Move = TRUE;
					}else {CHKPNT;
						LCA_GSENSOR_Move = FALSE;
					}
				}else if(((iGY+prev_GY)> (65535- LCA_GSENSOR_THREHOLD-1)) && ((iGY+prev_GY)<(65535+LCA_GSENSOR_THREHOLD+1))){
					if((65535)>(LCA_GSENSOR_THREHOLD+abs(iGY-prev_GY))){CHKPNT;
						LCA_GSENSOR_Move = TRUE;
					}else {CHKPNT;
						LCA_GSENSOR_Move = FALSE;
					}
				}else if(((iGZ+prev_GZ)> (65535- LCA_GSENSOR_THREHOLD-1)) && ((iGZ+prev_GZ)<(65535+LCA_GSENSOR_THREHOLD+1))){
					if((65535)>(LCA_GSENSOR_THREHOLD+abs(iGZ-prev_GZ))){CHKPNT;
						LCA_GSENSOR_Move = TRUE;
					}else {CHKPNT;
						LCA_GSENSOR_Move = FALSE;
					}
				}else{CHKPNT; //data is outside of 65535-threhold and 0+threhold
					LCA_GSENSOR_Move = TRUE;
				}
			#else
				LCA_GSENSOR_Move = TRUE;
			#endif
			}else{//car is not moving
				LCA_GSENSOR_Move = FALSE;
			}
			
			//car is moving
			//data update
			//all status reload
			if(LCA_GSENSOR_Move){
				G_CarStopcnt = 0;
				iLCA_CarStopsta = FALSE;
				iLCA_CarStopCnt = 0;
				//debug_msg("mmmm GS preDATA(%d, %d, %d)\r\n", prev_GX,prev_GY,prev_GZ);	
				//debug_msg("mmmm GS DATA(%d, %d, %d)\r\n", iGX,iGY,iGZ); 
				prev_GX = iGX;
				prev_GY = iGY;
				prev_GZ = iGZ;
				Gsen_Carsta = TRUE;
				Gsen_trg_Cnt = 0;
			}else{ 	
				if(iLCA_CarStopCnt == 2){ //gsensor no trriger 2 times(10s)
					if(G_CarStopcnt < 11)//gsensor no trriger 5s again
					    G_CarStopcnt++;
					else{
						if(Gsen_Carsta)
							iLCA_CarStopsta = TRUE;//car is stop
					}
				}
				if(Gsen_Carsta){
					Gsen_trg_Cnt++;
					if(Gsen_trg_Cnt == 5000/TIMER_LCA_SEC){//5s
						Gsen_trg_Cnt = 0;
						Gsen_Carsta = 0;
					}
				}
			}
		
        /////////////Display
		//iLCA_CarStopsta = FALSE;
		//iLCA_CarStopCnt=0;
		//bLCA_Alarm_M = FALSE;	//cancle mid alram
		if(bLCA_Alarm_M == TRUE)
		{CHKPNT;
			bLCA_Alarm_M = FALSE;
            if(iLCA_CarStopsta == FALSE &&iLCA_CarStopCnt <2)
            {
				if(iLCA_DisCntM == -1)
				{
					iLCA_DisCntM = 0;
				}
            
				if(uiLCA_Alarm_level_Mid == USER_AVLCA_WRN_LEVEL_H) {
				 UxState_SetData(&UIFlowWndMovie_Status_Alarm_LCtrl, STATE_CURITEM, UIFlowWndMovie_Status_Alarm_L_ICON_ALARM_LEFT_R);
				 UxState_SetData(&UIFlowWndMovie_Status_Alarm_RCtrl, STATE_CURITEM, UIFlowWndMovie_Status_Alarm_R_ICON_ALARM_RIGHT_R);
				 //debug_msg("Alarm_level_Mid is USER_AVLCA_WRN_LEVEL_H\r\n");
				}else if(uiLCA_Alarm_level_Mid == USER_AVLCA_WRN_LEVEL_L) {
				 UxState_SetData(&UIFlowWndMovie_Status_Alarm_LCtrl, STATE_CURITEM, UIFlowWndMovie_Status_Alarm_L_ICON_ALARM_LEFT_Y);
				 UxState_SetData(&UIFlowWndMovie_Status_Alarm_RCtrl, STATE_CURITEM, UIFlowWndMovie_Status_Alarm_R_ICON_ALARM_RIGHT_Y);
				 //debug_msg("Alarm_level_Mid is USER_AVLCA_WRN_LEVEL_L\r\n");
				} 			  
				if(UxCtrl_IsShow(&UIFlowWndMovie_Status_Alarm_RCtrl) == FALSE){
				 UxCtrl_SetShow(&UIFlowWndMovie_Status_Alarm_RCtrl, TRUE);
				 UxCtrl_SetShow(&UIFlowWndMovie_Status_Alarm_LCtrl, TRUE);
				}
        	}
		}else{
			if(bLCA_Alarm_L == TRUE)
			{
				bLCA_Alarm_L = FALSE;
				if(iLCA_DisCntL == -1)
				{
					iLCA_DisCntL = 0;
				}
				 if(uiLCA_Alarm_level_Left == USER_AVLCA_WRN_LEVEL_H) {
					UxState_SetData(&UIFlowWndMovie_Status_Alarm_LCtrl, STATE_CURITEM, UIFlowWndMovie_Status_Alarm_L_ICON_ALARM_LEFT_R);
					//debug_msg("Alarm_level_Left is USER_AVLCA_WRN_LEVEL_H\r\n");
				}else if(uiLCA_Alarm_level_Left == USER_AVLCA_WRN_LEVEL_L) {
					UxState_SetData(&UIFlowWndMovie_Status_Alarm_LCtrl, STATE_CURITEM, UIFlowWndMovie_Status_Alarm_L_ICON_ALARM_LEFT_Y);
					//debug_msg("Alarm_level_Left is USER_AVLCA_WRN_LEVEL_L\r\n");
				} 
			    if(UxCtrl_IsShow(&UIFlowWndMovie_Status_Alarm_LCtrl) == FALSE){
					UxCtrl_SetShow(&UIFlowWndMovie_Status_Alarm_LCtrl, TRUE);
				}
			}
			
			if(bLCA_Alarm_R == TRUE)
			{
				bLCA_Alarm_R = FALSE;
				if(iLCA_DisCntR == -1)
				{
					iLCA_DisCntR = 0;
				}
				if(uiLCA_Alarm_level_Right == USER_AVLCA_WRN_LEVEL_H ) {
					UxState_SetData(&UIFlowWndMovie_Status_Alarm_RCtrl, STATE_CURITEM, UIFlowWndMovie_Status_Alarm_R_ICON_ALARM_RIGHT_R);
					//debug_msg("Alarm_level_Right is USER_AVLCA_WRN_LEVEL_H\r\n");
				}else if(uiLCA_Alarm_level_Right == USER_AVLCA_WRN_LEVEL_L ) {
					UxState_SetData(&UIFlowWndMovie_Status_Alarm_RCtrl, STATE_CURITEM, UIFlowWndMovie_Status_Alarm_R_ICON_ALARM_RIGHT_Y);
					//debug_msg("Alarm_level_Right is USER_AVLCA_WRN_LEVEL_L\r\n");
				}			 
			    if(UxCtrl_IsShow(&UIFlowWndMovie_Status_Alarm_RCtrl) == FALSE){
					UxCtrl_SetShow(&UIFlowWndMovie_Status_Alarm_RCtrl, TRUE);
			    }
			}

		}


        if(iLCA_DisCntL != -1)
        {
            iLCA_DisCntL++;
            if(iLCA_DisCntL == (5000 / TIMER_LCA_SEC)) {
                iLCA_DisCntL = -1;
                UxCtrl_SetShow(&UIFlowWndMovie_Status_Alarm_LCtrl, FALSE);
            }
        }

		if(iLCA_CarStopsta == TRUE)
		{
			iLCA_DisCntM = -1;
		}
		
		if(iLCA_DisCntM != -1)
		{
            iLCA_DisCntM++;
			if(iLCA_DisCntM == (2000 / TIMER_LCA_SEC)) {	// 2s per cycle
				iLCA_CarStopCnt++;
				if(iLCA_CarStopCnt == 2)
				{
				}
	            iLCA_DisCntM = -1;
	            UxCtrl_SetShow(&UIFlowWndMovie_Status_Alarm_LCtrl, FALSE);
				UxCtrl_SetShow(&UIFlowWndMovie_Status_Alarm_RCtrl, FALSE);
        	}
        }

        if(iLCA_DisCntR != -1)
        {
        	//iLCA_CarStopCnt=0;
        	//iLCA_CarStopsta=0;
            iLCA_DisCntR++;
            if(iLCA_DisCntR == (2000 / TIMER_LCA_SEC)) {
                iLCA_DisCntR = -1;
                UxCtrl_SetShow(&UIFlowWndMovie_Status_Alarm_RCtrl, FALSE);
            }
        }

        //////////////wav
        if((iLCA_DisCntM == -1) &&(iLCA_DisCntL == -1) && (iLCA_DisCntR == -1)) {
            iLCA_VoiceCnt = -1;
        } else {
            if(iLCA_VoiceCnt == -1)
                iLCA_VoiceCnt = 0;
        }

        if(iLCA_VoiceCnt != -1)
        {
            if((uiLCA_Alarm_level_Left == USER_AVLCA_WRN_LEVEL_L) 
                ||(uiLCA_Alarm_level_Right == USER_AVLCA_WRN_LEVEL_L)
                ||(uiLCA_Alarm_level_Mid == USER_AVLCA_WRN_LEVEL_L))
            {
            	if((iLCA_VoiceCnt % (1600 / TIMER_LCA_SEC)) == 0)
        		{
                	GxSound_Play(DEMOSOUND_SOUND_KEY_TONE);
            	}
    		}else if((uiLCA_Alarm_level_Left == USER_AVLCA_WRN_LEVEL_H) 
                ||(uiLCA_Alarm_level_Right == USER_AVLCA_WRN_LEVEL_H)
                ||(uiLCA_Alarm_level_Mid == USER_AVLCA_WRN_LEVEL_H))
            {
            	if((iLCA_VoiceCnt % (1000 / TIMER_LCA_SEC)) == 0)	//1s 
        		{
               		GxSound_Play(DEMOSOUND_SOUND_KEY_TONE);
            	}
        	}
            iLCA_VoiceCnt++;
        }
    }
    break;
	}
	Ux_DefaultEvent(pCtrl, NVTEVT_TIMER, paramNum, paramArray);
	return NVTEVT_CONSUME;
}


extern	URECT  gMovieOsdDispCord;
#if (Movie_Redraw_Event == ENABLE)

INT32 UIFlowWndMovie_Panel_TSR_OnRedraw(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	URECT		DispCord = {0,0,OSD_W,OSD_H};
	//INT32 uiCurDispLineY = 0;
	static UINT32 uiCount = 0;
	CHAR string[32] = {0};
	//UINT32 i = 0;
	//UI_SetDisplayDirty(TRUE);
	UINT32 TSRScreenObj = *paramArray;
	INT32 startx=0,starty=0,endx=0,endy=0;
	static DC** ScreenObj;
	//UI_SetDisplayDirty(TRUE);
    //	ScreenObj = (DC**)UI_BeginScreen();
	GxGfx_Clear(((DC**)TSRScreenObj)[GxGfx_OSD]);
	GxGfx_SetShapeStroke(LINEBRUSH_SQUARE|LINEWEIGHT(0), FILLSTYLE_FILL);
	
	#if(White_Black == ENABLE)
	GxGfx_SetShapeColor(CLRID_IDX_WHITE, CLRID_IDX_WHITE, NULL);	
	//FlowMovie_UpdateIcons(FALSE);
	FlowMovie_IconHideRec(&UIFlowWndMovie_Status_RECCtrl);
	FlowMovie_IconHideTopPanel();
	GxGfx_FillRect(((DC**)TSRScreenObj)[GxGfx_OSD],  0,  0, 1279, 319);
	#else
	// draw SNG delete line
	GxGfx_SetShapeColor(CLRID_IDX_RED, CLRID_IDX_RED, NULL);	
	/*
	if(SysGetFlag(FL_DUAL_CAM) == DUALCAM_FRONT)
	{
	  
	  starty =50*SysGetFlag(FL_SENSOR1_DISP_OFFSET)*1080/720;
	  startx =(12*starty+162000)/108;
	  startx = startx * 1280 /1920;
	  endy = (320+50*SysGetFlag(FL_SENSOR1_DISP_OFFSET))*1080/720;
	  endx = (12*endy+162000)/108;
	  endx = endx * 1280 /1920;
	  //DBGD(SysGetFlag(FL_SENSOR1_DISP_OFFSET));
	 // DBGD(startx);
	  //DBGD(starty);
	 // DBGD(endx);
	 // DBGD(endy);
	  GxGfx_Line(((DC**)TSRScreenObj)[GxGfx_OSD],  startx, 0, endx, 320);    
	  //GxGfx_Line(((DC**)TSRScreenObj)[GxGfx_OSD],  1000, 1, 1023, 319);	 
	}*/
	#endif
	return NVTEVT_CONSUME;
}
#endif
INT32 UIFlowWndMovie_OnACPlug(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
#if (MOVIE_AUTOREC_ACPLUG == ENABLE)
	g_ACPlug = TRUE;
// start record if receiving preview stable event
	if ((g_PreviewStable == TRUE) && (g_PreviewStable_Record == FALSE)) {
		g_PreviewStable_Record = TRUE;
		if (UI_GetData(FL_WIFI_AUTO_RECORDING) == WIFI_AUTO_RECORDING_ON) {
//Ux_PostEvent(NVTEVT_KEY_SELECT, 1, NVTEVT_KEY_PRESS);
		}
	}
#endif
	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_OnACUnplug(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	g_ACPlug = FALSE;
	//Ux_PostEvent(NVTEVT_KEY_SELECT, 1, NVTEVT_KEY_PRESS);
	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_OnCustom1(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	//if  (SysGetFlag(FL_GSENSOR) != GSENSOR_OFF) 
	{
		if ((gMovData.State == MOV_ST_REC) || (gMovData.State == MOV_ST_REC_WAIT)) {
			if (SysGetFlag(FL_MOVIE_URGENT_PROTECT_AUTO) == MOVIE_URGENT_PROTECT_AUTO_ON) {
#if 0
			if (GetMovieRecType_2p(UI_GetData(FL_MOVIE_SIZE)) == MOVIE_REC_TYPE_FRONT) 
				
#if(defined(_NVT_ETHREARCAM_RX_))
					ImageApp_MovieMulti_SetCrash(_CFG_REC_ID_1, TRUE);
					UINT32 i;
					for (i = 0; i < ETH_REARCAM_CAPS_COUNT; i++) {
						if(socketCliEthData1_IsRecv(ETHCAM_PATH_ID_1 +i)){
							ImageApp_MovieMulti_SetCrash(_CFG_ETHCAM_ID_1+i, TRUE);
						}
					}
#else
					ImageApp_MovieMulti_TrigEMR(_CFG_REC_ID_1);
#endif
				} else 
#endif
				if (UIFlowWndMovie_GetRecLockStatus() == FALSE)
				{
					UINT32 i, mask, movie_rec_mask;
					ISF_RV rt;

 					movie_rec_mask = Movie_GetMovieRecMask();
					mask = 1;
					for (i = 0; i < SENSOR_CAPS_COUNT; i++) {
						if (movie_rec_mask & mask) {
							CHKPNT;
							ImageApp_MovieMulti_SetCrash(_CFG_REC_ID_1 + i, TRUE);
						}
						mask <<= 1;
					}
					#if (defined(_NVT_ETHREARCAM_RX_))
						for(i = 0;i<ETH_REARCAM_CAPS_COUNT;i++)
						{
							CHKPNT;
							ImageApp_MovieMulti_SetCrash(_CFG_ETHCAM_ID_1 + i,TRUE);
						}	
					#endif
					
					if (rt < 0)
                    {
                        DBG_ERR("\r\n  ---------%d SetCrash Error !!!--------- \r\n",rt);
                    }else{
						UIFlowWndMovie_SetRecLockStatus(TRUE);
						//if ( FlowMovie_GetRecCurrTime() > 59)
						//{    
							 g_EmergencyRecSetpTotail = gMovie_Rec_Option.seamless_sec ;//(gMovie_Rec_Option.seamless_sec  - FlowMovie_GetRecCurrTime()) + gMovie_Rec_Option.seamless_sec +1;//(60 - FlowMovie_GetRecCurrTime()) + 61;
						//}else{
						//	g_EmergencyRecSetpTotail = 60;//gMovie_Rec_Option.seamless_sec ;
						//}
						g_EmergencyRecSetp = 0;
                    	g_EmergencyRecTime = 0;	
		           }
				}
			}
		}
	}

	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_OnADASShowAlarm(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
#if (_ADAS_FUNC_ == ENABLE)
	UINT32 AlarmType;
	ADAS_APPS_RESULT_INFO *pAdasRlt = MovieExe_GetAdasRltOSD();

	Ux_FlushEventByRange(NVTEVT_CB_ADAS_SHOWALARM, NVTEVT_CB_ADAS_SHOWALARM);
	AlarmType = paramArray[0];

	switch (AlarmType) {
	case ADAS_ALARM_LD:
		g_uiAdasAlertSecCnt = 0;
		UISound_Play(DEMOSOUND_SOUND_LDWS_TONE);
		if (!UxCtrl_IsShow(&UIFlowWndMovie_ADAS_Alert_DisplayCtrl)) {
			//UxCtrl_SetShow(&UIFlowWndMovie_Panel_Normal_DisplayCtrl, FALSE);
			UxCtrl_SetShow(&UIFlowWndMovie_ADAS_Alert_DisplayCtrl, TRUE);
			UxCtrl_SetShow(&UIFlowWndMovie_StatusICN_LDWS_AlertCtrl, TRUE);
			UxCtrl_SetShow(&UIFlowWndMovie_StatusICN_FCWS_AlertCtrl, FALSE);
			UxCtrl_SetShow(&UIFlowWndMovie_StatusICN_SNG_AlertCtrl, FALSE);
			switch (pAdasRlt->LdwsRsltInfo.DepartureDirSound) {
			case LDWS_DEPARTURE_LEFT:
				UxState_SetData(&UIFlowWndMovie_StatusICN_LDWS_AlertCtrl, STATE_CURITEM, UIFlowWndMovie_StatusICN_LDWS_Alert_ICON_LDWS_LEFT_ALERT);
				break;
			case LDWS_DEPARTURE_RIGHT:
				UxState_SetData(&UIFlowWndMovie_StatusICN_LDWS_AlertCtrl, STATE_CURITEM, UIFlowWndMovie_StatusICN_LDWS_Alert_ICON_LDWS_RIGHT_ALERT);
				break;
			default:
				break;
			}
		}
		break;

	case ADAS_ALARM_FC:
		g_uiAdasAlertSecCnt = 0;
		UISound_Play(DEMOSOUND_SOUND_FCS_TONE);
		if (!UxCtrl_IsShow(&UIFlowWndMovie_ADAS_Alert_DisplayCtrl)) {
			//UxCtrl_SetShow(&UIFlowWndMovie_Panel_Normal_DisplayCtrl, FALSE);
			UxCtrl_SetShow(&UIFlowWndMovie_ADAS_Alert_DisplayCtrl, TRUE);
			UxCtrl_SetShow(&UIFlowWndMovie_StatusICN_LDWS_AlertCtrl, FALSE);
			UxCtrl_SetShow(&UIFlowWndMovie_StatusICN_FCWS_AlertCtrl, TRUE);
			UxCtrl_SetShow(&UIFlowWndMovie_StatusICN_SNG_AlertCtrl, FALSE);

			if ((pAdasRlt->FcwsRsltInfo.uiKelDist < 15) && (pAdasRlt->FcwsRsltInfo.uiKelDist > 0)) {
				UxState_SetData(&UIFlowWndMovie_StatusICN_FCWS_AlertCtrl, STATE_CURITEM, UIFlowWndMovie_StatusICN_FCWS_Alert_ICON_FCW_FAR_ALERT);
			}
		}
		break;

	case ADAS_ALARM_GO:
		g_uiAdasAlertSecCnt = 0;
		UISound_Play(DEMOSOUND_SOUND_SNG_TONE);
		if (!UxCtrl_IsShow(&UIFlowWndMovie_ADAS_Alert_DisplayCtrl)) {
			//UxCtrl_SetShow(&UIFlowWndMovie_Panel_Normal_DisplayCtrl, FALSE);
			UxCtrl_SetShow(&UIFlowWndMovie_ADAS_Alert_DisplayCtrl, TRUE);
			UxCtrl_SetShow(&UIFlowWndMovie_StatusICN_LDWS_AlertCtrl, FALSE);
			UxCtrl_SetShow(&UIFlowWndMovie_StatusICN_FCWS_AlertCtrl, FALSE);
			UxCtrl_SetShow(&UIFlowWndMovie_StatusICN_SNG_AlertCtrl, TRUE);
			UxState_SetData(&UIFlowWndMovie_StatusICN_SNG_AlertCtrl, STATE_CURITEM, UIFlowWndMovie_StatusICN_SNG_Alert_ICON_SNG_ALERT);
		}
		break;

	case ADAS_ALARM_STOP:
		g_uiAdasAlertSecCnt = 0;
		UISound_Play(DEMOSOUND_SOUND_SNG_TONE);
		if (!UxCtrl_IsShow(&UIFlowWndMovie_ADAS_Alert_DisplayCtrl)) {
			//UxCtrl_SetShow(&UIFlowWndMovie_Panel_Normal_DisplayCtrl, FALSE);
			UxCtrl_SetShow(&UIFlowWndMovie_ADAS_Alert_DisplayCtrl, TRUE);
			UxCtrl_SetShow(&UIFlowWndMovie_StatusICN_LDWS_AlertCtrl, FALSE);
			UxCtrl_SetShow(&UIFlowWndMovie_StatusICN_FCWS_AlertCtrl, FALSE);
			UxCtrl_SetShow(&UIFlowWndMovie_StatusICN_SNG_AlertCtrl, TRUE);
			UxState_SetData(&UIFlowWndMovie_StatusICN_SNG_AlertCtrl, STATE_CURITEM, UIFlowWndMovie_StatusICN_SNG_Alert_ICON_SNG_ALERT);
		}
		break;

	default:
		break;
	}
#endif  // #if (_ADAS_FUNC_ == ENABLE)
	return NVTEVT_CONSUME;
}

//#NT#2016/07/20#Brain Yen -begin
//#NT#Add for DDD alarm
INT32 UIFlowWndMovie_OnDDDShowAlarm(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
#if (_DDD_FUNC_ == ENABLE)
	UINT32 AlarmType;
	AlarmType = paramArray[0];
#if 0//Add for test
	GxSound_SetOutDevConfigIdx(0);
#endif
	switch (AlarmType) {
	case DDD_ALARM_PERCLOS:
		UISound_Play(DEMOSOUND_SOUND_DDDWARNING3_TONE);
		break;

	case DDD_ALARM_YAWN:
		UISound_Play(DEMOSOUND_SOUND_DDDWARNING3_TONE);
		break;

	case DDD_ALARM_DIS:
		UISound_Play(DEMOSOUND_SOUND_DDDWARNING2_TONE);
		break;

	case DDD_ALARM_NODE:
		UISound_Play(DEMOSOUND_SOUND_DDDWARNING3_TONE);
		break;

	case DDD_ALARM_EYE:
		UISound_Play(DEMOSOUND_SOUND_DDDWARNING1_TONE);
		break;

	default:
		break;
	}
#endif
	return NVTEVT_CONSUME;
}
//#NT#2016/07/20#Brain Yen -end

//#NT#2016/06/23#Niven Cho -begin
//#NT#Enter calibration by cgi event or command event
INT32 UIFlowWndMovie_OnKeyCalibration(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
#if (CALIBRATION_FUNC == ENABLE)
	{
		Ux_SendEvent(0, NVTEVT_SYSTEM_MODE, 1, PRIMARY_MODE_MAIN);
		EngineerMode_Open();
	}
#endif
	return NVTEVT_CONSUME;

}
//#NT#2016/06/23#Niven Cho -end
INT32 UIFlowWndMovie_OnOverTime(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
#if defined(_KEY_METHOD_4KEY_)
CHKPNT;
	Ux_PostEvent(NVTEVT_KEY_SHUTTER2, 3, NVTEVT_KEY_PRESS, 0, UIFlowWndMovie_Restart_Rec);
#else
	Ux_PostEvent(NVTEVT_KEY_SELECT, 3, NVTEVT_KEY_PRESS, 0, UIFlowWndMovie_Restart_Rec);
#endif
	return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_OnBackgroundDone(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	NVTEVT event=paramArray[ONDONE_PARAM_INDEX_CMD];
	//UINT32 status= paramArray[ONDONE_PARAM_INDEX_RET];

	debug_ind(("UIFlowWndMovie_OnBackgroundDone event = 0x%x\r\n", event));

	switch (event) {
	case NVTEVT_BKW_STOPREC_PROCESS: {
	//	CHKPNT;
		    g_uiRecStopTimerCnt=0;
		    FlowMovie_UpdateIcons(TRUE);
			// cj add 
			if (g_UIStopRecTimerID != NULL_TIMER) {
            		GxTimer_StopTimer(&g_UIStopRecTimerID);
	        }
			CHKPNT;
			CloseTimer();
	        Ux_OpenWindow(&UIFlowWndWaitMomentCtrl, 1, UIFlowWndWaitMoment_StatusTXT_Msg_STRID_STOPREC_WAIT);
	        break;

		}
		break;
	default:
		break;
	}

	return NVTEVT_CONSUME;

}


#if IMG_FULL_DISP
extern 	void MovieExe_SetIMECrop(UINT32 rec_id);
#endif

INT32 UIFlowWndMovie_OnTouchSlideLeft(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_EMRBarCtrl))
	{
		return NVTEVT_CONSUME;
	}
	//extern UINT32 g_PipViewStyle;
	if(!bFocusBackLightAdj)
	{
    	//DBGD(g_PipViewStyle);
    	DBGD(SysGetFlag(FL_DUAL_CAM));
    	if(SysGetFlag(FL_DUAL_CAM) == DUALCAM_BEHIND)
    	{
	        SysSetFlag(FL_DUAL_CAM_MENU, DUALCAM_FRONT);
	        SysSetFlag(FL_DUAL_CAM, DUALCAM_FRONT);
    	}
    	else if(bflag_EthLinkFinish ==TRUE &&socketCliEthData1_IsRecv(ETHCAM_PATH_ID_1 ))
    	{CHKPNT;
	        SysSetFlag(FL_DUAL_CAM_MENU, DUALCAM_BEHIND);
	        SysSetFlag(FL_DUAL_CAM, DUALCAM_BEHIND);
    	}
		else{
			CHKPNT;
			CloseTimer();
			Ux_OpenWindow(&UIFlowWndWaitMomentCtrl, 1, UIFlowWndWaitMoment_StatusTXT_Msg_STRID_ETHCAM_DETFAIL);
		}
	}
	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_OnTouchSlideRight(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_EMRBarCtrl))
	{
		return NVTEVT_CONSUME;
	}

	//extern UINT32 g_PipViewStyle;	
	if(!bFocusBackLightAdj)
	{
    	//DBGD(g_PipViewStyle);
    	DBGD(SysGetFlag(FL_DUAL_CAM));
    	if(SysGetFlag(FL_DUAL_CAM) == DUALCAM_BEHIND)
    	{
	        SysSetFlag(FL_DUAL_CAM_MENU, DUALCAM_FRONT);
	        SysSetFlag(FL_DUAL_CAM, DUALCAM_FRONT);
    	}
    	else if(bflag_EthLinkFinish ==TRUE &&socketCliEthData1_IsRecv(ETHCAM_PATH_ID_1 ))
    	{
	        SysSetFlag(FL_DUAL_CAM_MENU, DUALCAM_BEHIND);
	        SysSetFlag(FL_DUAL_CAM, DUALCAM_BEHIND);
    	}
		else{
			CloseTimer();
			Ux_OpenWindow(&UIFlowWndWaitMomentCtrl, 1, UIFlowWndWaitMoment_StatusTXT_Msg_STRID_ETHCAM_DETFAIL);
		}
	}
	return NVTEVT_CONSUME;
}
extern ETHCAM_TX_SET_OFFESET SlideOffsetInfo;

INT32 UIFlowWndMovie_OnTouchSlideDown(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
CHKPNT;
	//extern UINT32 g_PipViewStyle;
	UINT32 curDispOffset = 0;
	debug_msg("--OnTouchSlideDown RXcj FL_DUAL_CAM:%d \r\n",UI_GetData(FL_DUAL_CAM));
	WndMovie_Delay_SaveMenuCnt = 1;
	if(!bFocusBackLightAdj)
	{
    	if(SysGetFlag(FL_DUAL_CAM) == DUALCAM_FRONT)
    	{
            curDispOffset = SysGetFlag(FL_SENSOR1_DISP_OFFSET);
			if(curDispOffset > IMG_DISP_POS_0)
			{
				curDispOffset -- ;
				SysSetFlag(FL_SENSOR1_DISP_OFFSET, curDispOffset);
			}else if ( curDispOffset == IMG_DISP_POS_0)
			{
				SysSetFlag(FL_SENSOR1_DISP_OFFSET, curDispOffset);
			}
            
            #if IMG_FULL_DISP
            MovieExe_SetIMECrop(_CFG_REC_ID_1);
            #endif  
    	}
    	else
    	{
			curDispOffset = SysGetFlag(FL_IMGDISP_POS_STEP_ID1);
			
			if(curDispOffset > IMG_DISP_POS_0)
			{
				   curDispOffset -- ;
				   SysSetFlag(FL_IMGDISP_POS_STEP_ID1, curDispOffset);
			}else if ( curDispOffset == IMG_DISP_POS_0)
			{
				SysSetFlag(FL_IMGDISP_POS_STEP_ID1, curDispOffset);
			
			}
            #if IMG_FULL_DISP
  			MovieExe_EthCamSetISECrop(_CFG_ETHCAM_ID_1);
            #endif	
	//		SlideOffsetInfo.curDispOffset = curDispOffset;
			//SlideOffsetInfo.curFlDualCAM = SysGetFlag(FL_DUAL_CAM);
//					debug_msg("--OnTouchSlideUp cj offset: %d %d",SlideOffsetInfo.curDispOffset, SlideOffsetInfo.curFlDualCAM);

			debug_msg("--OnTouchSlideDown cj offset: %d ",SlideOffsetInfo.curDispOffset);
	//		BKG_PostEvent(NVTEVT_BKW_ETHCAM_SET_TX_SLIDEUP);

    	}
	}
		

	//if(socketCliEthData1_IsRecv(ETHCAM_PATH_ID_1 ) && EthCamNet_GetEthLinkStatus(ETHCAM_PATH_ID_1 )==ETHCAM_LINK_UP)
	{
	//CHKPNT;
	//	BKG_PostEvent(NVTEVT_BKW_ETHCAM_SET_TX_SLIDEUP);
	}

	return NVTEVT_CONSUME;
}

	

INT32 UIFlowWndMovie_OnTouchSlideUp(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	//extern UINT32 g_PipViewStyle;
	UINT32 curDispOffset = 0;
	
	WndMovie_Delay_SaveMenuCnt = 1;
	if(!bFocusBackLightAdj)
	{
    	if(SysGetFlag(FL_DUAL_CAM) == DUALCAM_FRONT)
    	{
            curDispOffset = SysGetFlag(FL_SENSOR1_DISP_OFFSET);
			if(curDispOffset < IMG_DISP_POS_8)
			{
				curDispOffset ++ ;
				SysSetFlag(FL_SENSOR1_DISP_OFFSET, curDispOffset);
			}else if ( curDispOffset == IMG_DISP_POS_8)
			{
				SysSetFlag(FL_SENSOR1_DISP_OFFSET, curDispOffset);
			}
            debug_msg("OnTouchSlideUp cj -------sensor 1 offset:%d\r\n",curDispOffset);
            #if IMG_FULL_DISP
            MovieExe_SetIMECrop(_CFG_REC_ID_1);
            #endif  
    	}
    	else
    	{
			curDispOffset = SysGetFlag(FL_IMGDISP_POS_STEP_ID1);
			if(curDispOffset < IMG_DISP_POS_8)
			{
				curDispOffset ++ ;
				SysSetFlag(FL_IMGDISP_POS_STEP_ID1, curDispOffset);
			}else if ( curDispOffset == IMG_DISP_POS_8)
			{
				SysSetFlag(FL_IMGDISP_POS_STEP_ID1, curDispOffset);
			}
            debug_msg("OnTouchSlideUp-------offset: %d sensor 2 \r\n",curDispOffset);
            #if IMG_FULL_DISP
  			MovieExe_EthCamSetISECrop(_CFG_ETHCAM_ID_1);
            #endif
	//	SlideOffsetInfo.curDispOffset = curDispOffset;
		//SlideOffsetInfo.curFlDualCAM = SysGetFlag(FL_DUAL_CAM);

			debug_msg("--OnTouchSlideUp cj offset: %d ",SlideOffsetInfo.curDispOffset);
	//		BKG_PostEvent(NVTEVT_BKW_ETHCAM_SET_TX_SLIDEUP);
    	}
	}
	return NVTEVT_CONSUME;
}




INT32 UIFlowWndMovie_OnTouchDoubleClick(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
CHKPNT;
	if(SysGetFlag(FL_DUAL_CAM) == DUALCAM_FRONT  )
	{
		return NVTEVT_CONSUME;
	}
	   UxProgressBar_SetData(&UIFlowWndMovie_BehindProgressBarCtrl,PROBAR_CURSTP,SysGetFlag(FL_IMGDISP_POS_STEP_ID1)*CurStepPosBehind ); //iCur_BL_Value_Bar
    	   UxProgressBar_SetData(&UIFlowWndMovie_BehindProgressBarCtrl,PROBAR_TOTSTP,400); //99
	   DrawBehindBar();
    return NVTEVT_CONSUME;
}
static INT32 iTranPointInit = 0;
//static INT32 iTranPrevPointInit = 0;
static INT32 iCur_BL_Value = 0;
INT32 UIFlowWndMovie_OnTouchMove(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
CHKPNT;
    INT32 BL_Adj_Add_Value;
	INT32 iCur_BL_Value_Bar = 0;
	//INT32 iCur_BL_Value_Final = 0;
	#if 0
	INT32 touch_x, touch_y = 0;
	if ( UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl) )
	{
	CHKPNT;
       //Ux_RECT CtrlRect;
       Ux_RECT CtrlRect_Parent;
     //  UxCtrl_GetPos(&UIFlowWndMovie_BackLightLvl_BarCtrl, &CtrlRect_Parent );//CtrlRect		
       UxCtrl_GetPos(&UIFlowWndMovie_BackLightLvl_PanelCtrl, &CtrlRect_Parent);
      // DBGD(CtrlRect.x1);
       DBGD(CtrlRect_Parent.x1);
	  DBGD(paramArray[0]);
	  DBGD(paramArray[1]);
       //touch_x = (INT32)(paramArray[0] + CtrlRect_Parent.x1 + CtrlRect.x1);
       //touch_y = (INT32)(paramArray[1] + CtrlRect_Parent.y1 + CtrlRect.y1);
       touch_x = (INT32)(paramArray[0] + CtrlRect_Parent.x1);
       touch_y = (INT32)(paramArray[1] + CtrlRect_Parent.y1);	   
	   bFocusBackLightAdj = TRUE;
	   UIFlowWndMovie_SetBriAdjBarShowTime(LCD_BRI_LVL_DISP_TIME);
	   iTouchBLAdjHoldPointInit = touch_x;
	//   DBGD(iTouchBLAdjHoldPointInit);
	   iTranPointInit =  iTouchBLAdjHoldPointInit;//cj
	   GxTimer_StopTimer(&uiIgnoreTimerID);
	}
	else
	{   
	   CHKPNT;
		bFocusBackLightAdj = FALSE;
		GxTimer_StopTimer(&uiIgnoreTimerID);

	}
	#endif
	
debug_msg("%d %d %d \r\n",paramNum,bFocusBackLightAdj,UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl));
	if(paramNum == 2 && bFocusBackLightAdj && UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl))
	{
	  //UIFlowWndMovie_SetBriAdjBarShowTime(LCD_BRI_LVL_DISP_TIME);
	   iTouchBLAdjHoldPointCur = paramArray[0];
	   DBGD(paramArray[0]);
	   
	   if(iTouchBLAdjHoldPointPrev == 0)
	   {
	      BL_Adj_Add_Value =  (iTouchBLAdjHoldPointCur - iTouchBLAdjHoldPointInit)/6;
	   }
	   else
	   {
          if(iTouchBLAdjHoldPointCur > iTouchBLAdjHoldPointPrev)
          {
             if((iTouchBLAdjHoldPointCur - iTouchBLAdjHoldPointPrev) < 6 && (iTouchBLAdjHoldPointCur - iTouchBLAdjHoldPointPrev) > 3)
			 	BL_Adj_Add_Value = 1;
			 else
			 	BL_Adj_Add_Value =  (iTouchBLAdjHoldPointCur - iTouchBLAdjHoldPointPrev)/6;
          }
		  else if(iTouchBLAdjHoldPointCur < iTouchBLAdjHoldPointPrev)
		  {
			  if((iTouchBLAdjHoldPointPrev - iTouchBLAdjHoldPointCur) < 6 && (iTouchBLAdjHoldPointPrev - iTouchBLAdjHoldPointCur) > 3)
				 BL_Adj_Add_Value = -1;
			  else
				 BL_Adj_Add_Value =  (iTouchBLAdjHoldPointCur - iTouchBLAdjHoldPointPrev)/6;
		  }
		  else
		  {
		       BL_Adj_Add_Value = 0;
		  }
		  
	   }
	   iTouchBLAdjHoldPointPrev = iTouchBLAdjHoldPointCur;
	   iCur_BL_Value_Bar = (INT32)(UxProgressBar_GetData(&UIFlowWndMovie_BackLightLvl_BarCtrl, PROBAR_CURSTP));
	   #if 1
       iCur_BL_Value_Bar += BL_Adj_Add_Value;
	   if(iCur_BL_Value_Bar < 0)   	 
	   {
	     iCur_BL_Value_Bar = 0;
	   }else if(iCur_BL_Value_Bar > 99)
	   {
	     iCur_BL_Value_Bar = 99;
	   }
#else
	   iCur_BL_Value_Final = iCur_BL_Value_Bar /9 -10;
DBGD(iCur_BL_Value_Bar);
	DBGD(iCur_BL_Value_Final);
	#endif
       UxProgressBar_SetData(&UIFlowWndMovie_BackLightLvl_BarCtrl,PROBAR_CURSTP,iCur_BL_Value_Bar ); //iCur_BL_Value_Bar
	   UxProgressBar_SetData(&UIFlowWndMovie_BackLightLvl_BarCtrl,PROBAR_TOTSTP,99); //99
	
	GxVideo_SetDeviceCtrl(DOUT1, DISPLAY_DEVCTRL_BRIGHTLVL,iCur_BL_Value_Bar);
	   SysSetFlag(FL_LCD_BRIGHTNESS,iCur_BL_Value_Bar);

	}
    return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_BackLightLvl_Bar_OnTouchPanelClick(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray);
#define Panel_Behind_StartX 	88
#define Panel_Behind_EndX		270
#define Panel_Behind_StartY	47// 52
#define Panel_Behind_EndY		316 //302

#define BackLightLvl_Panel_StartX 	284
#define BackLightLvl_Panel_EndX	1040//	1028
#define BackLightLvl_Panel_StartY	124
#define BackLightLvl_Panel_EndY		195
#if 1
static UIScreen    ScreenObj = 0;
static void  Fun_UpdateBehindString(void)
{
		CHAR string[32] = {0};
	//	static DC** ScreenObj;
	//UI_SetDisplayDirty(TRUE);
    //	ScreenObj = (DC**)UI_BeginScreen();
    GxGfx_FillRect(((DC**)ScreenObj)[GxGfx_OSD],  479-17,  119-7, 479+17, 119+7);

    GxGfx_SetTextStroke((const FONT*)gDemo_SmallFont, FONTSTYLE_NORMAL, SCALE_1X);
    GxGfx_SetTextColor(CLRID_IDX_BLACK, CLRID_IDX_BLACK, CLRID_IDX_BLACK);

debug_msg("(FL_DUAL_CAM):%d   FL_IMGDISP_POS_STEP_ID0:%d \r\n",SysGetFlag(FL_DUAL_CAM), SysGetFlag(FL_IMGDISP_POS_STEP_ID1));
	if(SysGetFlag(FL_DUAL_CAM) == DUALCAM_FRONT)
	{
		 switch(SysGetFlag(FL_IMGDISP_POS_STEP_ID0))
		 {
			 case IMG_DISP_POS_8:
				  sprintf(string, " -36A");   
				break;
			 case IMG_DISP_POS_7:
				  sprintf(string, " -27A");   
				break;		  
			 case IMG_DISP_POS_6:
				  sprintf(string, " -18A");   
				break;		   
			 case IMG_DISP_POS_5:
				  sprintf(string, " -9A");	 
				break;		   
			 case IMG_DISP_POS_4:
				  sprintf(string, "  0A");	  
				break;		   
			 case IMG_DISP_POS_3:
				  sprintf(string, "  9A");	  
				break;		   
			 case IMG_DISP_POS_2:
				  sprintf(string, "  18A");	  
				break;		   
			 case IMG_DISP_POS_1:
				  sprintf(string, "  27A");	  
				break;
			 case IMG_DISP_POS_0:
				  sprintf(string, "  36A");	  
				break;
	
		 }
	  }else if(SysGetFlag(FL_DUAL_CAM) == DUALCAM_BEHIND)
	  {
	  CHKPNT;
	  debug_msg("%d \r\n",SysGetFlag(FL_IMGDISP_POS_STEP_ID1));
		  switch(SysGetFlag(FL_IMGDISP_POS_STEP_ID1))
		  {
			  case IMG_DISP_POS_8:
				   sprintf(string, " -20A");   
				 break;
			  case IMG_DISP_POS_7:
				   sprintf(string, " -15A");   
				 break; 	   
			  case IMG_DISP_POS_6:
				   sprintf(string, " -10A");   
				 break; 		
			  case IMG_DISP_POS_5:
				   sprintf(string, "  -5A");   
				 break; 		
			  case IMG_DISP_POS_4:
				   sprintf(string, "  0A");    
				 break; 		
			  case IMG_DISP_POS_3:
				   sprintf(string, "  5A");    
				 break; 		
			  case IMG_DISP_POS_2:
				   sprintf(string, "  10A");   
				 break; 		
			  case IMG_DISP_POS_1:
				   sprintf(string, "  15A");   
				 break;
			  case IMG_DISP_POS_0:
				   sprintf(string, "  20A");   
				 break;
		  
		  }
	  }
	GxGfx_Text(((DC**)ScreenObj)[GxGfx_OSD],  479-22, 119-5, string);
	//UI_EndScreen((UINT32)ScreenObj);
   //UxCtrl_SetShow(&UIFlowWndMovie_Panel_BehindCtrl, TRUE); 


}

#endif

INT32 UIFlowWndMovie_OnTouchPanelClick(VControl * pCtrl, UINT32 paramNum, UINT32 * paramArray)
{
CHKPNT;
debug_msg("%d %d \r\n",paramArray[0],paramArray[1]);
//return NVTEVT_PASS;
#if 0
	if (paramArray[0] >123  && paramArray[0] < 217 )
	{
		CHKPNT;
	
		if (paramArray[1] >52  && paramArray[1] < 302)
		{	
		CHKPNT;
			if(SysGetFlag(FL_DUAL_CAM) == DUALCAM_FRONT  )
			{
				CHKPNT;
				return NVTEVT_CONSUME;
			}
			if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_BehindCtrl))
			{
				CHKPNT;
				HideBehindBar();
				return NVTEVT_CONSUME;
			}else{
				CHKPNT;
				   UxProgressBar_SetData(&UIFlowWndMovie_BehindProgressBarCtrl,PROBAR_CURSTP,CurPosBehind ); //iCur_BL_Value_Bar
			    	   UxProgressBar_SetData(&UIFlowWndMovie_BehindProgressBarCtrl,PROBAR_TOTSTP,400); //99
				   DrawBehindBar();
				   return NVTEVT_CONSUME;
			}
			
		}
	   }
	debug_msg("FocusOperate:%d  %d\r\n ",FocusOperate, UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_BarCtrl));

		if (paramArray[0] >284  && paramArray[0] < 1028 )
		{
			CHKPNT;
			if (paramArray[1] >124  && paramArray[1] < 195)
			{
				CHKPNT;
				if  (UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_BarCtrl) )
				{
				CHKPNT;
				//*
					UxCtrl_SetShow(&UIFlowWndMovie_BackLightLvl_BarCtrl, FALSE);
					UxCtrl_SetShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl, FALSE);
					Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_SETLCDBRIGHTLVL, 1, SysGetFlag(FL_LCD_BRIGHTNESS));
					return NVTEVT_CONSUME;
				//*/
				}else{
				CHKPNT;
					UxCtrl_SetShow(&UIFlowWndMovie_BackLightLvl_BarCtrl, TRUE);
					UxCtrl_SetShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl, TRUE);
					return NVTEVT_CONSUME;
					
				}
			}
			
		}
		#endif
		if ( UIFlowWndMovie_GetRecLockStatus() == TRUE) 
		{
			CHKPNT;
	   		UxCtrl_SetShow(&UIFlowWndMovie_ConfirmPanelCtrl, TRUE);
			UxCtrl_SetShow(& UIFlowWndMovie_StatusTxT_TitleCtrl, TRUE);
			UxCtrl_SetShow(&UIFlowWndMovie_Tab_YES_NOCtrl, TRUE);
			FocusUrgCount = 0;
			bFocusUrg = TRUE;
			return NVTEVT_CONSUME;
		}
		   
		if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_BehindCtrl))
		{
			CHKPNT;
			FlowMovie_IconDrawDateTime();
			HideBehindBar();
		//	return NVTEVT_CONSUME;
		}

		if  (UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_BarCtrl) )
		{
			CHKPNT;
			
			UxCtrl_SetShow(&UIFlowWndMovie_LCDStaticCtrl, FALSE);
			UxCtrl_SetShow(&UIFlowWndMovie_BackLightLvl_BarCtrl, FALSE);
			UxCtrl_SetShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl, FALSE);
			//UI_SetTouchEventMask(NVTEVT_USER_SLIDE_UP);
			//UI_SetTouchEventMask(NVTEVT_USER_SLIDE_DOWN);
			//UI_SetTouchEventMask(NVTEVT_USER_SLIDE_LEFT);
			//UI_SetTouchEventMask(NVTEVT_USER_SLIDE_RIGHT);
			//Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_SETLCDBRIGHTLVL, 1, SysGetFlag(FL_LCD_BRIGHTNESS));
			//return NVTEVT_CONSUME;
			
		}
		if  ( FocusOperate ) //UxCtrl_IsShow(&UIFlowWndMovie_Panel_OperateCtrl) )
		{
			CHKPNT;
			UxCtrl_SetShow(&UIFlowWndMovie_Panel_OperateCtrl, FALSE);
			FocusOperate =FALSE;
			return NVTEVT_CONSUME;
		}
		
		if ( !FocusOperate)//(  !UxCtrl_IsShow(&UIFlowWndMovie_Panel_OperateCtrl) )
		{
			CHKPNT;
			UxCtrl_SetShow(&UIFlowWndMovie_Panel_OperateCtrl, TRUE);
			FocusOperate = TRUE;
			FocusOperateCount = 0;
			return NVTEVT_CONSUME;
		}
	
	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_OnTouchRelease(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
//CHKPNT;
//cj add begin
	if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_EMRBarCtrl))
	{
		return NVTEVT_CONSUME;
	}
//cj add end
	iTouchBLAdjHoldPointInit = 0;
	iTouchBLAdjHoldPointCur = 0;
	iTouchBLAdjHoldPointPrev = 0;
	if(bFocusBackLightAdj == TRUE)
	{
	   if(uiIgnoreTimerID != NULL_TIMER)
	   {
	      GxTimer_StopTimer(&uiIgnoreTimerID);
	   }
	   if(uiIgnoreTimerID == NULL_TIMER)
	      uiIgnoreTimerID = GxTimer_StartTimer(300, NVTEVT_IGNORE_SLIDE_TOUCH_TIMER, ONE_SHOT);
	}
    return NVTEVT_PASS;
}


//#MT#lyb -20200331 -begin
//static UINT8 iLCA_sta_cnt = 0;
//static BOOL iLCA_sta_trg = FALSE;

INT32 UIFlowWndMovie_OnLCA_Alarm(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	 if(!Gsen_Carsta){
		debug_msg("Gsensor not trriger\r\n");
		return NVTEVT_PASS;
	}else{
		debug_msg("Gsensor is trriger\r\n");
	}
	
    if(paramNum == 3)
    {  
        uiLCA_Alarm_level_Left = paramArray[0];
		uiLCA_Alarm_level_Mid = paramArray[1];
        uiLCA_Alarm_level_Right = paramArray[2];
        debug_msg("uiLCA_Alarm_level_Left=%d\r\n uiLCA_Alarm_level_Mid=%d\r\n uiLCA_Alarm_level_Right=%d\r\n", uiLCA_Alarm_level_Left,uiLCA_Alarm_level_Mid,uiLCA_Alarm_level_Right);
        switch(paramArray[0])
        {
            case USER_AVLCA_WRN_NONE:
                bLCA_Alarm_L = FALSE;
                break;
            case USER_AVLCA_WRN_LEVEL_L:
                bLCA_Alarm_L = TRUE;
                //UxState_SetData(&UIFlowWndMovie_Status_Alarm_LCtrl, STATE_CURITEM, UIFlowWndMovie_Status_Alarm_L_ICON_ALARM_LEFT_Y);
                break;
            case USER_AVLCA_WRN_LEVEL_H:
                bLCA_Alarm_L = TRUE;
                //UxState_SetData(&UIFlowWndMovie_Status_Alarm_LCtrl, STATE_CURITEM, UIFlowWndMovie_Status_Alarm_L_ICON_ALARM_LEFT_R);
                break;
            default:
                bLCA_Alarm_L = FALSE;
            break;
        }
        switch(paramArray[1])
        {
            case USER_AVLCA_WRN_NONE:
                bLCA_Alarm_M = FALSE;
                break;
            case USER_AVLCA_WRN_LEVEL_L:
                bLCA_Alarm_M = TRUE;
                //UxState_SetData(&UIFlowWndMovie_Status_Alarm_RCtrl, STATE_CURITEM, UIFlowWndMovie_Status_Alarm_R_ICON_ALARM_RIGHT_Y);
                break;
            case USER_AVLCA_WRN_LEVEL_H:
                bLCA_Alarm_M = TRUE;
                //UxState_SetData(&UIFlowWndMovie_Status_Alarm_RCtrl, STATE_CURITEM, UIFlowWndMovie_Status_Alarm_R_ICON_ALARM_RIGHT_R);
                break;
            default:
                bLCA_Alarm_M = FALSE;
            break;
        }
        switch(paramArray[2])
        {
            case USER_AVLCA_WRN_NONE:
                bLCA_Alarm_R = FALSE;
                break;
            case USER_AVLCA_WRN_LEVEL_L:
                bLCA_Alarm_R = TRUE;
                //UxState_SetData(&UIFlowWndMovie_Status_Alarm_RCtrl, STATE_CURITEM, UIFlowWndMovie_Status_Alarm_R_ICON_ALARM_RIGHT_Y);
                break;
            case USER_AVLCA_WRN_LEVEL_H:
                bLCA_Alarm_R = TRUE;
                //UxState_SetData(&UIFlowWndMovie_Status_Alarm_RCtrl, STATE_CURITEM, UIFlowWndMovie_Status_Alarm_R_ICON_ALARM_RIGHT_R);
                break;
            default:
                bLCA_Alarm_R = FALSE;
            break;
        }
        //debug_msg("%d,%d\r\n", bLCA_Alarm_L, bLCA_Alarm_R);
    }

    return NVTEVT_PASS;
}
//#MT#lyb -20200331 -end
/*  // cnacle this function // cj 0702
//---------------------UIFlowWndMovie_ADAS_Alert_DisplayCtrl Control List---------------------------
CTRL_LIST_BEGIN(UIFlowWndMovie_ADAS_Alert_Display)
CTRL_LIST_ITEM(UIFlowWndMovie_StatusICN_LDWS_Alert)
CTRL_LIST_ITEM(UIFlowWndMovie_StatusICN_FCWS_Alert)
CTRL_LIST_ITEM(UIFlowWndMovie_StatusICN_SNG_Alert)
CTRL_LIST_END

//----------------------UIFlowWndMovie_ADAS_Alert_DisplayCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_ADAS_Alert_Display)
EVENT_END

//----------------------UIFlowWndMovie_StatusICN_LDWS_AlertCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_StatusICN_LDWS_Alert)
EVENT_END

//----------------------UIFlowWndMovie_StatusICN_FCWS_AlertCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_StatusICN_FCWS_Alert)
EVENT_END

//----------------------UIFlowWndMovie_StatusICN_SNG_AlertCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_StatusICN_SNG_Alert)
EVENT_END
//*/
//---------------------UIFlowWndMovie_BackLightLvl_PanelCtrl Control List---------------------------
CTRL_LIST_BEGIN(UIFlowWndMovie_BackLightLvl_Panel)
CTRL_LIST_ITEM(UIFlowWndMovie_BackLightLvl_Bar)
CTRL_LIST_END

//----------------------UIFlowWndMovie_BackLightLvl_PanelCtrl Event---------------------------
INT32 UIFlowWndMovie_BackLightLvl_Panel_OnTouchPanelPress(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_BackLightLvl_Panel_OnTouchPanelClick(VControl *, UINT32, UINT32 *);

EVENT_BEGIN(UIFlowWndMovie_BackLightLvl_Panel)
EVENT_ITEM(NVTEVT_PRESS,UIFlowWndMovie_BackLightLvl_Panel_OnTouchPanelPress)
EVENT_ITEM(NVTEVT_CLICK ,UIFlowWndMovie_BackLightLvl_Panel_OnTouchPanelClick ) //  NVTEVT_CLICK UIFlowWndMovie_BackLightLvl_Bar_OnTouchPanelClick

EVENT_END
INT32 UIFlowWndMovie_BackLightLvl_Panel_OnTouchPanelPress(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
  INT32 touch_x, touch_y = 0;
  CHKPNT;
  debug_msg("%d %d %d \r\n",paramNum,bFocusBackLightAdj,UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl));

  if(paramNum == 2 && UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl) && !bFocusBackLightAdj)
  {
	 touch_x = (INT32)(paramArray[0]);
	 touch_y = (INT32)(paramArray[1]);
	 bFocusBackLightAdj = TRUE;
	 //UIFlowWndMovie_SetBriAdjBarShowTime(LCD_BRI_LVL_DISP_TIME);
	 iTouchBLAdjHoldPointInit = touch_y;
	 DBGD(iTouchBLAdjHoldPointInit);
	 GxTimer_StopTimer(&uiIgnoreTimerID);

  }
  else
  {

        bFocusBackLightAdj = FALSE;
        GxTimer_StopTimer(&uiIgnoreTimerID);
	}

  return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_BackLightLvl_Panel_OnTouchPanelClick(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	CHKPNT;
	//INT32 BL_Adj_Add_Value;
	INT32 iCur_BL_Value_Bar = 0;
	//INT32 iCur_BL_Pos = 0;
	INT32 iCur_BL_Offest =0;
	INT32 iCur_BL_FinalPos =0;
	INT32 iCur_BL_FinalLig=0;
	FocusOperateCount = 0;// timer count set 0
    iCur_BL_Value = UxCtrl_GetPos(&UIFlowWndMovie_BackLightLvl_BarCtrl, (Ux_RECT *)iCur_BL_Value);
	DBGD(iCur_BL_Value);
    iCur_BL_Offest = paramArray[0];
    DBGD(iCur_BL_Offest);
   //src 206 905==>214 903 
   //dst 306 1006 ==>314  1006

	if (iCur_BL_Offest <314 ||  iCur_BL_Offest == 314 )
	{
   	iCur_BL_FinalPos = 0;// iCur_BL_Offest - 102;
	}else if ( iCur_BL_FinalPos > 1040 ||   iCur_BL_FinalPos == 1040 )
	{
		iCur_BL_FinalPos = 99;
	}else{
		iCur_BL_FinalPos = (iCur_BL_Offest -314)  *0.14;
	}
	DBGD(iCur_BL_FinalPos);
	
	iCur_BL_Value_Bar = (INT32)(UxProgressBar_GetData(&UIFlowWndMovie_BackLightLvl_BarCtrl, PROBAR_CURSTP));
	DBGD(iCur_BL_Value_Bar);
	   	
	UxProgressBar_SetData(&UIFlowWndMovie_BackLightLvl_BarCtrl,PROBAR_CURSTP,iCur_BL_FinalPos ); //iCur_BL_Value_Bar
	UxProgressBar_SetData(&UIFlowWndMovie_BackLightLvl_BarCtrl,PROBAR_TOTSTP,99); //99
#if  1
	GxVideo_SetDeviceCtrl(DOUT1, DISPLAY_DEVCTRL_BRIGHTLVL,iCur_BL_FinalPos );//iCur_BL_Value_Bar
 	//DBGD(iCur_BL_FinalPos);
	//debug_msg("CurLcd:%d\r\n", iCur_BL_FinalPos);  
	SysSetFlag(FL_LCD_BRIGHTNESS,iCur_BL_FinalPos ); //iCur_BL_Value_Bar
	DBGD(SysGetFlag(FL_LCD_BRIGHTNESS));
	//debug_msg("FL_LCD_BRIGHTNESS:%d\r\n", SysGetFlag(FL_LCD_BRIGHTNESS));  
	WndMovie_Delay_SaveMenuCnt = 1;
	return NVTEVT_CONSUME;
#endif
    // Do Nothing ! to avoid click issue!!
       
	if(paramNum == 2 && bFocusBackLightAdj && UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl))
	{
	  //UIFlowWndMovie_SetBriAdjBarShowTime(LCD_BRI_LVL_DISP_TIME);
	
	  DBGD(paramArray[0]);
	   iCur_BL_Value_Bar = (INT32)(UxProgressBar_GetData(&UIFlowWndMovie_BackLightLvl_BarCtrl, PROBAR_CURSTP));
	   DBGD(iCur_BL_Value_Bar);
 
	//	iCur_BL_FinalPos = iCur_BL_Offest/9 +iCur_BL_Value_Bar;
		if (iCur_BL_FinalPos > 99)
		{
			iCur_BL_FinalPos =99;
		}
	   UxProgressBar_SetData(&UIFlowWndMovie_BackLightLvl_BarCtrl,PROBAR_CURSTP,iCur_BL_FinalPos ); //iCur_BL_Value_Bar
    	   UxProgressBar_SetData(&UIFlowWndMovie_BackLightLvl_BarCtrl,PROBAR_TOTSTP,99); //99
    
    	iCur_BL_FinalLig = iCur_BL_FinalPos /9 -10;
	if (iCur_BL_FinalLig > 99 )
	{
		iCur_BL_FinalLig = 99;
	}else if(iCur_BL_FinalLig < 0  ||  iCur_BL_FinalLig == 0 )
	{
		iCur_BL_FinalLig = 0;
	}
	
       GxVideo_SetDeviceCtrl(DOUT1, DISPLAY_DEVCTRL_BRIGHTLVL,iCur_BL_FinalLig );//iCur_BL_Value_Bar

		//GPIOMap_SetLCDBacklightBrightLevel(iCur_BL_FinalLig);
 DBGD(iCur_BL_FinalLig);
	   
	//   debug_msg("CurLcd:%d\r\n", iCur_BL_FinalLig);  
	   SysSetFlag(FL_LCD_BRIGHTNESS,iCur_BL_FinalLig ); //iCur_BL_Value_Bar
	//   	   debug_msg("FL_LCD_BRIGHTNESS:%d\r\n", SysGetFlag(FL_LCD_BRIGHTNESS));  

	}

	return NVTEVT_CONSUME;
}
//----------------------UIFlowWndMovie_BackLightLvl_BarCtrl Event---------------------------
INT32 UIFlowWndMovie_BackLightLvl_Bar_OnTouchPanelPress(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray);

EVENT_BEGIN(UIFlowWndMovie_BackLightLvl_Bar)
//EVENT_ITEM(NVTEVT_CLICK,UIFlowWndMovie_BackLightLvl_Bar_OnTouchPanelClick ) // UIFlowWndMovie_BackLightLvl_Bar_OnTouchPanelClick
//EVENT_ITEM(NVTEVT_USER_PRESS,UIFlowWndMovie_BackLightLvl_Bar_OnTouchPanelPress)
EVENT_END

INT32 UIFlowWndMovie_BackLightLvl_Bar_OnTouchPanelPress(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_EMRBarCtrl))
	{
		return NVTEVT_CONSUME;
	}
	
	INT32 touch_x, touch_y = 0;
	CHKPNT;
   
	if(paramNum == 2 && UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_BarCtrl) && !bFocusBackLightAdj)
	{
       //Ux_RECT CtrlRect;
       Ux_RECT CtrlRect_Parent;
     //  UxCtrl_GetPos(&UIFlowWndMovie_BackLightLvl_BarCtrl, &CtrlRect_Parent );//CtrlRect		
       UxCtrl_GetPos(&UIFlowWndMovie_BackLightLvl_PanelCtrl, &CtrlRect_Parent);
      // DBGD(CtrlRect.x1);
       //DBGD(CtrlRect_Parent.x1);
	  //DBGD(paramArray[0]);
	  //DBGD(paramArray[1]);
       //touch_x = (INT32)(paramArray[0] + CtrlRect_Parent.x1 + CtrlRect.x1);
       //touch_y = (INT32)(paramArray[1] + CtrlRect_Parent.y1 + CtrlRect.y1);
       touch_x = (INT32)(paramArray[0] + CtrlRect_Parent.x1);
       touch_y = (INT32)(paramArray[1] + CtrlRect_Parent.y1);	   
	   bFocusBackLightAdj = TRUE;
	  // UIFlowWndMovie_SetBriAdjBarShowTime(LCD_BRI_LVL_DISP_TIME);
	   iTouchBLAdjHoldPointInit = touch_x;
	//   DBGD(iTouchBLAdjHoldPointInit);
	   iTranPointInit =  iTouchBLAdjHoldPointInit;//cj
	   GxTimer_StopTimer(&uiIgnoreTimerID);
	}
	else
	{   
	   
		bFocusBackLightAdj = FALSE;
		GxTimer_StopTimer(&uiIgnoreTimerID);
	}
    // Do Nothing ! to avoid click issue!!
	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_BackLightLvl_Bar_OnTouchPanelClick(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	CHKPNT;
	//INT32 BL_Adj_Add_Value;
	INT32 iCur_BL_Value_Bar = 0;
	//INT32 iCur_BL_Pos = 0;
	INT32 iCur_BL_Offest =0;
	INT32 iCur_BL_FinalPos =0;
	//INT32 iCur_BL_FinalLig=0;

	iCur_BL_Value = UxCtrl_GetPos(&UIFlowWndMovie_BackLightLvl_BarCtrl, (Ux_RECT *)iCur_BL_Value);
	DBGD(iCur_BL_Value);
	iCur_BL_Offest = paramArray[0];
	DBGD(iCur_BL_Offest);
	//src 206 905==>214 903 
	//dst 306 1006 ==>314  1006
#if 0
	if (iCur_BL_Offest <214 ||  iCur_BL_Offest == 214 )
	{
	iCur_BL_FinalPos = 0;// iCur_BL_Offest - 102;
	}else if ( iCur_BL_FinalPos > 903 ||   iCur_BL_FinalPos == 903 )
	{
	iCur_BL_FinalPos = 99;
	}else{
	iCur_BL_FinalPos = (iCur_BL_Offest -214)  *0.14;
	}
#else 
	if (iCur_BL_Offest <314 ||  iCur_BL_Offest == 314 )
	{
		iCur_BL_FinalPos = 0;// iCur_BL_Offest - 102;
	}else if ( iCur_BL_FinalPos > 1040 || iCur_BL_FinalPos == 1040 ){
		iCur_BL_FinalPos = 99;
	}else{
		iCur_BL_FinalPos = ((iCur_BL_Offest -314)  *100)/(1040-314);
	}
#endif
	DBGD(iCur_BL_FinalPos);

	iCur_BL_Value_Bar = (INT32)(UxProgressBar_GetData(&UIFlowWndMovie_BackLightLvl_BarCtrl, PROBAR_CURSTP));
	DBGD(iCur_BL_Value_Bar);
	//if( iCur_BL_Value_Bar )

	UxProgressBar_SetData(&UIFlowWndMovie_BackLightLvl_BarCtrl,PROBAR_CURSTP,iCur_BL_FinalPos ); //iCur_BL_Value_Bar
	UxProgressBar_SetData(&UIFlowWndMovie_BackLightLvl_BarCtrl,PROBAR_TOTSTP,99); //99
#if  1
	GxVideo_SetDeviceCtrl(DOUT1, DISPLAY_DEVCTRL_BRIGHTLVL,iCur_BL_FinalPos );//iCur_BL_Value_Bar
	//DBGD(iCur_BL_FinalPos);

	//debug_msg("CurLcd:%d\r\n", iCur_BL_FinalPos);  
	SysSetFlag(FL_LCD_BRIGHTNESS,iCur_BL_FinalPos ); //iCur_BL_Value_Bar
	//debug_msg("FL_LCD_BRIGHTNESS:%d\r\n", SysGetFlag(FL_LCD_BRIGHTNESS));  
	return NVTEVT_CONSUME;
#endif
	// Do Nothing ! to avoid click issue!!

}
//---------------------UIFlowWndMovie_Panel_TopNormalCtrl Control List---------------------------
CTRL_LIST_BEGIN(UIFlowWndMovie_Panel_TopNormal)
CTRL_LIST_ITEM(UIFlowWndMovie_Static_RecTxt)
CTRL_LIST_ITEM(UIFlowWndMovie_Status_Movie_F)
CTRL_LIST_ITEM(UIFlowWndMovie_Status_Movie_B)
CTRL_LIST_ITEM(UIFlowWndMovie_Status_Icon0)
CTRL_LIST_ITEM(UIFlowWndMovie_Status_Icon1)
CTRL_LIST_ITEM(UIFlowWndMovie_Status_Icon2)
//CTRL_LIST_ITEM(UIFlowWndMovie_Status_Icon3)
//CTRL_LIST_ITEM(UIFlowWndMovie_Status_Icon4)
CTRL_LIST_ITEM(UIFlowWndMovie_StatusText)
CTRL_LIST_END

//----------------------UIFlowWndMovie_Panel_TopNormalCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Panel_TopNormal)
EVENT_END

//----------------------UIFlowWndMovie_Static_RecTxtCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Static_RecTxt)
EVENT_END

//----------------------UIFlowWndMovie_Status_Movie_FCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Status_Movie_F)
EVENT_END

//----------------------UIFlowWndMovie_Status_Movie_BCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Status_Movie_B)
EVENT_END

//----------------------UIFlowWndMovie_Status_Icon0Ctrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Status_Icon0)
EVENT_END

//----------------------UIFlowWndMovie_Status_Icon1Ctrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Status_Icon1)
EVENT_END

//----------------------UIFlowWndMovie_Status_Icon2Ctrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Status_Icon2)
EVENT_END

//----------------------UIFlowWndMovie_Status_Icon3Ctrl Event---------------------------
//EVENT_BEGIN(UIFlowWndMovie_Status_Icon3)
//EVENT_END

//----------------------UIFlowWndMovie_Status_Icon4Ctrl Event---------------------------
//EVENT_BEGIN(UIFlowWndMovie_Status_Icon4)
//EVENT_END

//----------------------UIFlowWndMovie_StatusTextCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_StatusText)
EVENT_END

//---------------------UIFlowWndMovie_Panel_RecUrgCtrl Control List---------------------------
CTRL_LIST_BEGIN(UIFlowWndMovie_Panel_RecUrg)
CTRL_LIST_ITEM(UIFlowWndMovie_Static_RecUrgTxt)
CTRL_LIST_ITEM(UIFlowWndMovie_Static_RecUrgIcon)
CTRL_LIST_END

//----------------------UIFlowWndMovie_Panel_RecUrgCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Panel_RecUrg)
EVENT_END

//----------------------UIFlowWndMovie_Static_RecUrgTxtCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Static_RecUrgTxt)
EVENT_END

//----------------------UIFlowWndMovie_Static_RecUrgIconCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Static_RecUrgIcon)
EVENT_END

//----------------------UIFlowWndMovie_Status_RECCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Status_REC)
EVENT_END

//---------------------UIFlowWndMovie_Panel_DatetimeCtrl Control List---------------------------
CTRL_LIST_BEGIN(UIFlowWndMovie_Panel_Datetime)
CTRL_LIST_ITEM(UIFlowWndMovie_Status_TimeHourH)
CTRL_LIST_ITEM(UIFlowWndMovie_Status_TimeHourL)
CTRL_LIST_ITEM(UIFlowWndMovie_Status_TimeMinH)
CTRL_LIST_ITEM(UIFlowWndMovie_Status_TimeMinL)
CTRL_LIST_ITEM(UIFlowWndMovie_Static_Mark)
CTRL_LIST_ITEM(UIFlowWndMovie_Static_DateTxtM)
CTRL_LIST_ITEM(UIFlowWndMovie_Static_DateM)
CTRL_LIST_ITEM(UIFlowWndMovie_Static_DateTxtD)
CTRL_LIST_ITEM(UIFlowWndMovie_Static_DateD)
CTRL_LIST_ITEM(UIFlowWndMovie_Status_Week)
CTRL_LIST_END

//----------------------UIFlowWndMovie_Panel_DatetimeCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Panel_Datetime)
EVENT_END

//----------------------UIFlowWndMovie_Status_TimeHourHCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Status_TimeHourH)
EVENT_END

//----------------------UIFlowWndMovie_Status_TimeHourLCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Status_TimeHourL)
EVENT_END

//----------------------UIFlowWndMovie_Status_TimeMinHCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Status_TimeMinH)
EVENT_END

//----------------------UIFlowWndMovie_Status_TimeMinLCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Status_TimeMinL)
EVENT_END

//----------------------UIFlowWndMovie_Static_MarkCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Static_Mark)
EVENT_END

//----------------------UIFlowWndMovie_Static_DateTxtMCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Static_DateTxtM)
EVENT_END

//----------------------UIFlowWndMovie_Static_DateMCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Static_DateM)
EVENT_END

//----------------------UIFlowWndMovie_Static_DateTxtDCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Static_DateTxtD)
EVENT_END

//----------------------UIFlowWndMovie_Static_DateDCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Static_DateD)
EVENT_END

//----------------------UIFlowWndMovie_Status_WeekCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Status_Week)
EVENT_END

//---------------------UIFlowWndMovie_Panel_OperateCtrl Control List---------------------------
CTRL_LIST_BEGIN(UIFlowWndMovie_Panel_Operate)
CTRL_LIST_ITEM(UIFlowWndMovie_BTN_UrgRec)
CTRL_LIST_ITEM(UIFlowWndMovie_BTN_PIP)
CTRL_LIST_ITEM(UIFlowWndMovie_BTN_BackLightLvl)
CTRL_LIST_ITEM(UIFlowWndMovie_BTN_PlayBack)
CTRL_LIST_ITEM(UIFlowWndMovie_BTN_Setup)
CTRL_LIST_ITEM(UIFlowWndMovie_BTN_Behind)
CTRL_LIST_ITEM(UIFlowWndMovie_BTN_Front)
CTRL_LIST_END

//----------------------UIFlowWndMovie_Panel_OperateCtrl Event---------------------------
INT32 UIFlowWndMovie_Panel_Operate_OnTouchPanelRelease(VControl *, UINT32, UINT32 *);

EVENT_BEGIN(UIFlowWndMovie_Panel_Operate)
//EVENT_ITEM(NVTEVT_USER_RELEASE,UIFlowWndMovie_Panel_Operate_OnTouchPanelRelease)

EVENT_END
INT32 UIFlowWndMovie_Panel_Operate_OnTouchPanelRelease(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	CHKPNT;
	 return NVTEVT_CONSUME;
}
//----------------------UIFlowWndMovie_BTN_RecURGCtrl Event---------------------------
INT32 UIFlowWndMovie_BTN_UrgRec_OnTouchPanelClick(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_BTN_UrgRec_OnTouchPanelRelease(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_BTN_UrgRec_OnTouchPanelPress(VControl *, UINT32, UINT32 *);

EVENT_BEGIN(UIFlowWndMovie_BTN_UrgRec)
EVENT_ITEM(NVTEVT_CLICK,UIFlowWndMovie_BTN_UrgRec_OnTouchPanelClick)
EVENT_ITEM(NVTEVT_USER_RELEASE,UIFlowWndMovie_BTN_UrgRec_OnTouchPanelRelease)
EVENT_ITEM(NVTEVT_PRESS,UIFlowWndMovie_BTN_UrgRec_OnTouchPanelPress)
EVENT_ITEM(NVTEVT_USER_PRESS,UIFlowWndMovie_BTN_UrgRec_OnTouchPanelPress)
EVENT_END



INT32 UIFlowWndMovie_BTN_UrgRec_OnTouchPanelClick(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{



	debug_msg("gMovData.State:%d \r\n",gMovData.State);
		switch (gMovData.State) {
		case MOV_ST_REC:
			if ( UIFlowWndMovie_GetRecLockStatus() == TRUE) 
			{
			CHKPNT;
				 return NVTEVT_CONSUME;
				//   UxCtrl_SetShow(&UIFlowWndMovie_ConfirmPanelCtrl, TRUE);
			}else{
			CHKPNT;
				Ux_PostEvent(NVTEVT_KEY_CUSTOM1, 1, NVTEVT_KEY_RELEASE);//
			}
 			break;  
 		default:
			//has card
			if (UIStorageCheck(STORAGE_CHECK_ERROR, NULL) == TRUE) {
			//	Ux_OpenWindow(&UIFlowWndWrnMsgCtrl, 2, UIFlowWndWrnMsg_StatusTXT_Msg_STRID_PLEASE_INSERT_SD, FLOWWRNMSG_TIMER_3SEC);
			//	 return NVTEVT_CONSUME;
			}
			CHKPNT;
			Ux_PostEvent(NVTEVT_KEY_SHUTTER2, 1, NVTEVT_KEY_PRESS);

			 Delay_DelayMs(100);

			Ux_PostEvent(NVTEVT_KEY_CUSTOM1, 1, NVTEVT_KEY_RELEASE);//
			CHKPNT;
			break;
		}	
	TESTLOG("");
	//UIFlowWndMovie_SetRecLockStatus(TRUE); 
	//g_bRecordLock = TRUE;
	// Ux_PostEvent(NVTEVT_KEY_SHUTTER2, 1, NVTEVT_KEY_PRESS);
    
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_BTN_UrgRec_OnTouchPanelRelease(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
 //TESTLOG("");

	if  (UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl) )
	{
		return NVTEVT_CONSUME;
		UxCtrl_SetShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl, FALSE);
		//Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_SETLCDBRIGHTLVL, 1, SysGetFlag(FL_LCD_BRIGHTNESS));

	}
	
	if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_EMRBarCtrl))
	{
		return NVTEVT_CONSUME;
	}
	UxButton_SetItemData(&UIFlowWndMovie_BTN_UrgRecCtrl, 0, BTNITM_ICONID, ICON_OPERATE_URG);

	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_BTN_UrgRec_OnTouchPanelPress(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_EMRBarCtrl))
	{
		return NVTEVT_CONSUME;
	}
	        UxButton_SetItemData(&UIFlowWndMovie_BTN_UrgRecCtrl, 0, BTNITM_ICONID, ICON_OPERATE_URG_F );

	return NVTEVT_CONSUME;
}
//----------------------UIFlowWndMovie_BTN_PIPCtrl Event---------------------------
INT32 UIFlowWndMovie_BTN_PIP_OnTouchPanelClick(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_BTN_PIP_OnTouchPanelRelease(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_BTN_PIP_OnTouchPanelPress(VControl *, UINT32, UINT32 *);


EVENT_BEGIN(UIFlowWndMovie_BTN_PIP)
EVENT_ITEM(NVTEVT_CLICK,UIFlowWndMovie_BTN_PIP_OnTouchPanelClick)
EVENT_ITEM(NVTEVT_USER_RELEASE,UIFlowWndMovie_BTN_PIP_OnTouchPanelRelease)
EVENT_ITEM(NVTEVT_PRESS,UIFlowWndMovie_BTN_PIP_OnTouchPanelPress)
EVENT_ITEM(NVTEVT_USER_PRESS,UIFlowWndMovie_BTN_PIP_OnTouchPanelPress)

EVENT_END

INT32 UIFlowWndMovie_BTN_PIP_OnTouchPanelClick(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	FocusOperateCount = 0;
 //if(EthCamNet_GetEthLinkStatus(0) == ETHCAM_LINK_UP)
	debug_msg("EthCamNet_GetEthLinkStatus: %d \r\n",EthCamNet_GetEthLinkStatus(0));
 	DBGD(bFocusBackLightAdj);
	if(!bFocusBackLightAdj) {
		if(SysGetFlag(FL_DUAL_CAM) == DUALCAM_FRONT  ) {
			CHKPNT;
			if((bflag_EthLinkFinish == TRUE && socketCliEthData1_IsRecv(ETHCAM_PATH_ID_1))){
				SysSetFlag(FL_DUAL_CAM_MENU, DUALCAM_BEHIND);
				SysSetFlag(FL_DUAL_CAM,DUALCAM_BEHIND);
			}else{
				CloseTimer();
				Ux_OpenWindow(&UIFlowWndWaitMomentCtrl, 1, UIFlowWndWaitMoment_StatusTXT_Msg_STRID_ETHCAM_DETFAIL);
			}
		}else {
			SysSetFlag(FL_DUAL_CAM_MENU, DUALCAM_FRONT);
			SysSetFlag(FL_DUAL_CAM,DUALCAM_FRONT);
		}
	}
  //      Ux_PostEvent(NVTEVT_KEY_SELECT, 1, NVTEVT_KEY_PRESS);
    return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_BTN_PIP_OnTouchPanelPress(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
 TESTLOG("");
	if  (UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl) )
	{
		UxCtrl_SetShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl, FALSE);
		//Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_SETLCDBRIGHTLVL, 1, SysGetFlag(FL_LCD_BRIGHTNESS));
	}
		
	if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_EMRBarCtrl))
	{
		return NVTEVT_CONSUME;
	}

	UxButton_SetItemData(&UIFlowWndMovie_BTN_PIPCtrl, 0, BTNITM_ICONID, ICON_OPERATE_PIP_F );

	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_BTN_PIP_OnTouchPanelRelease(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_EMRBarCtrl))
	{
		return NVTEVT_CONSUME;
	}

	UxButton_SetItemData(&UIFlowWndMovie_BTN_PIPCtrl, 0, BTNITM_ICONID, ICON_OPERATE_PIP);

	return NVTEVT_CONSUME;
}

//----------------------UIFlowWndMovie_BTN_BackLightLvlCtrl Event---------------------------
INT32 UIFlowWndMovie_BTN_BackLightLvl_OnTouchPanelClick(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_BTN_BackLightLvl_OnTouchPanelRelease(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_BTN_BackLightLvl_OnTouchPanelPress(VControl *, UINT32, UINT32 *);

EVENT_BEGIN(UIFlowWndMovie_BTN_BackLightLvl)
EVENT_ITEM(NVTEVT_CLICK,UIFlowWndMovie_BTN_BackLightLvl_OnTouchPanelClick)
EVENT_ITEM(NVTEVT_USER_RELEASE,UIFlowWndMovie_BTN_BackLightLvl_OnTouchPanelRelease)
EVENT_ITEM(NVTEVT_PRESS,UIFlowWndMovie_BTN_BackLightLvl_OnTouchPanelPress)
EVENT_ITEM(NVTEVT_USER_PRESS,UIFlowWndMovie_BTN_BackLightLvl_OnTouchPanelPress)
EVENT_END


INT32 UIFlowWndMovie_BTN_BackLightLvl_OnTouchPanelClick(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{

//-------------------------Test:      update Tx
//#MT#lyb -20200415 -begin
{
#if  0// (ETHCAM_TX_UPDATE_TEST == ENABLE)
    static BOOL bTxUpdateOK = FALSE;
    if(!bTxUpdateOK)
    {
    //    TESTLOG("txupdate 0");
        if(EthCamNet_GetEthLinkStatus(0) == ETHCAM_LINK_UP)
        {
        	
          //  TESTLOG("txupdate 1");
            if(bflag_EthLinkFinish)
            {
             //   TESTLOG("txupdate 2");
                if(Ethcam_tx_DetFwAutoUpdate())
                {
                   TESTLOG("txupdate finish ");
                    bTxUpdateOK = TRUE;

			Ux_OpenWindow(&UIFlowWndWaitMomentCtrl, 1,UIFlowWndWaitMoment_StatusTXT_Msg_STRID_ETHCAM_UDFW_FINISH);
			return NVTEVT_CONSUME;
                }else{
                
			TESTLOG("txupdate no file "); //MT CJ 2020/420
                }
            }
        }
    }
   
#endif
}
//#MT#lyb -20200415 -end
if  ( UI_GetData(FL_MOVIE_BACKADJUST ) == MOVIE_BACKADJUST_ON)
{
	CloseTimer();
	Ux_OpenWindow(&UIFlowWndWaitMomentCtrl, 1,UIFlowWndWaitMoment_StatusTXT_Msg_STRID_MOVIE_BACK_MSG);
	return NVTEVT_CONSUME;
}else {
	debug_msg("IsShow: %d %d \r\n",UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl), UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_BarCtrl));
	//------------------------------
    if(!UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl))
    {
	   	CHKPNT;
        FlowMovie_DrawBrightnessBar(TRUE);
		FocusOperateCount = 0;
		FocusOperate = TRUE;
		UxCtrl_SetShow(&UIFlowWndMovie_Panel_OperateCtrl,FALSE);
        UxProgressBar_SetData(&UIFlowWndMovie_BackLightLvl_BarCtrl,PROBAR_CURSTP, SysGetFlag(FL_LCD_BRIGHTNESS) ); //iCur_BL_Value_Bar
		UxProgressBar_SetData(&UIFlowWndMovie_BackLightLvl_BarCtrl,PROBAR_TOTSTP,99); //99
        //UIFlowWndMovie_SetBriAdjBarShowTime(LCD_BRI_LVL_DISP_TIME);
         //UI_SetTouchEventMask(NVTEVT_USER_SLIDE_LEFT);
         //UI_SetTouchEventMask(NVTEVT_USER_SLIDE_RIGHT);
		 //UI_SetTouchEventMask(NVTEVT_USER_SLIDE_UP);
		 //UI_SetTouchEventMask(NVTEVT_USER_SLIDE_DOWN);
    }else{
		FlowMovie_DrawBrightnessBar(FALSE);  
		FocusOperateCount = 0;
		FocusOperate = FALSE;
		//UIFlowWndMovie_SetBriAdjBarShowTime(LCD_BRI_LVL_DISP_TIME);
		//UI_CancelTouchEventMask(NVTEVT_USER_SLIDE_LEFT);
		//UI_CancelTouchEventMask(NVTEVT_USER_SLIDE_RIGHT);
		//UI_CancelTouchEventMask(NVTEVT_USER_SLIDE_UP);
		//UI_CancelTouchEventMask(NVTEVT_USER_SLIDE_DOWN);
		CHKPNT;
		//Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_SETLCDBRIGHTLVL, 1, SysGetFlag(FL_LCD_BRIGHTNESS));
	}
}
	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_BTN_BackLightLvl_OnTouchPanelPress(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
 TESTLOG("");
	if  (UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl) )
	{
	//	UxCtrl_SetShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl, FALSE);
	//	Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_SETLCDBRIGHTLVL, 1, SysGetFlag(FL_LCD_BRIGHTNESS));

	}
		
	if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_EMRBarCtrl))
	{
		return NVTEVT_CONSUME;
	}
    UxButton_SetItemData(&UIFlowWndMovie_BTN_BackLightLvlCtrl, 0, BTNITM_ICONID, ICON_OPERATE_BL_F );
    return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_BTN_BackLightLvl_OnTouchPanelRelease(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_EMRBarCtrl))
	{
		return NVTEVT_CONSUME;
	}
    UxButton_SetItemData(&UIFlowWndMovie_BTN_BackLightLvlCtrl, 0, BTNITM_ICONID,ICON_OPERATE_BL );
    return NVTEVT_CONSUME;
}

//----------------------UIFlowWndMovie_BTN_PlaybackCtrl Event---------------------------

INT32 UIFlowWndMovie_BTN_PlayBack_OnTouchPanelClick(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_BTN_PlayBack_OnTouchPanelPress(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_BTN_PlayBack_OnTouchPanelRelease(VControl *, UINT32, UINT32 *);

EVENT_BEGIN(UIFlowWndMovie_BTN_PlayBack)
EVENT_ITEM(NVTEVT_CLICK,UIFlowWndMovie_BTN_PlayBack_OnTouchPanelClick)
EVENT_ITEM(NVTEVT_PRESS,UIFlowWndMovie_BTN_PlayBack_OnTouchPanelPress)
EVENT_ITEM(NVTEVT_USER_RELEASE,UIFlowWndMovie_BTN_PlayBack_OnTouchPanelRelease)
EVENT_ITEM(NVTEVT_USER_PRESS,UIFlowWndMovie_BTN_PlayBack_OnTouchPanelPress)

EVENT_END


INT32 UIFlowWndMovie_BTN_PlayBack_OnTouchPanelClick(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	CHKPNT;
	if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_EMRBarCtrl))
	{
		return NVTEVT_CONSUME;
	}
	#if 1
	if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_BehindCtrl))
	{
		HideBehindBar();
	}
	
	if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_OperateCtrl) )
	{
		UxCtrl_SetShow(&UIFlowWndMovie_Panel_OperateCtrl, FALSE);
		FocusOperateCount = 0;
		FocusOperate = FALSE;
	}
	
	if  (UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl) )
	{
		UxCtrl_SetShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl, FALSE);
		UxCtrl_SetShow(&UIFlowWndMovie_BehindProgressBarCtrl, FALSE);
		UxCtrl_SetShow(&UIFlowWndMovie_LCDStaticCtrl, FALSE);
		FocusOperateCount = 0;
		FocusOperate = FALSE;
	}				
	#endif
	
	if (System_GetState(SYS_STATE_CARD)  == CARD_REMOVED) {
		CHKPNT;
		Ux_OpenWindow(&UIFlowWndWrnMsgCtrl, 2, UIFlowWndWrnMsg_StatusTXT_Msg_STRID_PLEASE_INSERT_SD, FLOWWRNMSG_TIMER_2SEC);
		return NVTEVT_CONSUME;
	}

	autoRec = FALSE;
	FocusOperate = FALSE;
	FocusOperateCount = 0; 
	isStopREC = TRUE; // use this flag to change mode 
	debug_msg("UIFlowWndMovie_BTN_PlayBack_OnTouchPanelClick  gMovData.State: %d \r\n ",gMovData.State);
	switch (gMovData.State) {
		case MOV_ST_VIEW:
			isStopREC = TRUE;
			Delay_DelayMs(1000);
			Ux_SendEvent(0, NVTEVT_SYSTEM_MODE, 1, PRIMARY_MODE_PLAYMENU);
			break;
		case MOV_ST_REC:
			if ( UIFlowWndMovie_GetRecLockStatus() == TRUE) 
			{
				UIFlowWndMovie_SetRecLockStatus(FALSE);
			}

			//FlowMovie_StopRec();
			Ux_PostEvent(NVTEVT_KEY_SHUTTER2, 1, NVTEVT_KEY_PRESS);
			//Ux_OpenWindow(&UIFlowWndWaitMomentCtrl, 1, UIFlowWndWaitMoment_StatusTXT_Msg_STRID_STOPREC_WAIT);
			isStopREC  = TRUE;
			CHKPNT;
			//if (g_UIStopRecTimerID == NULL_TIMER) {
				//        g_UIStopRecTimerID = GxTimer_StartTimer(100, NVTEVT_01SEC_TIMER, CONTINUE);
			//}
			//g_uiRecStopTimerCnt=10;
			break;
		default:
			break;
	}
	//	Ux_SendEvent(0, NVTEVT_SYSTEM_MODE, 1, PRIMARY_MODE_PLAYMENU);

//	 Ux_OpenWindow((VControl *)(&MenuCommonPlayMenuCtrl), 0);// UIFlowWndPlayCtrl
			return NVTEVT_CONSUME;   
}
INT32 UIFlowWndMovie_BTN_PlayBack_OnTouchPanelPress(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{ 
TESTLOG("");
	if  (UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl) )
	{
		UxCtrl_SetShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl, FALSE);
		//Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_SETLCDBRIGHTLVL, 1, SysGetFlag(FL_LCD_BRIGHTNESS));

	}
	
	if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_EMRBarCtrl))
	{
		return NVTEVT_CONSUME;
	}
	UxButton_SetItemData(&UIFlowWndMovie_BTN_PlayBackCtrl, 0, BTNITM_ICONID, ICON_OPERATE_PB_F );

	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_BTN_PlayBack_OnTouchPanelRelease(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_EMRBarCtrl))
	{
		return NVTEVT_CONSUME;
	}
	        UxButton_SetItemData(&UIFlowWndMovie_BTN_PlayBackCtrl, 0, BTNITM_ICONID, ICON_OPERATE_PB);

	return NVTEVT_CONSUME;
}

//----------------------UIFlowWndMovie_BTN_FrontCtrl Event---------------------------
INT32 UIFlowWndMovie_BTN_Front_OnTouchPanelClick(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_BTN_Front_OnTouchPanelPress(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_BTN_Front_OnTouchPanelRelease(VControl *, UINT32, UINT32 *);

EVENT_BEGIN(UIFlowWndMovie_BTN_Front)
EVENT_ITEM(NVTEVT_CLICK,UIFlowWndMovie_BTN_Front_OnTouchPanelClick)
EVENT_ITEM(NVTEVT_PRESS,UIFlowWndMovie_BTN_Front_OnTouchPanelPress)
EVENT_ITEM(NVTEVT_USER_RELEASE,UIFlowWndMovie_BTN_Front_OnTouchPanelRelease)
EVENT_ITEM(NVTEVT_USER_PRESS,UIFlowWndMovie_BTN_Front_OnTouchPanelPress)
EVENT_END
BOOL isIMG_Front = FALSE;
INT32 UIFlowWndMovie_BTN_Front_OnTouchPanelClick(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
		CHKPNT;
			
			if(SysGetFlag(FL_DUAL_CAM) == DUALCAM_BEHIND  )
			{
				debug_msg("---CJ only behind \r\n");
				CloseTimer();
				Ux_OpenWindow(&UIFlowWndWaitMomentCtrl,1,UIFlowWndWaitMoment_StatusTXT_Msg_STRID_ETHCAM_CHANGE_FRONTCAM);
				return NVTEVT_CONSUME;
			}
			
			if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_BehindCtrl))
			{
				CHKPNT;
				HideBehindBar();
				return NVTEVT_CONSUME;
			}else{
				CHKPNT;
				if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_OperateCtrl) )
				{
					UxCtrl_SetShow(&UIFlowWndMovie_Panel_OperateCtrl, FALSE);
					FocusOperateCount = 0;
					FocusOperate = FALSE;
				}
				if  (UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl) )
				{
					UxCtrl_SetShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl, FALSE);
					UxCtrl_SetShow(&UIFlowWndMovie_BehindProgressBarCtrl, FALSE);
					UxCtrl_SetShow(&UIFlowWndMovie_LCDStaticCtrl, FALSE);
					FocusOperateCount = 0;
					FocusOperate = FALSE;
				}
					isIMG_Front = TRUE;
					bFoucusBehindPanel = FALSE;
					FoucusBhindPanelCount = 0;
					DrawBehindBar();
//					UxCtrl_SetShow(&UIFlowWndMovie_Panel_BehindCtrl, TRUE);
//					UxCtrl_SetShow(&UIFlowWndMovie_BTN_BehindUPCtrl, TRUE);
//					UxCtrl_SetShow(&UIFlowWndMovie_BehindProgressBarCtrl, FALSE);
//					UxCtrl_SetShow(&UIFlowWndMovie_BTN_BehindDownCtrl, TRUE);
					//Ux_PostEvent(NVTEVT_KEY_SHUTTER2, 3, NVTEVT_KEY_PRESS, 0, UIFlowWndMovie_Restart_Rec);
					FlowMovie_IconHideDateTime();	//zjf add 20200820
				    bFoucusBehindPanel = TRUE;
				   
				   return NVTEVT_CONSUME;
			}

    return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_BTN_Front_OnTouchPanelPress(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	UxButton_SetItemData(&UIFlowWndMovie_BTN_FrontCtrl, 0, BTNITM_ICONID, ICON_OPERATE_SENSOR_F_F);
    return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_BTN_Front_OnTouchPanelRelease(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	UxButton_SetItemData(&UIFlowWndMovie_BTN_FrontCtrl, 0, BTNITM_ICONID, ICON_OPERATE_SENSOR_F);
	return NVTEVT_CONSUME;
}


//----------------------UIFlowWndMovie_BTN_BehindCtrl Event---------------------------
INT32 UIFlowWndMovie_BTN_Behind_OnTouchPanelClick(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_BTN_Behind_OnTouchPanelPress(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_BTN_Behind_OnTouchPanelRelease(VControl *, UINT32, UINT32 *);

EVENT_BEGIN(UIFlowWndMovie_BTN_Behind)
EVENT_ITEM(NVTEVT_CLICK,UIFlowWndMovie_BTN_Behind_OnTouchPanelClick)
EVENT_ITEM(NVTEVT_PRESS,UIFlowWndMovie_BTN_Behind_OnTouchPanelPress)
EVENT_ITEM(NVTEVT_USER_RELEASE,UIFlowWndMovie_BTN_Behind_OnTouchPanelRelease)
EVENT_ITEM(NVTEVT_USER_PRESS,UIFlowWndMovie_BTN_Behind_OnTouchPanelPress)

EVENT_END

INT32 UIFlowWndMovie_BTN_Behind_OnTouchPanelClick(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
		CHKPNT;
			if(SysGetFlag(FL_DUAL_CAM) == DUALCAM_FRONT  )
			{
				debug_msg("---CJ only front \r\n");
				CloseTimer();
				Ux_OpenWindow(&UIFlowWndWaitMomentCtrl,1,UIFlowWndWaitMoment_StatusTXT_Msg_STRID_ETHCAM_CHANGE_BEHINDCAM);
				return NVTEVT_CONSUME;
			}
			if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_BehindCtrl))
			{
				CHKPNT;
				HideBehindBar();
				return NVTEVT_CONSUME;
			}else{
				CHKPNT;
				if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_OperateCtrl) )
				{
					UxCtrl_SetShow(&UIFlowWndMovie_Panel_OperateCtrl, FALSE);
					FocusOperateCount = 0;
					FocusOperate = FALSE;
				}
				if  (UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl) )
				{
					UxCtrl_SetShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl, FALSE);
					UxCtrl_SetShow(&UIFlowWndMovie_BehindProgressBarCtrl, FALSE);
					UxCtrl_SetShow(&UIFlowWndMovie_LCDStaticCtrl, FALSE);
					FocusOperateCount = 0;
					FocusOperate = FALSE;
				}
					isIMG_Front = FALSE;
					DrawBehindBar();
					//Ux_PostEvent(NVTEVT_KEY_SHUTTER2, 3, NVTEVT_KEY_PRESS, 0, UIFlowWndMovie_Restart_Rec);
					FlowMovie_IconHideDateTime();	//zjf add 20200820
				    bFoucusBehindPanel = TRUE;
				   
				   return NVTEVT_CONSUME;
			}

    return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_BTN_Behind_OnTouchPanelPress(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	UxButton_SetItemData(&UIFlowWndMovie_BTN_BehindCtrl, 0, BTNITM_ICONID, ICON_OPERATE_SENSOR_B_F);
    return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_BTN_Behind_OnTouchPanelRelease(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	UxButton_SetItemData(&UIFlowWndMovie_BTN_BehindCtrl, 0, BTNITM_ICONID, ICON_OPERATE_SENSOR_B);
	return NVTEVT_CONSUME;
}

//----------------------UIFlowWndMovie_BTN_SetupCtrl Event---------------------------
INT32 UIFlowWndMovie_BTN_Setup_OnTouchPanelPress(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_BTN_Setup_OnTouchPanelRelease(VControl *, UINT32, UINT32 *);

INT32 UIFlowWndMovie_BTN_Setup_OnTouchPanelClick(VControl *, UINT32, UINT32 *);
EVENT_BEGIN(UIFlowWndMovie_BTN_Setup)
EVENT_ITEM(NVTEVT_CLICK,UIFlowWndMovie_BTN_Setup_OnTouchPanelClick)
EVENT_ITEM(NVTEVT_PRESS,UIFlowWndMovie_BTN_Setup_OnTouchPanelPress)
EVENT_ITEM(NVTEVT_USER_RELEASE,UIFlowWndMovie_BTN_Setup_OnTouchPanelRelease)
EVENT_ITEM(NVTEVT_USER_PRESS,UIFlowWndMovie_BTN_Setup_OnTouchPanelPress)

EVENT_END

INT32 UIFlowWndMovie_BTN_Setup_OnTouchPanelClick(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_EMRBarCtrl))
	{
		return NVTEVT_CONSUME;
	}
    TESTLOG("");
	FocusOperate = FALSE;
	FocusOperateCount = 0;
	switch (gMovData.State) {
		case MOV_ST_VIEW:
			break;
		case MOV_ST_REC:
			if ( UIFlowWndMovie_GetRecLockStatus() == TRUE) 
			{
				UIFlowWndMovie_SetRecLockStatus(FALSE);
			}
			//Ux_PostEvent(NVTEVT_KEY_SHUTTER2, 1, NVTEVT_KEY_PRESS);
			break;
		default:
			break;
		}
    Ux_PostEvent(NVTEVT_KEY_MENU, 1, NVTEVT_KEY_PRESS);
	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_BTN_Setup_OnTouchPanelPress(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    TESTLOG("");
	if  (UxCtrl_IsShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl) )
	{
		UxCtrl_SetShow(&UIFlowWndMovie_BackLightLvl_PanelCtrl, FALSE);
		//Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_SETLCDBRIGHTLVL, 1, SysGetFlag(FL_LCD_BRIGHTNESS));
	}
	
	if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_EMRBarCtrl))
	{
		return NVTEVT_CONSUME;
	}
    UxButton_SetItemData(&UIFlowWndMovie_BTN_SetupCtrl, 0, BTNITM_ICONID,ICON_OPERATE_SETUP_F );

	return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_BTN_Setup_OnTouchPanelRelease(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    //TESTLOG("");
	if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_EMRBarCtrl))
	{
		return NVTEVT_CONSUME;
	}
        UxButton_SetItemData(&UIFlowWndMovie_BTN_SetupCtrl, 0, BTNITM_ICONID, ICON_OPERATE_SETUP);

	return NVTEVT_CONSUME;
}

#if 0
#endif
//---------------------UIFlowWndMovie_Panel_EMRBarCtrl Control List---------------------------
CTRL_LIST_BEGIN(UIFlowWndMovie_Panel_EMRBar)
CTRL_LIST_ITEM(UIFlowWndMovie_ProgressBar)
CTRL_LIST_END

//----------------------UIFlowWndMovie_Panel_EMRBarCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Panel_EMRBar)
EVENT_END

//----------------------UIFlowWndMovie_ProgressBarCtrl Event---------------------------
INT32 UIFlowWndMovie_ProgressBar_OnTouchPanelClick(VControl *, UINT32, UINT32 *);

EVENT_BEGIN(UIFlowWndMovie_ProgressBar)
EVENT_ITEM(NVTEVT_CLICK,UIFlowWndMovie_ProgressBar_OnTouchPanelClick)
EVENT_END


INT32 UIFlowWndMovie_ProgressBar_OnTouchPanelClick(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{

   // Ux_SendEvent(pCtrl,NVTEVT_NEXT_ITEM,0);
   	if ( UIFlowWndMovie_GetRecLockStatus() == TRUE) 
  	{
		CHKPNT;
		FocusUrgCount = 0;
		bFocusUrg = TRUE;
		UxCtrl_SetShow(&UIFlowWndMovie_ConfirmPanelCtrl, TRUE);
		UxCtrl_SetShow(& UIFlowWndMovie_StatusTxT_TitleCtrl, TRUE);
		UxCtrl_SetShow(&UIFlowWndMovie_Tab_YES_NOCtrl, TRUE);

 	}
    return NVTEVT_CONSUME;
}
//----------------------UIFlowWndMovie_Static_ENRTimeCtrl Event---------------------------

EVENT_BEGIN(UIFlowWndMovie_Static_ENRTime)
EVENT_END
//---------------------UIFlowWndMovie_ConfirmPanelCtrl Control List---------------------------
CTRL_LIST_BEGIN(UIFlowWndMovie_ConfirmPanel)
CTRL_LIST_ITEM(UIFlowWndMovie_StatusTxT_Title)
CTRL_LIST_ITEM(UIFlowWndMovie_Tab_YES_NO)
CTRL_LIST_END

//----------------------UIFlowWndMovie_ConfirmPanelCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_ConfirmPanel)
EVENT_END

//----------------------UIFlowWndMovie_StatusTxT_TitleCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_StatusTxT_Title)
EVENT_END

//----------------------UIFlowWndMovie_Tab_YES_NOCtrl Event---------------------------
INT32 UIFlowWndMovie_Tab_YES_NO_OnTouchPanelClick(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_Tab_YES_NO_OnTouchPanelPress(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_Tab_YES_NO_OnTouchPanelRelease(VControl *, UINT32, UINT32 *);
EVENT_BEGIN(UIFlowWndMovie_Tab_YES_NO)
EVENT_ITEM(NVTEVT_CLICK,UIFlowWndMovie_Tab_YES_NO_OnTouchPanelClick)
EVENT_ITEM(NVTEVT_PRESS,UIFlowWndMovie_Tab_YES_NO_OnTouchPanelPress)
EVENT_ITEM(NVTEVT_RELEASE,UIFlowWndMovie_Tab_YES_NO_OnTouchPanelRelease)
EVENT_END

INT32 UIFlowWndMovie_Tab_YES_NO_OnTouchPanelClick(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
   // Ux_SendEvent(pCtrl,NVTEVT_PREVIOUS_ITEM,0);
	
    return NVTEVT_PASS;
}
INT32 UIFlowWndMovie_Tab_YES_NO_OnTouchPanelPress(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
   // Ux_SendEvent(pCtrl,NVTEVT_NEXT_ITEM,0);
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_Tab_YES_NO_OnTouchPanelRelease(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    return NVTEVT_CONSUME;
}
//----------------------ButtonNoCtrl Event---------------------------
INT32 ButtonNo_OnTouchPanelClick(VControl *, UINT32, UINT32 *);

EVENT_BEGIN(ButtonNo)
EVENT_ITEM(NVTEVT_CLICK,ButtonNo_OnTouchPanelClick)

EVENT_END
INT32 ButtonNo_OnTouchPanelClick(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{

   // Ux_SendEvent(pCtrl,NVTEVT_PREVIOUS_ITEM,0);
	UxCtrl_SetShow(&UIFlowWndMovie_ConfirmPanelCtrl, FALSE);

    return NVTEVT_CONSUME;
}
//----------------------ButtonYesCtrl Event---------------------------
INT32 ButtonYes_OnTouchPanelClick(VControl *, UINT32, UINT32 *);

EVENT_BEGIN(ButtonYes)
EVENT_ITEM(NVTEVT_CLICK,ButtonYes_OnTouchPanelClick)

EVENT_END
INT32 ButtonYes_OnTouchPanelClick(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
   // Ux_SendEvent(pCtrl,NVTEVT_PREVIOUS_ITEM,0);
      			if (UIFlowWndMovie_GetRecLockStatus() == TRUE)
                       {
                            CHKPNT;
							UIFlowWndMovie_SetRecLockStatus(FALSE);
							if(isEnterParkingMode)
								isEnterParkingMode	= FALSE;
                            if (FlowMovie_GetDataState() == MOV_ST_REC)
                            {
                            //   Ux_PostEvent(NVTEVT_KEY_SHUTTER2, 3, NVTEVT_KEY_PRESS, 0, UIFlowWndMovie_Restart_Rec);//lyb
                                FlowMovie_StopRec();
								//isStopREC = TRUE;
                                FlowMovie_SetRecCurrTime(0);
								System_SetGsensorPwrOn(FALSE);
								System_SetParkPwroffTimeCount(-1);
								autoRec = FALSE;	
								
                            }
      			}
            		
		UxCtrl_SetShow(&UIFlowWndMovie_ProgressBarCtrl, FALSE);
		UxCtrl_SetShow(&UIFlowWndMovie_Static_ENRTimeCtrl, FALSE);

		UxCtrl_SetShow(&UIFlowWndMovie_Static_RecUrgTxtCtrl, FALSE);

		UxCtrl_SetShow(&UIFlowWndMovie_Panel_RecUrgCtrl, FALSE);
/*		
	if ( gMovData.State == MOV_ST_REC )
	{
				UxCtrl_SetShow(&UIFlowWndMovie_Static_RecTxtCtrl, TRUE);

	}else  {
		UxCtrl_SetShow(&UIFlowWndMovie_Static_RecTxtCtrl, FALSE);

	}
	//*/
	if (UIStorageCheck(STORAGE_CHECK_ERROR, NULL) == TRUE)
	{
		UxCtrl_SetShow(&UIFlowWndMovie_Static_RecTxtCtrl, FALSE);

	}
		
		UxCtrl_SetShow(&UIFlowWndMovie_Status_Movie_FCtrl, TRUE);
		UxCtrl_SetShow(&UIFlowWndMovie_Status_Movie_BCtrl, TRUE);
		UxCtrl_SetShow(&UIFlowWndMovie_Panel_TopNormalCtrl, TRUE);
		UxCtrl_SetShow(&UIFlowWndMovie_Panel_OperateCtrl, FALSE);
		    UxCtrl_SetShow(&UIFlowWndMovie_ConfirmPanelCtrl, FALSE);
			g_EmergencyRecSetp = 0;
            		g_EmergencyRecTime = 0;
		//AutoREC = FALSE;
    return NVTEVT_CONSUME;
}
//----------------------UIFlowWndMovie_Status_Alarm_LCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Status_Alarm_L)
EVENT_END

//----------------------UIFlowWndMovie_Status_Alarm_RCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_Status_Alarm_R)
EVENT_END

//---------------------UIFlowWndMovie_Panel_BehindBarCtrl Control List---------------------------
CTRL_LIST_BEGIN(UIFlowWndMovie_Panel_Behind)
//CTRL_LIST_ITEM(UIFlowWndMovie_BehindProgressBar)
CTRL_LIST_ITEM(UIFlowWndMovie_BTN_BehindUP)
CTRL_LIST_ITEM(UIFlowWndMovie_BTN_BehindDown)
CTRL_LIST_ITEM(UIFlowWndMovie_BehindStaticText)
CTRL_LIST_END

//----------------------UIFlowWndMovie_Panel_BehindBarCtrl Event---------------------------
INT32 UIFlowWndMovie_Panel_Behind_OnTouchPress(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_Panel_Behind_OnTouchRelease(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_Panel_Behind_OnTouchClick(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_Panel_Behind_OnRedraw(VControl *, UINT32, UINT32 *);

EVENT_BEGIN(UIFlowWndMovie_Panel_Behind)
//EVENT_ITEM(NVTEVT_USER_PRESS,UIFlowWndMovie_Panel_Behind_OnTouchPress)  //NVTEVT_USER_DOUBLECLICK
EVENT_ITEM(NVTEVT_USER_RELEASE,UIFlowWndMovie_Panel_Behind_OnTouchRelease) // NVTEVT_CLICK  NVTEVT_USER_DOUBLECLICK
EVENT_ITEM(NVTEVT_CLICK,UIFlowWndMovie_Panel_Behind_OnTouchClick) // NVTEVT_CLICK  NVTEVT_USER_DOUBLECLICK
EVENT_ITEM(NVTEVT_PRESS,UIFlowWndMovie_Panel_Behind_OnTouchPress) // NVTEVT_CLICK  NVTEVT_USER_DOUBLECLICK
EVENT_ITEM(NVTEVT_RELEASE,UIFlowWndMovie_Panel_Behind_OnTouchRelease) // NVTEVT_CLICK  NVTEVT_USER_DOUBLECLICK
EVENT_ITEM(NVTEVT_REDRAW,UIFlowWndMovie_Panel_Behind_OnRedraw)

EVENT_END


INT32 UIFlowWndMovie_Panel_Behind_OnTouchPress(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	CHKPNT;

    return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_Panel_Behind_OnRedraw(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
CHKPNT;
	URECT		DispCord = {0,0,OSD_W,OSD_H};
	//INT32 uiCurDispLineY = 0;
	static UINT32 uiCount = 0;
	CHAR string[32] = {0};
	//UINT32 i = 0;
	//UI_SetDisplayDirty(TRUE);
	ScreenObj = *paramArray;
	//static DC** ScreenObj;
	//UI_SetDisplayDirty(TRUE);
    //	ScreenObj = (DC**)UI_BeginScreen();
	uiCount ++;
	//DBGD(uiCount);	
	DispCord = gMovieOsdDispCord;	 
	//GxGfx_Clear(((DC**)ScreenObj)[GxGfx_OSD]);
	GxGfx_SetShapeStroke(LINEBRUSH_SQUARE|LINEWEIGHT(0), FILLSTYLE_FILL);
	GxGfx_SetShapeColor(CLRID_IDX_GREEN, CLRID_IDX_GREEN, NULL);	

	//Cur Option Line 
	//GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  0, (IMG_DISP_POS_4 + 1) * 24 - 1, 959, (IMG_DISP_POS_4 + 1) * 24 - 1);
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  -921, (IMG_DISP_POS_4 + 1) * 24 - 1, 189, (IMG_DISP_POS_4 + 1) * 24 - 1);	 
#if 0	//?	//Deviding Line // 9
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  479 - 22, 23, 479 + 22, 23);	
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  479 - 22, 47, 479 + 22, 47);
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  479 - 22, 71, 479 + 22, 71);	
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  479 - 22, 95, 479 + 22, 95);	
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  479 - 22, 119, 479 + 22, 119);
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  479 - 22, 143, 479 + 22, 143);
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  479 - 22, 167, 479 + 22, 167);
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  479 - 22, 191, 479 + 22, 191);
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  479 - 22, 215, 479 + 22, 215); // 457215481215
	
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  479,	0, 479, 23);	
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  479,	0, 479, 239);
	GxGfx_FillRect(((DC**)ScreenObj)[GxGfx_OSD],  479-25,  119-11, 479+25, 119+15);
	GxGfx_FillRect(((DC**)ScreenObj)[GxGfx_OSD],  479-25,  119-11, 479+25, 119+15);
#endif	
	//Deviding Line // 9
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  -369 - 22, 23, -369 + 22, 23);	
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  -369 - 22, 47, -369 + 22, 47);
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  -369 - 22, 71, -369 + 22, 71);	
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  -369 - 22, 95, -369 + 22, 95);	
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  -369 - 22, 119, -369 + 22, 119);
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  -369 - 22, 143, -369 + 22, 143);
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  -369 - 22, 167, -369 + 22, 167);
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  -369 - 22, 191, -369 + 22, 191);
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  -369 - 22, 215, -369 + 22, 215); // 457215481215


	//Half Line // 
	//GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  479,	0, 479, 23);	
	//GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  479,	0, 479, 239);
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  -369,	0, -369, 23);	
	GxGfx_Line(((DC**)ScreenObj)[GxGfx_OSD],  -369,	0, -369, 239);	
	//Rectangle in the middle
	//if(isIMG_Front == FALSE)
	GxGfx_FillRect(((DC**)ScreenObj)[GxGfx_OSD],  -369-25,  119-11, -369+25, 119+15);

//	GxGfx_FillRect(((DC**)ScreenObj)[GxGfx_OSD],  479-17,  119-7, 479+17, 119+7);

	//gDemoKit_Font  gDemo_SmallFont
	GxGfx_SetTextStroke((const FONT*)gDemoKit_Font , FONTSTYLE_NORMAL, SCALE_1X); //gDemo_SmallFont
	GxGfx_SetTextColor(CLRID_IDX_BLACK, CLRID_IDX_BLACK, CLRID_IDX_BLACK);


	if(SysGetFlag(FL_DUAL_CAM) == DUALCAM_FRONT)
	  {
		 switch(SysGetFlag(FL_SENSOR1_DISP_OFFSET))
		 {
		 #if 0
			 //case SEN_DISP_OFFSET_P3:
			//	  sprintf(string, " -36A");   
			//	break;
			 case SEN_DISP_OFFSET_P3:
				  sprintf(string, " -27A");   
				break;		  
			 case SEN_DISP_OFFSET_P2:
				  sprintf(string, " -18A");   
				break;		   
			 case SEN_DISP_OFFSET_P1:
				  sprintf(string, " -9A");	 
				break;		   
			 case SEN_DISP_OFFSET_0:
				  sprintf(string, "  0A");	  
				break;		   
			 case SEN_DISP_OFFSET_N1:
				  sprintf(string, "  9A");	  
				break;		   
			 case SEN_DISP_OFFSET_N2:
				  sprintf(string, "  18A");	  
				break;		   
			 case SEN_DISP_OFFSET_N3:
				  sprintf(string, "  27A");	  
				break;
			// case IMG_DISP_POS_0:
			//	  sprintf(string, "  36A");	  
			//	break;
	#endif
			case IMG_DISP_POS_8:
				 sprintf(string, "-20A");	
			   break;
			case IMG_DISP_POS_7:
				 sprintf(string, "-15A");	
			   break;		 
			case IMG_DISP_POS_6:
				 sprintf(string, "-10A");	
			   break;		  
			case IMG_DISP_POS_5:
				 sprintf(string, "-5A");   
			   break;		  
			case IMG_DISP_POS_4:
				 sprintf(string, " 0A");	
			   break;		  
			case IMG_DISP_POS_3:
				 sprintf(string, " 5A");	
			   break;		  
			case IMG_DISP_POS_2:
				 sprintf(string, " 10A");	
			   break;		  
			case IMG_DISP_POS_1:
				 sprintf(string, " 15A");	
			   break;
			case IMG_DISP_POS_0:
				 sprintf(string, " 20A");	
			   break;
		 }
	  }
	  else if(SysGetFlag(FL_DUAL_CAM) == DUALCAM_BEHIND)
	  {
		  switch(SysGetFlag(FL_IMGDISP_POS_STEP_ID1))
		  {
			  case IMG_DISP_POS_8:
				   sprintf(string, "-20A");   
				 break;
			  case IMG_DISP_POS_7:
				   sprintf(string, "-15A");   
				 break; 	   
			  case IMG_DISP_POS_6:
				   sprintf(string, "-10A");   
				 break; 		
			  case IMG_DISP_POS_5:
				   sprintf(string, "-5A");   
				 break; 		
			  case IMG_DISP_POS_4:
				   sprintf(string, " 0A");    
				 break; 		
			  case IMG_DISP_POS_3:
				   sprintf(string, " 5A");    
				 break; 		
			  case IMG_DISP_POS_2:
				   sprintf(string, " 10A");   
				 break; 		
			  case IMG_DISP_POS_1:
				   sprintf(string, " 15A");   
				 break;
			  case IMG_DISP_POS_0:
				   sprintf(string, " 20A");   
				 break;
		  
		  }
	  }
	  
	//UINT32  len = strlen(string);
	//string[len+1] =0xba;
	//if(isIMG_Front == FALSE)
	GxGfx_Text(((DC**)ScreenObj)[GxGfx_OSD],  -369-22, 115-5, string);
	//GxGfx_Text(((DC**)ScreenObj)[GxGfx_OSD],	479-22, 119-5, string);
   //UI_EndScreen((UINT32) ScreenObj);
	return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_Panel_Behind_OnTouchClick(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	CHKPNT;
 	debug_msg("%d %d \r\n",paramArray[0],paramArray[1]);
 	
	if (paramArray[0] >284  && paramArray[0] < 1028 )
	{
		CHKPNT;
		return NVTEVT_PASS;
	}
	if(SysGetFlag(FL_DUAL_CAM) == DUALCAM_FRONT  )
	{
		return NVTEVT_CONSUME;
	}
	if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_BehindCtrl))
	{
		HideBehindBar();
	}else{
		   UxProgressBar_SetData(&UIFlowWndMovie_BehindProgressBarCtrl,PROBAR_CURSTP,SysGetFlag(FL_IMGDISP_POS_STEP_ID1)*CurStepPosBehind ); //iCur_BL_Value_Bar
		   UxProgressBar_SetData(&UIFlowWndMovie_BehindProgressBarCtrl,PROBAR_TOTSTP,400); //99
		   DrawBehindBar();
	}
    return NVTEVT_CONSUME;
}


INT32 UIFlowWndMovie_Panel_Behind_OnTouchRelease(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	//CHKPNT;
    return NVTEVT_CONSUME;
}
//----------------------UIFlowWndMovie_BehindProgressBarCtrl Event---------------------------
INT32 UIFlowWndMovie_BehindProgressBar_OnTouchPanelClick(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_BehindProgressBar_OnTouchPress(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_BehindProgressBar_OnTouchRelease(VControl *, UINT32, UINT32 *);

EVENT_BEGIN(UIFlowWndMovie_BehindProgressBar)
EVENT_ITEM(NVTEVT_PRESS,UIFlowWndMovie_BehindProgressBar_OnTouchPress) // NVTEVT_DOUBLECLICK
EVENT_ITEM(NVTEVT_RELEASE,UIFlowWndMovie_BehindProgressBar_OnTouchRelease) // NVTEVT_DOUBLECLICK
EVENT_ITEM(NVTEVT_CLICK,UIFlowWndMovie_BehindProgressBar_OnTouchPanelClick)
EVENT_END
UINT32 SlideUpStep = 40;  
UINT32 SlideUpCount = 0;

INT32 UIFlowWndMovie_BehindProgressBar_OnTouchPress(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	CHKPNT;
	return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_BehindProgressBar_OnTouchRelease(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	CHKPNT;
	return NVTEVT_CONSUME;
}


INT32 UIFlowWndMovie_BehindProgressBar_OnTouchPanelClick(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
 	CHKPNT;	
	if (paramArray[0] >123  && paramArray[0] < 217 )
	{
		CHKPNT;
	
		if (paramArray[1] >52  && paramArray[1] < 302)
		{	
			CHKPNT;
			if(SysGetFlag(FL_DUAL_CAM) == DUALCAM_FRONT  )
			{
				return NVTEVT_CONSUME;
			}
			if (UxCtrl_IsShow(&UIFlowWndMovie_Panel_BehindCtrl))
			{
				HideBehindBar();
			}else{
				UxProgressBar_SetData(&UIFlowWndMovie_BehindProgressBarCtrl,PROBAR_CURSTP,SysGetFlag(FL_IMGDISP_POS_STEP_ID1)*CurStepPosBehind); //iCur_BL_Value_Bar
				UxProgressBar_SetData(&UIFlowWndMovie_BehindProgressBarCtrl,PROBAR_TOTSTP,400); //99
				DrawBehindBar();
			}

		}
      }
    return NVTEVT_CONSUME;
}
//----------------------UIFlowWndMovie_BTN_BehindUPCtrl Event---------------------------
INT32 UIFlowWndMovie_BTN_BehindUP_OnTouchPanelClick(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_BTN_BehindUP_OnTouchPanelPress(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_BTN_BehindUP_OnTouchPanelRelease(VControl *, UINT32, UINT32 *);


EVENT_BEGIN(UIFlowWndMovie_BTN_BehindUP)
EVENT_ITEM(NVTEVT_CLICK,UIFlowWndMovie_BTN_BehindUP_OnTouchPanelClick)
EVENT_ITEM(NVTEVT_PRESS,UIFlowWndMovie_BTN_BehindUP_OnTouchPanelPress)
EVENT_ITEM(NVTEVT_USER_RELEASE,UIFlowWndMovie_BTN_BehindUP_OnTouchPanelRelease)
EVENT_ITEM(NVTEVT_USER_PRESS,UIFlowWndMovie_BTN_BehindUP_OnTouchPanelPress)

EVENT_END


INT32 UIFlowWndMovie_BTN_BehindUP_OnTouchPanelClick(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	//CHKPNT;
 if ( ((EthCamNet_GetEthLinkStatus(0) == ETHCAM_LINK_UP) &&  bflag_EthLinkFinish) || isIMG_Front == TRUE ){

#if 0
	SlideUpCount ++;
		SlideOffsetInfo.curDispOffset = SlideUpStep * SlideUpCount;
				//SlideOffsetInfo.curFlDualCAM = SysGetFlag(FL_DUAL_CAM);
			//			debug_msg("--OnTouchSlideUp cj offset: %d %d",SlideOffsetInfo.curDispOffset, SlideOffsetInfo.curFlDualCAM);

		if (CurStepPosBehind > 0 )
		{
		//CHKPNT;
			CurStepPosBehind = CurStepPosBehind -SlideUpStep; 
				
		}else if ( CurStepPosBehind == 0 || CurStepPosBehind < 0  )
		{
		//CHKPNT;
			CurStepPosBehind = 0;
		}
#endif
	if(isIMG_Front == FALSE){
		UINT32 Data = SysGetFlag(FL_IMGDISP_POS_STEP_ID1);
		
		if(Data > IMG_DISP_POS_0)
		{
			   Data -- ;
			   SysSetFlag(FL_IMGDISP_POS_STEP_ID1, Data);
		}else if ( Data == IMG_DISP_POS_0)
		{
			SysSetFlag(FL_IMGDISP_POS_STEP_ID1, Data);

		}
		//debug_msg("\r\n Data:%d \r\n",Data);
#if (IMG_FULL_DISP == ENABLE)
		MovieExe_EthCamSetISECrop(_CFG_ETHCAM_ID_1);
#endif
			FoucusBhindPanelCount =0;
		//	Fun_UpdateBehindString();
		}else if(isIMG_Front == TRUE){
		
		UINT32 F_Data = SysGetFlag(FL_SENSOR1_DISP_OFFSET);
		//debug_msg("\r\n F_Data:%d \r\n",F_Data);
		if(F_Data > IMG_DISP_POS_0)
		{
			F_Data -- ;
			SysSetFlag(FL_SENSOR1_DISP_OFFSET, F_Data);
		}else if ( F_Data == IMG_DISP_POS_0)
		{
			SysSetFlag(FL_SENSOR1_DISP_OFFSET, F_Data);
		}
		
		//debug_msg("\r\n F_Data:%d \r\n",F_Data);
#if (IMG_FULL_DISP == ENABLE)
			MovieExe_SetIMECrop(_CFG_REC_ID_1);
#endif
			FoucusBhindPanelCount =0;
		//	Fun_UpdateBehindString();
	}
		WndMovie_Delay_SaveMenuCnt = 1;
		//UxProgressBar_SetData(&UIFlowWndMovie_BehindProgressBarCtrl,PROBAR_CURSTP,SysGetFlag(FL_IMGDISP_POS_STEP_ID1)*CurStepPosBehind ); //iCur_BL_Value_Bar
	   //UxProgressBar_SetData(&UIFlowWndMovie_BehindProgressBarCtrl,PROBAR_TOTSTP,400); //99
		//debug_msg("--OnTouchSlideUp cj offset:    %d",CurStepPosBehind);//SlideOffsetInfo.curDispOffset,  %d
		//BKG_PostEvent(NVTEVT_BKW_ETHCAM_SET_TX_SLIDEUP);
	}else{
		HideBehindBar();
		CloseTimer();
		Ux_OpenWindow(&UIFlowWndWaitMomentCtrl, 1, UIFlowWndWaitMoment_StatusTXT_Msg_STRID_ETHCAM_DETFAIL);
	}
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_BTN_BehindUP_OnTouchPanelRelease(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_BTN_BehindUP_OnTouchPanelPress(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    return NVTEVT_CONSUME;
}


//----------------------UIFlowWndMovie_BTN_BehindDownCtrl Event---------------------------
INT32 UIFlowWndMovie_BTN_BehindDown_OnTouchPanelClick(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_BTN_BehindDown_OnTouchPanelPress(VControl *, UINT32, UINT32 *);
INT32 UIFlowWndMovie_BTN_BehindDown_OnTouchPanelRelease(VControl *, UINT32, UINT32 *);


EVENT_BEGIN(UIFlowWndMovie_BTN_BehindDown)
EVENT_ITEM(NVTEVT_CLICK,UIFlowWndMovie_BTN_BehindDown_OnTouchPanelClick)
EVENT_ITEM(NVTEVT_PRESS,UIFlowWndMovie_BTN_BehindDown_OnTouchPanelPress)
EVENT_ITEM(NVTEVT_USER_RELEASE,UIFlowWndMovie_BTN_BehindDown_OnTouchPanelRelease)
EVENT_ITEM(NVTEVT_USER_PRESS,UIFlowWndMovie_BTN_BehindDown_OnTouchPanelPress)

EVENT_END

UINT32 SlideDownCount = 0;
INT32 UIFlowWndMovie_BTN_BehindDown_OnTouchPanelClick(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
CHKPNT;
 	if ( ((EthCamNet_GetEthLinkStatus(0) == ETHCAM_LINK_UP) &&  bflag_EthLinkFinish)  || isIMG_Front == TRUE )
	{
		#if 0
		if (SlideDownCount =0)
		{
			SlideOffsetInfo.curDispOffset =0;
		}   
		SlideDownCount ++;
		SlideOffsetInfo.curDispOffset = SlideUpStep *SlideDownCount;
		
		if ((CurStepPosBehind > 0 || CurStepPosBehind == 0 ) &&   (CurStepPosBehind < 400) )
		{
			CurStepPosBehind = CurStepPosBehind +SlideUpStep; 
				
		}else if ( CurStepPosBehind == 400 ||  CurStepPosBehind >400 )
		{
			CurStepPosBehind = 400;
		}
		#endif 
		if(isIMG_Front == FALSE){
			//debug_msg("--OnTouchSlideDown cj CurPosBehind:   %d", CurPosBehind);//SlideOffsetInfo.curDispOffset,
			UINT32 Data = SysGetFlag(FL_IMGDISP_POS_STEP_ID1);
			if(Data < IMG_DISP_POS_8)
			{
				   Data ++ ;
				   SysSetFlag(FL_IMGDISP_POS_STEP_ID1, Data);
			}else if ( Data == IMG_DISP_POS_8 )
			{
				SysSetFlag(FL_IMGDISP_POS_STEP_ID1, Data);

			}
			debug_msg("\r\n Data:%d \r\n",Data);
			#if (IMG_FULL_DISP == ENABLE)
			MovieExe_EthCamSetISECrop(_CFG_ETHCAM_ID_1);
			#endif
			FoucusBhindPanelCount = 0;
			//	Fun_UpdateBehindString();
		}
		else if(isIMG_Front == TRUE){
			UINT32 F_Data = SysGetFlag(FL_SENSOR1_DISP_OFFSET);
			debug_msg("\r\n F_Data:%d \r\n",F_Data);
			if(F_Data < IMG_DISP_POS_8)
			{
			   F_Data ++ ;
			   SysSetFlag(FL_SENSOR1_DISP_OFFSET, F_Data);
			}else if ( F_Data == IMG_DISP_POS_8 )
			{
				SysSetFlag(FL_SENSOR1_DISP_OFFSET, F_Data);
			
			}
			debug_msg("\r\n F_Data:%d \r\n",F_Data);
#if (IMG_FULL_DISP == ENABLE)
			MovieExe_SetIMECrop(_CFG_REC_ID_1);
#endif
			FoucusBhindPanelCount = 0;
			//	Fun_UpdateBehindString();
		}
		WndMovie_Delay_SaveMenuCnt = 1;
		UxProgressBar_SetData(&UIFlowWndMovie_BehindProgressBarCtrl,PROBAR_CURSTP,SysGetFlag(FL_IMGDISP_POS_STEP_ID1)*CurStepPosBehind ); //iCur_BL_Value_Bar
	    UxProgressBar_SetData(&UIFlowWndMovie_BehindProgressBarCtrl,PROBAR_TOTSTP,400); //99
			  
		//BKG_PostEvent(NVTEVT_BKW_ETHCAM_SET_TX_SLIDEDOWN);
	}else{
		HideBehindBar();
		CloseTimer();
		Ux_OpenWindow(&UIFlowWndWaitMomentCtrl, 1, UIFlowWndWaitMoment_StatusTXT_Msg_STRID_ETHCAM_DETFAIL);
 	}
    return NVTEVT_CONSUME;
}
INT32 UIFlowWndMovie_BTN_BehindDown_OnTouchPanelRelease(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{

    return NVTEVT_CONSUME;
}

INT32 UIFlowWndMovie_BTN_BehindDown_OnTouchPanelPress(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{

    return NVTEVT_CONSUME;
}

//----------------------UIFlowWndMovie_BehindStaticTextCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_BehindStaticText)
EVENT_END
//----------------------UIFlowWndMovie_LCDStaticCtrl Event---------------------------
EVENT_BEGIN(UIFlowWndMovie_LCDStatic)
EVENT_END
